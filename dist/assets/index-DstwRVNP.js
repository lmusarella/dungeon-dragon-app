(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function le(n,e="info"){const t=document.createElement("div");t.className=`toast toast-${e}`,t.textContent=n;const r=document.querySelector("[data-toast-container]");r&&(r.appendChild(t),setTimeout(()=>t.classList.add("visible"),20),setTimeout(()=>{t.classList.remove("visible"),t.addEventListener("transitionend",()=>t.remove())},3200))}function mi(n){const e=document.querySelector("[data-drawer]"),t=document.querySelector("[data-drawer-body]");!e||!t||(t.innerHTML="",t.appendChild(n),e.classList.add("open"))}function ta(){const n=document.querySelector("[data-drawer]");n&&n.classList.remove("open")}function Fs(n,e,t=[]){const r=document.createElement("div");r.className="drawer-content";const i=document.createElement("h2");if(i.textContent=n,r.appendChild(i),r.appendChild(e),t.length){const o=document.createElement("div");o.className="drawer-actions",t.forEach(l=>o.appendChild(l)),r.appendChild(o)}return r}function rn(n,e){const t=document.createElement("select");return n.forEach(r=>{const i=document.createElement("option");i.value=r.value,i.textContent=r.label,r.value===e&&(i.selected=!0),t.appendChild(i)}),t}function ie({label:n,name:e,type:t="text",value:r="",placeholder:i=""}){const o=document.createElement("label");o.className="field";const l=document.createElement("span");l.textContent=n;const d=document.createElement("input");return d.type=t,d.name=e,d.value=r,d.placeholder=i,o.appendChild(l),o.appendChild(d),o}function vn({label:n,name:e,value:t="",placeholder:r=""}){const i=document.createElement("label");i.className="field";const o=document.createElement("span");o.textContent=n;const l=document.createElement("textarea");return l.name=e,l.value=t,l.placeholder=r,i.appendChild(o),i.appendChild(l),i}function ca({title:n="Conferma",message:e,confirmLabel:t="Conferma",cancelLabel:r="Annulla"}={}){return new Promise(i=>{const o=document.querySelector("[data-confirm-modal]");if(!o){i(!1);return}const l=o.querySelector("[data-confirm-title]"),d=o.querySelector("[data-confirm-message]"),f=o.querySelector("[data-confirm-ok]"),m=o.querySelector("[data-confirm-cancel]"),v=o.querySelector("[data-confirm-overlay]");l&&(l.textContent=n),d&&(d.textContent=e||""),f&&(f.textContent=t),m&&(m.textContent=r),o.hidden=!1,o.classList.add("open");const y=w=>{o.classList.remove("open"),o.hidden=!0,f==null||f.removeEventListener("click",_),m==null||m.removeEventListener("click",C),v==null||v.removeEventListener("click",C),i(w)},_=()=>y(!0),C=()=>y(!1);f==null||f.addEventListener("click",_),m==null||m.addEventListener("click",C),v==null||v.addEventListener("click",C)})}function cn({title:n="Inserisci dati",content:e="",submitLabel:t="Conferma",cancelLabel:r="Annulla",cardClass:i=""}={}){return new Promise(o=>{var D;const l=document.querySelector("[data-form-modal]");if(!l){o(null);return}const d=l.querySelector(".modal-card"),f=l.querySelector("[data-form-title]"),m=l.querySelector("[data-form-body]"),v=l.querySelector("[data-form-fields]"),y=l.querySelector("[data-form-submit]"),_=l.querySelector("[data-form-cancel]"),C=l.querySelector("[data-form-overlay]"),w=((D=l.dataset.formCardClasses)==null?void 0:D.split(" ").filter(Boolean))??[];d&&w.length&&w.forEach(B=>d.classList.remove(B));const N=Array.isArray(i)?i:i?[i]:[];d&&N.length&&N.forEach(B=>d.classList.add(B)),l.dataset.formCardClasses=N.join(" "),f&&(f.textContent=n),y&&(y.textContent=t),_&&(r===null?_.hidden=!0:(_.hidden=!1,_.textContent=r)),v&&(v.innerHTML="",typeof e=="string"?v.innerHTML=e:e&&v.appendChild(e),v.querySelectorAll("p").forEach(B=>B.classList.add("eyebrow"))),l.hidden=!1,l.classList.add("open");const I=B=>{l.classList.remove("open"),l.hidden=!0,d&&l.dataset.formCardClasses&&(l.dataset.formCardClasses.split(" ").filter(Boolean).forEach(K=>d.classList.remove(K)),l.dataset.formCardClasses=""),m==null||m.removeEventListener("submit",O),_==null||_.removeEventListener("click",U),C==null||C.removeEventListener("click",U),o(B)},O=B=>{B.preventDefault();const K=m?new FormData(m):null;I(K)},U=()=>I(null);m==null||m.addEventListener("submit",O),_==null||_.addEventListener("click",U),C==null||C.addEventListener("click",U)})}const ir=new Set,ns="dd_active_character",Tt={user:null,profile:null,characters:[],activeCharacterId:null,offline:!1,cache:{items:[],resources:[],journal:[],wallet:null,tags:[]}};function Ks(n){return n?`${ns}:${n}`:ns}function Yo(n){return typeof localStorage>"u"?null:localStorage.getItem(Ks(n))}function Qo(n,e){if(typeof localStorage>"u")return;const t=Ks(n);e?localStorage.setItem(t,e):localStorage.removeItem(t)}function kt(){return Tt}function zt(n){Object.assign(Tt,n),ir.forEach(e=>e(Tt))}function Xo(n){return ir.add(n),()=>ir.delete(n)}function ua(n){var e;Tt.activeCharacterId=n??null,Qo((e=Tt.user)==null?void 0:e.id,Tt.activeCharacterId),ir.forEach(t=>t(Tt))}function Zo(){Tt.user=null,Tt.profile=null,Tt.characters=[],Tt.activeCharacterId=null,Tt.cache={items:[],resources:[],journal:[],wallet:null,tags:[]},ir.forEach(n=>n(Tt))}function jt(n,e){Tt.cache[n]=e,ir.forEach(t=>t(Tt))}function el(n){n.innerHTML=`
    <div class="app-shell">
      <header class="app-header">
        <div class="app-header-left">
          <div class="app-logo" aria-hidden="true">DD</div>
          <div>
            <h1>Dungeon Dragon</h1>
            <p class="app-subtitle">Gestione personaggi D&D</p>
          </div>
        </div>
        <div class="app-header-right">
          <div class="header-meta" data-header-meta>
            <div class="header-meta-item" data-user-row>
              <div class="header-avatar" data-user-avatar></div>
              <div class="header-meta-text">
                <span class="header-meta-label">Utente</span>
                <strong data-user-name></strong>
              </div>
            </div>
            <div class="header-meta-item" data-character-row>
              <div class="header-avatar" data-character-avatar></div>
              <div class="header-meta-text">
                <span class="header-meta-label">Personaggio</span>
                <strong data-character-name></strong>
              </div>
            </div>
          </div>
          <button class="menu-button" type="button" data-menu-button aria-label="Apri menu">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </div>
      </header>
      <div class="offline-banner" data-offline-banner hidden>
        Offline (solo lettura)
      </div>
      <main class="app-main" data-route-outlet></main>
      <div class="actions-fab" data-actions-fab>
        <div class="actions-fab-menu" data-actions-menu>
          <button class="actions-fab-item" type="button" data-hp-action="heal">Cura</button>
          <button class="actions-fab-item" type="button" data-hp-action="damage">Danno</button>
          <button class="actions-fab-item" type="button" data-rest="short_rest">Riposo Breve</button>
          <button class="actions-fab-item" type="button" data-rest="long_rest">Riposo Lungo</button>
          <button class="actions-fab-item" type="button" data-open-dice="roller">Lancia Dadi</button>
        </div>
        <button class="actions-fab-toggle" type="button" data-actions-toggle aria-expanded="false">
          Azioni
        </button>
      </div>
      <nav class="bottom-nav" data-bottom-nav>
        <a href="#/home" data-tab="home">Scheda Personaggio</a>
        <a href="#/inventory" data-tab="inventory">Inventario</a>
        <a href="#/journal" data-tab="journal">Diario</a>
      </nav>
      <div class="drawer" data-drawer>
        <div class="drawer-overlay" data-drawer-close></div>
        <div class="drawer-panel">
          <button class="drawer-close" data-drawer-close>Chiudi</button>
          <div data-drawer-body></div>
        </div>
      </div>
      <div class="modal" data-confirm-modal hidden>
        <div class="modal-overlay" data-confirm-overlay></div>
        <div class="modal-card" role="dialog" aria-modal="true">
          <h3 class="eyebrow" data-confirm-title>Conferma</h3>
          <p class="eyebrow" data-confirm-message></p>
          <div class="modal-actions">
            <button class="ghost-button" data-confirm-cancel>Annulla</button>
            <button class="primary" data-confirm-ok>Conferma</button>
          </div>
        </div>
      </div>
      <div class="modal" data-form-modal hidden>
        <div class="modal-overlay" data-form-overlay></div>
        <div class="modal-card" role="dialog" aria-modal="true">
          <h3 class="eyebrow" data-form-title>Inserisci dati</h3>
          <form data-form-body>
            <div data-form-fields></div>
            <div class="modal-actions">
              <button class="ghost-button" type="button" data-form-cancel>Annulla</button>
              <button class="primary" type="submit" data-form-submit>Conferma</button>
            </div>
          </form>
        </div>
      </div>
      <div class="toast-container" data-toast-container></div>
    </div>
  `,n.querySelectorAll("[data-drawer-close]").forEach(i=>i.addEventListener("click",ta));const e=n.querySelector("[data-menu-button]");e&&e.addEventListener("click",()=>{mi(rl())});const t=n.querySelector("[data-actions-fab]"),r=n.querySelector("[data-actions-toggle]");t&&r&&r.addEventListener("click",i=>{i.stopPropagation(),t.classList.toggle("is-open"),r.setAttribute("aria-expanded",t.classList.contains("is-open"))}),n.addEventListener("click",i=>{i.target.closest("[data-drawer-close]")&&ta(),t&&t.classList.contains("is-open")&&(i.target.closest("[data-actions-fab]")||(t.classList.remove("is-open"),r==null||r.setAttribute("aria-expanded","false")))})}function tl(n){document.querySelectorAll("[data-bottom-nav] a").forEach(e=>{const t=e.getAttribute("href")===`#/${n}`;e.classList.toggle("active",t)})}function nl(){const n=document.querySelector("[data-offline-banner]");if(!n)return;const{offline:e}=kt();n.hidden=!e}function zs(){var C,w,N;const n=document.querySelector("[data-header-meta]"),e=document.querySelector("[data-menu-button]");if(!n)return;const{user:t,characters:r,activeCharacterId:i}=kt(),o=r.find(I=>I.id===i),l=n.querySelector("[data-user-row]"),d=n.querySelector("[data-character-row]"),f=n.querySelector("[data-user-name]"),m=n.querySelector("[data-character-name]"),v=n.querySelector("[data-user-avatar]"),y=n.querySelector("[data-character-avatar]"),_=((C=t==null?void 0:t.user_metadata)==null?void 0:C.display_name)||(t==null?void 0:t.email)||"Utente";l&&(l.hidden=!t),f&&(f.textContent=t?_:""),v&&rs(v,_,(w=t==null?void 0:t.user_metadata)==null?void 0:w.avatar_url),d&&(d.hidden=!o),m&&(m.textContent=(o==null?void 0:o.name)??""),y&&rs(y,o==null?void 0:o.name,(N=o==null?void 0:o.data)==null?void 0:N.avatar_url),n.hidden=!t,e&&(e.hidden=!t)}function rl(){const n=document.createElement("div");return n.className="menu-list",n.innerHTML=`
    <h2>Menu</h2>
    <a class="menu-item" href="#/characters" data-drawer-close>Seleziona personaggi</a>
    <button class="menu-item menu-item--danger" type="button" data-logout data-drawer-close>Logout</button>
  `,n}function rs(n,e,t){if(n.innerHTML="",t){const o=document.createElement("img");o.src=t,o.alt=e?`Avatar di ${e}`:"Avatar",n.appendChild(o);return}const r=al(e),i=document.createElement("span");i.textContent=r,n.appendChild(i)}function al(n=""){const e=n.split(" ").filter(Boolean);return e.length?e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]}${e[1][0]}`.toUpperCase():"??"}const Za=new Map;function Cr(n,e){Za.set(n,e)}function il(n){window.location.hash=`#/${n}`}function sl(){window.addEventListener("hashchange",()=>as()),as()}function as(){const n=document.querySelector("[data-route-outlet]");if(!n)return;const e=window.location.hash.replace("#/","")||"home",{user:t}=kt();if(!t&&e!=="login"){window.location.hash="#/login";return}if(t&&e==="login"){window.location.hash="#/home";return}const r=Za.get(e)||Za.get("home");n.innerHTML="",tl(e);const i=document.querySelector("[data-bottom-nav]"),o=document.querySelector("[data-actions-fab]"),l=e==="login"||e==="characters",d=e==="home";i&&(i.hidden=l),o&&(o.hidden=!d,o.classList.remove("is-open")),r==null||r(n)}function da(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(n);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(n,r[i])&&(t[r[i]]=n[r[i]]);return t}function ol(n,e,t,r){function i(o){return o instanceof t?o:new t(function(l){l(o)})}return new(t||(t=Promise))(function(o,l){function d(v){try{m(r.next(v))}catch(y){l(y)}}function f(v){try{m(r.throw(v))}catch(y){l(y)}}function m(v){v.done?o(v.value):i(v.value).then(d,f)}m((r=r.apply(n,e||[])).next())})}const ll=n=>n?(...e)=>n(...e):(...e)=>fetch(...e);class gi extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class cl extends gi{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class is extends gi{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class ss extends gi{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var ei;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(ei||(ei={}));class ul{constructor(e,{headers:t={},customFetch:r,region:i=ei.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=ll(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return ol(this,arguments,void 0,function*(t,r={}){var i;let o,l;try{const{headers:d,method:f,body:m,signal:v,timeout:y}=r;let _={},{region:C}=r;C||(C=this.region);const w=new URL(`${this.url}/${t}`);C&&C!=="any"&&(_["x-region"]=C,w.searchParams.set("forceFunctionRegion",C));let N;m&&(d&&!Object.prototype.hasOwnProperty.call(d,"Content-Type")||!d)?typeof Blob<"u"&&m instanceof Blob||m instanceof ArrayBuffer?(_["Content-Type"]="application/octet-stream",N=m):typeof m=="string"?(_["Content-Type"]="text/plain",N=m):typeof FormData<"u"&&m instanceof FormData?N=m:(_["Content-Type"]="application/json",N=JSON.stringify(m)):m&&typeof m!="string"&&!(typeof Blob<"u"&&m instanceof Blob)&&!(m instanceof ArrayBuffer)&&!(typeof FormData<"u"&&m instanceof FormData)?N=JSON.stringify(m):N=m;let I=v;y&&(l=new AbortController,o=setTimeout(()=>l.abort(),y),v?(I=l.signal,v.addEventListener("abort",()=>l.abort())):I=l.signal);const O=yield this.fetch(w.toString(),{method:f||"POST",headers:Object.assign(Object.assign(Object.assign({},_),this.headers),d),body:N,signal:I}).catch(K=>{throw new cl(K)}),U=O.headers.get("x-relay-error");if(U&&U==="true")throw new is(O);if(!O.ok)throw new ss(O);let D=((i=O.headers.get("Content-Type"))!==null&&i!==void 0?i:"text/plain").split(";")[0].trim(),B;return D==="application/json"?B=yield O.json():D==="application/octet-stream"||D==="application/pdf"?B=yield O.blob():D==="text/event-stream"?B=O:D==="multipart/form-data"?B=yield O.formData():B=yield O.text(),{data:B,error:null,response:O}}catch(d){return{data:null,error:d,response:d instanceof ss||d instanceof is?d.context:void 0}}finally{o&&clearTimeout(o)}})}}var dl=class extends Error{constructor(n){super(n.message),this.name="PostgrestError",this.details=n.details,this.hint=n.hint,this.code=n.code}},hl=class{constructor(n){var e,t;this.shouldThrowOnError=!1,this.method=n.method,this.url=n.url,this.headers=new Headers(n.headers),this.schema=n.schema,this.body=n.body,this.shouldThrowOnError=(e=n.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=n.signal,this.isMaybeSingle=(t=n.isMaybeSingle)!==null&&t!==void 0?t:!1,n.fetch?this.fetch=n.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(n,e){return this.headers=new Headers(this.headers),this.headers.set(n,e),this}then(n,e){var t=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const r=this.fetch;let i=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async o=>{let l=null,d=null,f=null,m=o.status,v=o.statusText;if(o.ok){var y,_;if(t.method!=="HEAD"){var C;const O=await o.text();O===""||(t.headers.get("Accept")==="text/csv"||t.headers.get("Accept")&&(!((C=t.headers.get("Accept"))===null||C===void 0)&&C.includes("application/vnd.pgrst.plan+text"))?d=O:d=JSON.parse(O))}const N=(y=t.headers.get("Prefer"))===null||y===void 0?void 0:y.match(/count=(exact|planned|estimated)/),I=(_=o.headers.get("content-range"))===null||_===void 0?void 0:_.split("/");N&&I&&I.length>1&&(f=parseInt(I[1])),t.isMaybeSingle&&t.method==="GET"&&Array.isArray(d)&&(d.length>1?(l={code:"PGRST116",details:`Results contain ${d.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},d=null,f=null,m=406,v="Not Acceptable"):d.length===1?d=d[0]:d=null)}else{var w;const N=await o.text();try{l=JSON.parse(N),Array.isArray(l)&&o.status===404&&(d=[],l=null,m=200,v="OK")}catch{o.status===404&&N===""?(m=204,v="No Content"):l={message:N}}if(l&&t.isMaybeSingle&&(!(l==null||(w=l.details)===null||w===void 0)&&w.includes("0 rows"))&&(l=null,m=200,v="OK"),l&&t.shouldThrowOnError)throw new dl(l)}return{error:l,data:d,count:f,status:m,statusText:v}});return this.shouldThrowOnError||(i=i.catch(o=>{var l;let d="";const f=o==null?void 0:o.cause;if(f){var m,v,y,_;const w=(m=f==null?void 0:f.message)!==null&&m!==void 0?m:"",N=(v=f==null?void 0:f.code)!==null&&v!==void 0?v:"";d=`${(y=o==null?void 0:o.name)!==null&&y!==void 0?y:"FetchError"}: ${o==null?void 0:o.message}`,d+=`

Caused by: ${(_=f==null?void 0:f.name)!==null&&_!==void 0?_:"Error"}: ${w}`,N&&(d+=` (${N})`),f!=null&&f.stack&&(d+=`
${f.stack}`)}else{var C;d=(C=o==null?void 0:o.stack)!==null&&C!==void 0?C:""}return{error:{message:`${(l=o==null?void 0:o.name)!==null&&l!==void 0?l:"FetchError"}: ${o==null?void 0:o.message}`,details:d,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),i.then(n,e)}returns(){return this}overrideTypes(){return this}},fl=class extends hl{select(n){let e=!1;const t=(n??"*").split("").map(r=>/\s/.test(r)&&!e?"":(r==='"'&&(e=!e),r)).join("");return this.url.searchParams.set("select",t),this.headers.append("Prefer","return=representation"),this}order(n,{ascending:e=!0,nullsFirst:t,foreignTable:r,referencedTable:i=r}={}){const o=i?`${i}.order`:"order",l=this.url.searchParams.get(o);return this.url.searchParams.set(o,`${l?`${l},`:""}${n}.${e?"asc":"desc"}${t===void 0?"":t?".nullsfirst":".nullslast"}`),this}limit(n,{foreignTable:e,referencedTable:t=e}={}){const r=typeof t>"u"?"limit":`${t}.limit`;return this.url.searchParams.set(r,`${n}`),this}range(n,e,{foreignTable:t,referencedTable:r=t}={}){const i=typeof r>"u"?"offset":`${r}.offset`,o=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(i,`${n}`),this.url.searchParams.set(o,`${e-n+1}`),this}abortSignal(n){return this.signal=n,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:n=!1,verbose:e=!1,settings:t=!1,buffers:r=!1,wal:i=!1,format:o="text"}={}){var l;const d=[n?"analyze":null,e?"verbose":null,t?"settings":null,r?"buffers":null,i?"wal":null].filter(Boolean).join("|"),f=(l=this.headers.get("Accept"))!==null&&l!==void 0?l:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${o}; for="${f}"; options=${d};`),o==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(n){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${n}`),this}};const os=new RegExp("[,()]");var Zn=class extends fl{eq(n,e){return this.url.searchParams.append(n,`eq.${e}`),this}neq(n,e){return this.url.searchParams.append(n,`neq.${e}`),this}gt(n,e){return this.url.searchParams.append(n,`gt.${e}`),this}gte(n,e){return this.url.searchParams.append(n,`gte.${e}`),this}lt(n,e){return this.url.searchParams.append(n,`lt.${e}`),this}lte(n,e){return this.url.searchParams.append(n,`lte.${e}`),this}like(n,e){return this.url.searchParams.append(n,`like.${e}`),this}likeAllOf(n,e){return this.url.searchParams.append(n,`like(all).{${e.join(",")}}`),this}likeAnyOf(n,e){return this.url.searchParams.append(n,`like(any).{${e.join(",")}}`),this}ilike(n,e){return this.url.searchParams.append(n,`ilike.${e}`),this}ilikeAllOf(n,e){return this.url.searchParams.append(n,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(n,e){return this.url.searchParams.append(n,`ilike(any).{${e.join(",")}}`),this}regexMatch(n,e){return this.url.searchParams.append(n,`match.${e}`),this}regexIMatch(n,e){return this.url.searchParams.append(n,`imatch.${e}`),this}is(n,e){return this.url.searchParams.append(n,`is.${e}`),this}isDistinct(n,e){return this.url.searchParams.append(n,`isdistinct.${e}`),this}in(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&os.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`in.(${t})`),this}notIn(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&os.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`not.in.(${t})`),this}contains(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cs.{${e.join(",")}}`):this.url.searchParams.append(n,`cs.${JSON.stringify(e)}`),this}containedBy(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cd.{${e.join(",")}}`):this.url.searchParams.append(n,`cd.${JSON.stringify(e)}`),this}rangeGt(n,e){return this.url.searchParams.append(n,`sr.${e}`),this}rangeGte(n,e){return this.url.searchParams.append(n,`nxl.${e}`),this}rangeLt(n,e){return this.url.searchParams.append(n,`sl.${e}`),this}rangeLte(n,e){return this.url.searchParams.append(n,`nxr.${e}`),this}rangeAdjacent(n,e){return this.url.searchParams.append(n,`adj.${e}`),this}overlaps(n,e){return typeof e=="string"?this.url.searchParams.append(n,`ov.${e}`):this.url.searchParams.append(n,`ov.{${e.join(",")}}`),this}textSearch(n,e,{config:t,type:r}={}){let i="";r==="plain"?i="pl":r==="phrase"?i="ph":r==="websearch"&&(i="w");const o=t===void 0?"":`(${t})`;return this.url.searchParams.append(n,`${i}fts${o}.${e}`),this}match(n){return Object.entries(n).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(n,e,t){return this.url.searchParams.append(n,`not.${e}.${t}`),this}or(n,{foreignTable:e,referencedTable:t=e}={}){const r=t?`${t}.or`:"or";return this.url.searchParams.append(r,`(${n})`),this}filter(n,e,t){return this.url.searchParams.append(n,`${e}.${t}`),this}},pl=class{constructor(n,{headers:e={},schema:t,fetch:r}){this.url=n,this.headers=new Headers(e),this.schema=t,this.fetch=r}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(n,e){const{head:t=!1,count:r}=e??{},i=t?"HEAD":"GET";let o=!1;const l=(n??"*").split("").map(m=>/\s/.test(m)&&!o?"":(m==='"'&&(o=!o),m)).join(""),{url:d,headers:f}=this.cloneRequestState();return d.searchParams.set("select",l),r&&f.append("Prefer",`count=${r}`),new Zn({method:i,url:d,headers:f,schema:this.schema,fetch:this.fetch})}insert(n,{count:e,defaultToNull:t=!0}={}){var r;const i="POST",{url:o,headers:l}=this.cloneRequestState();if(e&&l.append("Prefer",`count=${e}`),t||l.append("Prefer","missing=default"),Array.isArray(n)){const d=n.reduce((f,m)=>f.concat(Object.keys(m)),[]);if(d.length>0){const f=[...new Set(d)].map(m=>`"${m}"`);o.searchParams.set("columns",f.join(","))}}return new Zn({method:i,url:o,headers:l,schema:this.schema,body:n,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch})}upsert(n,{onConflict:e,ignoreDuplicates:t=!1,count:r,defaultToNull:i=!0}={}){var o;const l="POST",{url:d,headers:f}=this.cloneRequestState();if(f.append("Prefer",`resolution=${t?"ignore":"merge"}-duplicates`),e!==void 0&&d.searchParams.set("on_conflict",e),r&&f.append("Prefer",`count=${r}`),i||f.append("Prefer","missing=default"),Array.isArray(n)){const m=n.reduce((v,y)=>v.concat(Object.keys(y)),[]);if(m.length>0){const v=[...new Set(m)].map(y=>`"${y}"`);d.searchParams.set("columns",v.join(","))}}return new Zn({method:l,url:d,headers:f,schema:this.schema,body:n,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}update(n,{count:e}={}){var t;const r="PATCH",{url:i,headers:o}=this.cloneRequestState();return e&&o.append("Prefer",`count=${e}`),new Zn({method:r,url:i,headers:o,schema:this.schema,body:n,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch})}delete({count:n}={}){var e;const t="DELETE",{url:r,headers:i}=this.cloneRequestState();return n&&i.append("Prefer",`count=${n}`),new Zn({method:t,url:r,headers:i,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch})}},ml=class Hs{constructor(e,{headers:t={},schema:r,fetch:i}={}){this.url=e,this.headers=new Headers(t),this.schemaName=r,this.fetch=i}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new pl(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new Hs(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:i=!1,count:o}={}){var l;let d;const f=new URL(`${this.url}/rpc/${e}`);let m;const v=C=>C!==null&&typeof C=="object"&&(!Array.isArray(C)||C.some(v)),y=r&&Object.values(t).some(v);y?(d="POST",m=t):r||i?(d=r?"HEAD":"GET",Object.entries(t).filter(([C,w])=>w!==void 0).map(([C,w])=>[C,Array.isArray(w)?`{${w.join(",")}}`:`${w}`]).forEach(([C,w])=>{f.searchParams.append(C,w)})):(d="POST",m=t);const _=new Headers(this.headers);return y?_.set("Prefer",o?`count=${o},return=minimal`:"return=minimal"):o&&_.set("Prefer",`count=${o}`),new Zn({method:d,url:f,headers:_,schema:this.schemaName,body:m,fetch:(l=this.fetch)!==null&&l!==void 0?l:fetch})}};class gl{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const t=globalThis.process;if(t){const r=t.versions;if(r&&r.node){const i=r.node,o=parseInt(i.replace(/^v/,"").split(".")[0]);return o>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${o} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${o} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const vl="2.91.1",yl=`realtime-js/${vl}`,bl="1.0.0",Ws="2.0.0",ls=Ws,ti=1e4,_l=1e3,wl=100;var En;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(En||(En={}));var st;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(st||(st={}));var nn;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(nn||(nn={}));var ni;(function(n){n.websocket="websocket"})(ni||(ni={}));var Bn;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(Bn||(Bn={}));class kl{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,r;const i=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,i)}_encodeJsonUserBroadcastPush(e){var t,r;const i=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:{},l=new TextEncoder().encode(JSON.stringify(i)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,l)}_encodeUserBroadcastPush(e,t,r){var i,o;const l=e.topic,d=(i=e.ref)!==null&&i!==void 0?i:"",f=(o=e.join_ref)!==null&&o!==void 0?o:"",m=e.payload.event,v=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},y=Object.keys(v).length===0?"":JSON.stringify(v);if(f.length>255)throw new Error(`joinRef length ${f.length} exceeds maximum of 255`);if(d.length>255)throw new Error(`ref length ${d.length} exceeds maximum of 255`);if(l.length>255)throw new Error(`topic length ${l.length} exceeds maximum of 255`);if(m.length>255)throw new Error(`userEvent length ${m.length} exceeds maximum of 255`);if(y.length>255)throw new Error(`metadata length ${y.length} exceeds maximum of 255`);const _=this.USER_BROADCAST_PUSH_META_LENGTH+f.length+d.length+l.length+m.length+y.length,C=new ArrayBuffer(this.HEADER_LENGTH+_);let w=new DataView(C),N=0;w.setUint8(N++,this.KINDS.userBroadcastPush),w.setUint8(N++,f.length),w.setUint8(N++,d.length),w.setUint8(N++,l.length),w.setUint8(N++,m.length),w.setUint8(N++,y.length),w.setUint8(N++,t),Array.from(f,O=>w.setUint8(N++,O.charCodeAt(0))),Array.from(d,O=>w.setUint8(N++,O.charCodeAt(0))),Array.from(l,O=>w.setUint8(N++,O.charCodeAt(0))),Array.from(m,O=>w.setUint8(N++,O.charCodeAt(0))),Array.from(y,O=>w.setUint8(N++,O.charCodeAt(0)));var I=new Uint8Array(C.byteLength+r.byteLength);return I.set(new Uint8Array(C),0),I.set(new Uint8Array(r),C.byteLength),I.buffer}decode(e,t){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return t(r)}if(typeof e=="string"){const r=JSON.parse(e),[i,o,l,d,f]=r;return t({join_ref:i,ref:o,topic:l,event:d,payload:f})}return t({})}_binaryDecode(e){const t=new DataView(e),r=t.getUint8(0),i=new TextDecoder;switch(r){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(e,t,i)}}_decodeUserBroadcast(e,t,r){const i=t.getUint8(1),o=t.getUint8(2),l=t.getUint8(3),d=t.getUint8(4);let f=this.HEADER_LENGTH+4;const m=r.decode(e.slice(f,f+i));f=f+i;const v=r.decode(e.slice(f,f+o));f=f+o;const y=r.decode(e.slice(f,f+l));f=f+l;const _=e.slice(f,e.byteLength),C=d===this.JSON_ENCODING?JSON.parse(r.decode(_)):_,w={type:this.BROADCAST_EVENT,event:v,payload:C};return l>0&&(w.meta=JSON.parse(y)),{join_ref:null,ref:null,topic:m,event:this.BROADCAST_EVENT,payload:w}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e==null?void 0:e.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>t.includes(r)))}}class Vs{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var ze;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(ze||(ze={}));const cs=(n,e,t={})=>{var r;const i=(r=t.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((o,l)=>(o[l]=Sl(l,n,e,i),o),{}):{}},Sl=(n,e,t,r)=>{const i=e.find(d=>d.name===n),o=i==null?void 0:i.type,l=t[n];return o&&!r.includes(o)?Gs(o,l):ri(l)},Gs=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return Al(e,t)}switch(n){case ze.bool:return El(e);case ze.float4:case ze.float8:case ze.int2:case ze.int4:case ze.int8:case ze.numeric:case ze.oid:return Cl(e);case ze.json:case ze.jsonb:return Tl(e);case ze.timestamp:return xl(e);case ze.abstime:case ze.date:case ze.daterange:case ze.int4range:case ze.int8range:case ze.money:case ze.reltime:case ze.text:case ze.time:case ze.timestamptz:case ze.timetz:case ze.tsrange:case ze.tstzrange:return ri(e);default:return ri(e)}},ri=n=>n,El=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Cl=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Tl=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch{return n}return n},Al=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let o;const l=n.slice(1,t);try{o=JSON.parse("["+l+"]")}catch{o=l?l.split(","):[]}return o.map(d=>Gs(e,d))}return n},xl=n=>typeof n=="string"?n.replace(" ","T"):n,Js=n=>{const e=new URL(n);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class Fa{constructor(e,t,r={},i=ti){this.channel=e,this.event=t,this.payload=r,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var us;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(us||(us={}));class vr{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},i=>{const{onJoin:o,onLeave:l,onSync:d}=this.caller;this.joinRef=this.channel._joinRef(),this.state=vr.syncState(this.state,i,o,l),this.pendingDiffs.forEach(f=>{this.state=vr.syncDiff(this.state,f,o,l)}),this.pendingDiffs=[],d()}),this.channel._on(r.diff,{},i=>{const{onJoin:o,onLeave:l,onSync:d}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=vr.syncDiff(this.state,i,o,l),d())}),this.onJoin((i,o,l)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:o,newPresences:l})}),this.onLeave((i,o,l)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:o,leftPresences:l})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,i){const o=this.cloneDeep(e),l=this.transformState(t),d={},f={};return this.map(o,(m,v)=>{l[m]||(f[m]=v)}),this.map(l,(m,v)=>{const y=o[m];if(y){const _=v.map(I=>I.presence_ref),C=y.map(I=>I.presence_ref),w=v.filter(I=>C.indexOf(I.presence_ref)<0),N=y.filter(I=>_.indexOf(I.presence_ref)<0);w.length>0&&(d[m]=w),N.length>0&&(f[m]=N)}else d[m]=v}),this.syncDiff(o,{joins:d,leaves:f},r,i)}static syncDiff(e,t,r,i){const{joins:o,leaves:l}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),i||(i=()=>{}),this.map(o,(d,f)=>{var m;const v=(m=e[d])!==null&&m!==void 0?m:[];if(e[d]=this.cloneDeep(f),v.length>0){const y=e[d].map(C=>C.presence_ref),_=v.filter(C=>y.indexOf(C.presence_ref)<0);e[d].unshift(..._)}r(d,v,f)}),this.map(l,(d,f)=>{let m=e[d];if(!m)return;const v=f.map(y=>y.presence_ref);m=m.filter(y=>v.indexOf(y.presence_ref)<0),e[d]=m,i(d,m,f),m.length===0&&delete e[d]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const i=e[r];return"metas"in i?t[r]=i.metas.map(o=>(o.presence_ref=o.phx_ref,delete o.phx_ref,delete o.phx_ref_prev,o)):t[r]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var ds;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(ds||(ds={}));var yr;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(yr||(yr={}));var gn;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(gn||(gn={}));class rr{constructor(e,t={config:{}},r){var i,o;if(this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=st.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Fa(this,nn.join,this.params,this.timeout),this.rejoinTimer=new Vs(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=st.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(l=>l.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=st.closed,this.socket._remove(this)}),this._onError(l=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,l),this.state=st.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=st.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",l=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,l),this.state=st.errored,this.rejoinTimer.scheduleTimeout())}),this._on(nn.reply,{},(l,d)=>{this._trigger(this._replyEventName(d),l)}),this.presence=new vr(this),this.broadcastEndpointURL=Js(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((o=(i=this.params.config)===null||i===void 0?void 0:i.broadcast)===null||o===void 0)&&o.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var r,i,o;if(this.socket.isConnected()||this.socket.connect(),this.state==st.closed){const{config:{broadcast:l,presence:d,private:f}}=this.params,m=(i=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(C=>C.filter))!==null&&i!==void 0?i:[],v=!!this.bindings[yr.PRESENCE]&&this.bindings[yr.PRESENCE].length>0||((o=this.params.config.presence)===null||o===void 0?void 0:o.enabled)===!0,y={},_={broadcast:l,presence:Object.assign(Object.assign({},d),{enabled:v}),postgres_changes:m,private:f};this.socket.accessTokenValue&&(y.access_token=this.socket.accessTokenValue),this._onError(C=>e==null?void 0:e(gn.CHANNEL_ERROR,C)),this._onClose(()=>e==null?void 0:e(gn.CLOSED)),this.updateJoinPayload(Object.assign({config:_},y)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:C})=>{var w;if(this.socket._isManualToken()||this.socket.setAuth(),C===void 0){e==null||e(gn.SUBSCRIBED);return}else{const N=this.bindings.postgres_changes,I=(w=N==null?void 0:N.length)!==null&&w!==void 0?w:0,O=[];for(let U=0;U<I;U++){const D=N[U],{filter:{event:B,schema:K,table:M,filter:L}}=D,te=C&&C[U];if(te&&te.event===B&&rr.isFilterValueEqual(te.schema,K)&&rr.isFilterValueEqual(te.table,M)&&rr.isFilterValueEqual(te.filter,L))O.push(Object.assign(Object.assign({},D),{id:te.id}));else{this.unsubscribe(),this.state=st.errored,e==null||e(gn.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=O,e&&e(gn.SUBSCRIBED);return}}).receive("error",C=>{this.state=st.errored,e==null||e(gn.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(C).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(gn.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===st.joined&&e===yr.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,t,r)}async httpSend(e,t,r={}){var i;if(t==null)return Promise.reject("Payload is required for httpSend()");const o={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(o.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:o,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},d=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(i=r.timeout)!==null&&i!==void 0?i:this.timeout);if(d.status===202)return{success:!0};let f=d.statusText;try{const m=await d.json();f=m.error||m.message||f}catch{}return Promise.reject(new Error(f))}async send(e,t={}){var r,i;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:o,payload:l}=e,d={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(d.Authorization=`Bearer ${this.socket.accessTokenValue}`);const f={method:"POST",headers:d,body:JSON.stringify({messages:[{topic:this.subTopic,event:o,payload:l,private:this.private}]})};try{const m=await this._fetchWithTimeout(this.broadcastEndpointURL,f,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((i=m.body)===null||i===void 0?void 0:i.cancel()),m.ok?"ok":"error"}catch(m){return m.name==="AbortError"?"timed out":"error"}}else return new Promise(o=>{var l,d,f;const m=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((f=(d=(l=this.params)===null||l===void 0?void 0:l.config)===null||d===void 0?void 0:d.broadcast)===null||f===void 0)&&f.ack)&&o("ok"),m.receive("ok",()=>o("ok")),m.receive("error",()=>o("error")),m.receive("timeout",()=>o("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=st.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(nn.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(i=>{r=new Fa(this,nn.leave,{},e),r.receive("ok",()=>{t(),i("ok")}).receive("timeout",()=>{t(),i("timed out")}).receive("error",()=>{i("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r==null||r.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=st.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){const i=new AbortController,o=setTimeout(()=>i.abort(),r),l=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(o),l}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new Fa(this,e,t,r);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>wl){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var i,o;const l=e.toLocaleLowerCase(),{close:d,error:f,leave:m,join:v}=nn;if(r&&[d,f,m,v].indexOf(l)>=0&&r!==this._joinRef())return;let _=this._onMessage(l,t,r);if(t&&!_)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(l)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(C=>{var w,N,I;return((w=C.filter)===null||w===void 0?void 0:w.event)==="*"||((I=(N=C.filter)===null||N===void 0?void 0:N.event)===null||I===void 0?void 0:I.toLocaleLowerCase())===l}).map(C=>C.callback(_,r)):(o=this.bindings[l])===null||o===void 0||o.filter(C=>{var w,N,I,O,U,D,B,K;if(["broadcast","presence","postgres_changes"].includes(l))if("id"in C){const M=C.id,L=(w=C.filter)===null||w===void 0?void 0:w.event;return M&&((N=t.ids)===null||N===void 0?void 0:N.includes(M))&&(L==="*"||(L==null?void 0:L.toLocaleLowerCase())===((I=t.data)===null||I===void 0?void 0:I.type.toLocaleLowerCase()))&&(!(!((O=C.filter)===null||O===void 0)&&O.table)||C.filter.table===((U=t.data)===null||U===void 0?void 0:U.table))}else{const M=(B=(D=C==null?void 0:C.filter)===null||D===void 0?void 0:D.event)===null||B===void 0?void 0:B.toLocaleLowerCase();return M==="*"||M===((K=t==null?void 0:t.event)===null||K===void 0?void 0:K.toLocaleLowerCase())}else return C.type.toLocaleLowerCase()===l}).map(C=>{if(typeof _=="object"&&"ids"in _){const w=_.data,{schema:N,table:I,commit_timestamp:O,type:U,errors:D}=w;_=Object.assign(Object.assign({},{schema:N,table:I,commit_timestamp:O,eventType:U,new:{},old:{},errors:D}),this._getPayloadRecords(w))}C.callback(_,r)})}_isClosed(){return this.state===st.closed}_isJoined(){return this.state===st.joined}_isJoining(){return this.state===st.joining}_isLeaving(){return this.state===st.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const i=e.toLocaleLowerCase(),o={type:i,filter:t,callback:r};return this.bindings[i]?this.bindings[i].push(o):this.bindings[i]=[o],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(i=>{var o;return!(((o=i.type)===null||o===void 0?void 0:o.toLocaleLowerCase())===r&&rr.isEqual(i.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}static isFilterValueEqual(e,t){return(e??void 0)===(t??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(nn.close,{},e)}_onError(e){this._on(nn.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=st.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=cs(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=cs(e.columns,e.old_record)),t}}const Ka=()=>{},Vr={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Ol=[1e3,2e3,5e3,1e4],$l=1e4,Rl=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Pl{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=ti,this.transport=null,this.heartbeatIntervalMs=Vr.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Ka,this.ref=0,this.reconnectTimer=null,this.vsn=ls,this.logger=Ka,this.conn=null,this.sendBuffer=[],this.serializer=new kl,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=i=>i?(...o)=>i(...o):(...o)=>fetch(...o),!(!((r=t==null?void 0:t.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${ni.websocket}`,this.httpEndpoint=Js(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t==null?void 0:t.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=gl.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case En.connecting:return Bn.Connecting;case En.open:return Bn.Open;case En.closing:return Bn.Closing;default:return Bn.Closed}}isConnected(){return this.connectionState()===Bn.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const r=`realtime:${e}`,i=this.getChannels().find(o=>o.topic===r);if(i)return i;{const o=new rr(`realtime:${e}`,t,this);return this.channels.push(o),o}}push(e){const{topic:t,event:r,payload:i,ref:o}=e,l=()=>{this.encode(e,d=>{var f;(f=this.conn)===null||f===void 0||f.send(d)})};this.log("push",`${t} ${r} (${o})`,i),this.isConnected()?l():this.sendBuffer.push(l)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(_l,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},Vr.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply"&&t.ref&&t.ref===this.pendingHeartbeatRef){const m=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error",m)}catch(v){this.log("error","error in heartbeat callback",v)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:r,event:i,payload:o,ref:l}=t,d=l?`(${l})`:"",f=o.status||"";this.log("receive",`${f} ${r} ${i} ${d}`.trim(),o),this.channels.filter(m=>m._isMember(r)).forEach(m=>m._trigger(i,o,l)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===En.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===En.open||this.conn.readyState===En.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this._terminateWorker()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(nn.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${r}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([Rl],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t,r=!1;if(e)t=e,r=!0;else if(this.accessToken)try{t=await this.accessToken()}catch(i){this.log("error","Error fetching access token from callback",i),t=this.accessTokenValue}else t=this.accessTokenValue;r?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(i=>{const o={access_token:t,version:yl};t&&i.updateJoinPayload(o),i.joinedOnce&&i._isJoined()&&i._push(nn.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(t=>{this.log("error",`Error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new Vs(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Vr.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,i,o,l,d,f,m,v,y,_,C;switch(this.transport=(t=e==null?void 0:e.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e==null?void 0:e.timeout)!==null&&r!==void 0?r:ti,this.heartbeatIntervalMs=(i=e==null?void 0:e.heartbeatIntervalMs)!==null&&i!==void 0?i:Vr.HEARTBEAT_INTERVAL,this.worker=(o=e==null?void 0:e.worker)!==null&&o!==void 0?o:!1,this.accessToken=(l=e==null?void 0:e.accessToken)!==null&&l!==void 0?l:null,this.heartbeatCallback=(d=e==null?void 0:e.heartbeatCallback)!==null&&d!==void 0?d:Ka,this.vsn=(f=e==null?void 0:e.vsn)!==null&&f!==void 0?f:ls,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(m=e==null?void 0:e.reconnectAfterMs)!==null&&m!==void 0?m:w=>Ol[w-1]||$l,this.vsn){case bl:this.encode=(v=e==null?void 0:e.encode)!==null&&v!==void 0?v:(w,N)=>N(JSON.stringify(w)),this.decode=(y=e==null?void 0:e.decode)!==null&&y!==void 0?y:(w,N)=>N(JSON.parse(w));break;case Ws:this.encode=(_=e==null?void 0:e.encode)!==null&&_!==void 0?_:this.serializer.encode.bind(this.serializer),this.decode=(C=e==null?void 0:e.decode)!==null&&C!==void 0?C:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}var br=class extends Error{constructor(n,e){var t;super(n),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&((t=e.icebergType)==null?void 0:t.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function Nl(n,e,t){const r=new URL(e,n);if(t)for(const[i,o]of Object.entries(t))o!==void 0&&r.searchParams.set(i,o);return r.toString()}async function Il(n){return!n||n.type==="none"?{}:n.type==="bearer"?{Authorization:`Bearer ${n.token}`}:n.type==="header"?{[n.name]:n.value}:n.type==="custom"?await n.getHeaders():{}}function jl(n){const e=n.fetchImpl??globalThis.fetch;return{async request({method:t,path:r,query:i,body:o,headers:l}){const d=Nl(n.baseUrl,r,i),f=await Il(n.auth),m=await e(d,{method:t,headers:{...o?{"Content-Type":"application/json"}:{},...f,...l},body:o?JSON.stringify(o):void 0}),v=await m.text(),y=(m.headers.get("content-type")||"").includes("application/json"),_=y&&v?JSON.parse(v):v;if(!m.ok){const C=y?_:void 0,w=C==null?void 0:C.error;throw new br((w==null?void 0:w.message)??`Request failed with status ${m.status}`,{status:m.status,icebergType:w==null?void 0:w.type,icebergCode:w==null?void 0:w.code,details:C})}return{status:m.status,headers:m.headers,data:_}}}}function Gr(n){return n.join("")}var Ll=class{constructor(n,e=""){this.client=n,this.prefix=e}async listNamespaces(n){const e=n?{parent:Gr(n.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(n,e){const t={namespace:n.namespace,properties:e==null?void 0:e.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(n){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Gr(n.namespace)}`})}async loadNamespaceMetadata(n){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Gr(n.namespace)}`})).data.properties}}async namespaceExists(n){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Gr(n.namespace)}`}),!0}catch(e){if(e instanceof br&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(n,e){try{return await this.createNamespace(n,e)}catch(t){if(t instanceof br&&t.status===409)return;throw t}}};function Vn(n){return n.join("")}var ql=class{constructor(n,e="",t){this.client=n,this.prefix=e,this.accessDelegation=t}async listTables(n){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Vn(n.namespace)}/tables`})).data.identifiers}async createTable(n,e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Vn(n.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(n,e){const t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Vn(n.namespace)}/tables/${n.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(n,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Vn(n.namespace)}/tables/${n.name}`,query:{purgeRequested:String((e==null?void 0:e.purge)??!1)}})}async loadTable(n){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Vn(n.namespace)}/tables/${n.name}`,headers:e})).data.metadata}async tableExists(n){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Vn(n.namespace)}/tables/${n.name}`,headers:e}),!0}catch(t){if(t instanceof br&&t.status===404)return!1;throw t}}async createTableIfNotExists(n,e){try{return await this.createTable(n,e)}catch(t){if(t instanceof br&&t.status===409)return await this.loadTable({namespace:n.namespace,name:e.name});throw t}}},Dl=class{constructor(n){var r;let e="v1";n.catalogName&&(e+=`/${n.catalogName}`);const t=n.baseUrl.endsWith("/")?n.baseUrl:`${n.baseUrl}/`;this.client=jl({baseUrl:t,auth:n.auth,fetchImpl:n.fetch}),this.accessDelegation=(r=n.accessDelegation)==null?void 0:r.join(","),this.namespaceOps=new Ll(this.client,e),this.tableOps=new ql(this.client,e,this.accessDelegation)}async listNamespaces(n){return this.namespaceOps.listNamespaces(n)}async createNamespace(n,e){return this.namespaceOps.createNamespace(n,e)}async dropNamespace(n){await this.namespaceOps.dropNamespace(n)}async loadNamespaceMetadata(n){return this.namespaceOps.loadNamespaceMetadata(n)}async listTables(n){return this.tableOps.listTables(n)}async createTable(n,e){return this.tableOps.createTable(n,e)}async updateTable(n,e){return this.tableOps.updateTable(n,e)}async dropTable(n,e){await this.tableOps.dropTable(n,e)}async loadTable(n){return this.tableOps.loadTable(n)}async namespaceExists(n){return this.namespaceOps.namespaceExists(n)}async tableExists(n){return this.tableOps.tableExists(n)}async createNamespaceIfNotExists(n,e){return this.namespaceOps.createNamespaceIfNotExists(n,e)}async createTableIfNotExists(n,e){return this.tableOps.createTableIfNotExists(n,e)}},ha=class extends Error{constructor(n){super(n),this.__isStorageError=!0,this.name="StorageError"}};function Ye(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}var Bl=class extends ha{constructor(n,e,t){super(n),this.name="StorageApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},ai=class extends ha{constructor(n,e){super(n),this.name="StorageUnknownError",this.originalError=e}};const vi=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Ml=()=>Response,ii=n=>{if(Array.isArray(n))return n.map(t=>ii(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,r])=>{const i=t.replace(/([-_][a-z])/gi,o=>o.toUpperCase().replace(/[-_]/g,""));e[i]=ii(r)}),e},Ul=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},Fl=n=>!n||typeof n!="string"||n.length===0||n.length>100||n.trim()!==n||n.includes("/")||n.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(n);function _r(n){"@babel/helpers - typeof";return _r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_r(n)}function Kl(n,e){if(_r(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(_r(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function zl(n){var e=Kl(n,"string");return _r(e)=="symbol"?e:e+""}function Hl(n,e,t){return(e=zl(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function hs(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function pe(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hs(Object(t),!0).forEach(function(r){Hl(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):hs(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const za=n=>{var e;return n.msg||n.message||n.error_description||(typeof n.error=="string"?n.error:(e=n.error)===null||e===void 0?void 0:e.message)||JSON.stringify(n)},Wl=async(n,e,t)=>{n instanceof await Ml()&&!(t!=null&&t.noResolveJson)?n.json().then(r=>{const i=n.status||500,o=(r==null?void 0:r.statusCode)||i+"";e(new Bl(za(r),i,o))}).catch(r=>{e(new ai(za(r),r))}):e(new ai(za(n),n))},Vl=(n,e,t,r)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"||!r?i:(Ul(r)?(i.headers=pe({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(r)):i.body=r,e!=null&&e.duplex&&(i.duplex=e.duplex),pe(pe({},i),t))};async function Tr(n,e,t,r,i,o){return new Promise((l,d)=>{n(t,Vl(e,r,i,o)).then(f=>{if(!f.ok)throw f;return r!=null&&r.noResolveJson?f:f.json()}).then(f=>l(f)).catch(f=>Wl(f,d,r))})}async function wr(n,e,t,r){return Tr(n,"GET",e,t,r)}async function tn(n,e,t,r,i){return Tr(n,"POST",e,r,i,t)}async function si(n,e,t,r,i){return Tr(n,"PUT",e,r,i,t)}async function Gl(n,e,t,r){return Tr(n,"HEAD",e,pe(pe({},t),{},{noResolveJson:!0}),r)}async function yi(n,e,t,r,i){return Tr(n,"DELETE",e,r,i,t)}var Jl=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e}then(n,e){return this.execute().then(n,e)}async execute(){var n=this;try{return{data:(await n.downloadFn()).body,error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(Ye(e))return{data:null,error:e};throw e}}};let Ys;Ys=Symbol.toStringTag;var Yl=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e,this[Ys]="BlobDownloadBuilder",this.promise=null}asStream(){return new Jl(this.downloadFn,this.shouldThrowOnError)}then(n,e){return this.getPromise().then(n,e)}catch(n){return this.getPromise().catch(n)}finally(n){return this.getPromise().finally(n)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var n=this;try{return{data:await(await n.downloadFn()).blob(),error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(Ye(e))return{data:null,error:e};throw e}}};const Ql={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},fs={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var Xl=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1,this.url=n,this.headers=e,this.bucketId=t,this.fetch=vi(r)}throwOnError(){return this.shouldThrowOnError=!0,this}async uploadOrUpdate(n,e,t,r){var i=this;try{let o;const l=pe(pe({},fs),r);let d=pe(pe({},i.headers),n==="POST"&&{"x-upsert":String(l.upsert)});const f=l.metadata;typeof Blob<"u"&&t instanceof Blob?(o=new FormData,o.append("cacheControl",l.cacheControl),f&&o.append("metadata",i.encodeMetadata(f)),o.append("",t)):typeof FormData<"u"&&t instanceof FormData?(o=t,o.has("cacheControl")||o.append("cacheControl",l.cacheControl),f&&!o.has("metadata")&&o.append("metadata",i.encodeMetadata(f))):(o=t,d["cache-control"]=`max-age=${l.cacheControl}`,d["content-type"]=l.contentType,f&&(d["x-metadata"]=i.toBase64(i.encodeMetadata(f))),(typeof ReadableStream<"u"&&o instanceof ReadableStream||o&&typeof o=="object"&&"pipe"in o&&typeof o.pipe=="function")&&!l.duplex&&(l.duplex="half")),r!=null&&r.headers&&(d=pe(pe({},d),r.headers));const m=i._removeEmptyFolders(e),v=i._getFinalPath(m),y=await(n=="PUT"?si:tn)(i.fetch,`${i.url}/object/${v}`,o,pe({headers:d},l!=null&&l.duplex?{duplex:l.duplex}:{}));return{data:{path:m,id:y.Id,fullPath:y.Key},error:null}}catch(o){if(i.shouldThrowOnError)throw o;if(Ye(o))return{data:null,error:o};throw o}}async upload(n,e,t){return this.uploadOrUpdate("POST",n,e,t)}async uploadToSignedUrl(n,e,t,r){var i=this;const o=i._removeEmptyFolders(n),l=i._getFinalPath(o),d=new URL(i.url+`/object/upload/sign/${l}`);d.searchParams.set("token",e);try{let f;const m=pe({upsert:fs.upsert},r),v=pe(pe({},i.headers),{"x-upsert":String(m.upsert)});return typeof Blob<"u"&&t instanceof Blob?(f=new FormData,f.append("cacheControl",m.cacheControl),f.append("",t)):typeof FormData<"u"&&t instanceof FormData?(f=t,f.append("cacheControl",m.cacheControl)):(f=t,v["cache-control"]=`max-age=${m.cacheControl}`,v["content-type"]=m.contentType),{data:{path:o,fullPath:(await si(i.fetch,d.toString(),f,{headers:v})).Key},error:null}}catch(f){if(i.shouldThrowOnError)throw f;if(Ye(f))return{data:null,error:f};throw f}}async createSignedUploadUrl(n,e){var t=this;try{let r=t._getFinalPath(n);const i=pe({},t.headers);e!=null&&e.upsert&&(i["x-upsert"]="true");const o=await tn(t.fetch,`${t.url}/object/upload/sign/${r}`,{},{headers:i}),l=new URL(t.url+o.url),d=l.searchParams.get("token");if(!d)throw new ha("No token returned by API");return{data:{signedUrl:l.toString(),path:n,token:d},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Ye(r))return{data:null,error:r};throw r}}async update(n,e,t){return this.uploadOrUpdate("PUT",n,e,t)}async move(n,e,t){var r=this;try{return{data:await tn(r.fetch,`${r.url}/object/move`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t==null?void 0:t.destinationBucket},{headers:r.headers}),error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(Ye(i))return{data:null,error:i};throw i}}async copy(n,e,t){var r=this;try{return{data:{path:(await tn(r.fetch,`${r.url}/object/copy`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t==null?void 0:t.destinationBucket},{headers:r.headers})).Key},error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(Ye(i))return{data:null,error:i};throw i}}async createSignedUrl(n,e,t){var r=this;try{let i=r._getFinalPath(n),o=await tn(r.fetch,`${r.url}/object/sign/${i}`,pe({expiresIn:e},t!=null&&t.transform?{transform:t.transform}:{}),{headers:r.headers});const l=t!=null&&t.download?`&download=${t.download===!0?"":t.download}`:"";return o={signedUrl:encodeURI(`${r.url}${o.signedURL}${l}`)},{data:o,error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(Ye(i))return{data:null,error:i};throw i}}async createSignedUrls(n,e,t){var r=this;try{const i=await tn(r.fetch,`${r.url}/object/sign/${r.bucketId}`,{expiresIn:e,paths:n},{headers:r.headers}),o=t!=null&&t.download?`&download=${t.download===!0?"":t.download}`:"";return{data:i.map(l=>pe(pe({},l),{},{signedUrl:l.signedURL?encodeURI(`${r.url}${l.signedURL}${o}`):null})),error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(Ye(i))return{data:null,error:i};throw i}}download(n,e){const t=typeof(e==null?void 0:e.transform)<"u"?"render/image/authenticated":"object",r=this.transformOptsToQueryString((e==null?void 0:e.transform)||{}),i=r?`?${r}`:"",o=this._getFinalPath(n),l=()=>wr(this.fetch,`${this.url}/${t}/${o}${i}`,{headers:this.headers,noResolveJson:!0});return new Yl(l,this.shouldThrowOnError)}async info(n){var e=this;const t=e._getFinalPath(n);try{return{data:ii(await wr(e.fetch,`${e.url}/object/info/${t}`,{headers:e.headers})),error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(Ye(r))return{data:null,error:r};throw r}}async exists(n){var e=this;const t=e._getFinalPath(n);try{return await Gl(e.fetch,`${e.url}/object/${t}`,{headers:e.headers}),{data:!0,error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(Ye(r)&&r instanceof ai){const i=r.originalError;if([400,404].includes(i==null?void 0:i.status))return{data:!1,error:r}}throw r}}getPublicUrl(n,e){const t=this._getFinalPath(n),r=[],i=e!=null&&e.download?`download=${e.download===!0?"":e.download}`:"";i!==""&&r.push(i);const o=typeof(e==null?void 0:e.transform)<"u"?"render/image":"object",l=this.transformOptsToQueryString((e==null?void 0:e.transform)||{});l!==""&&r.push(l);let d=r.join("&");return d!==""&&(d=`?${d}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${t}${d}`)}}}async remove(n){var e=this;try{return{data:await yi(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}async list(n,e,t){var r=this;try{const i=pe(pe(pe({},Ql),e),{},{prefix:n||""});return{data:await tn(r.fetch,`${r.url}/object/list/${r.bucketId}`,i,{headers:r.headers},t),error:null}}catch(i){if(r.shouldThrowOnError)throw i;if(Ye(i))return{data:null,error:i};throw i}}async listV2(n,e){var t=this;try{const r=pe({},n);return{data:await tn(t.fetch,`${t.url}/object/list-v2/${t.bucketId}`,r,{headers:t.headers},e),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Ye(r))return{data:null,error:r};throw r}}encodeMetadata(n){return JSON.stringify(n)}toBase64(n){return typeof Buffer<"u"?Buffer.from(n).toString("base64"):btoa(n)}_getFinalPath(n){return`${this.bucketId}/${n.replace(/^\/+/,"")}`}_removeEmptyFolders(n){return n.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(n){const e=[];return n.width&&e.push(`width=${n.width}`),n.height&&e.push(`height=${n.height}`),n.resize&&e.push(`resize=${n.resize}`),n.format&&e.push(`format=${n.format}`),n.quality&&e.push(`quality=${n.quality}`),e.join("&")}};const Qs="2.91.1",Xs={"X-Client-Info":`storage-js/${Qs}`};var Zl=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1;const i=new URL(n);r!=null&&r.useNewHostname&&/supabase\.(co|in|red)$/.test(i.hostname)&&!i.hostname.includes("storage.supabase.")&&(i.hostname=i.hostname.replace("supabase.","storage.supabase.")),this.url=i.href.replace(/\/$/,""),this.headers=pe(pe({},Xs),e),this.fetch=vi(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async listBuckets(n){var e=this;try{const t=e.listBucketOptionsToQueryString(n);return{data:await wr(e.fetch,`${e.url}/bucket${t}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await wr(e.fetch,`${e.url}/bucket/${n}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}async createBucket(n,e={public:!1}){var t=this;try{return{data:await tn(t.fetch,`${t.url}/bucket`,{id:n,name:n,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Ye(r))return{data:null,error:r};throw r}}async updateBucket(n,e){var t=this;try{return{data:await si(t.fetch,`${t.url}/bucket/${n}`,{id:n,name:n,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Ye(r))return{data:null,error:r};throw r}}async emptyBucket(n){var e=this;try{return{data:await tn(e.fetch,`${e.url}/bucket/${n}/empty`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await yi(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}listBucketOptionsToQueryString(n){const e={};return n&&("limit"in n&&(e.limit=String(n.limit)),"offset"in n&&(e.offset=String(n.offset)),n.search&&(e.search=n.search),n.sortColumn&&(e.sortColumn=n.sortColumn),n.sortOrder&&(e.sortOrder=n.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},ec=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=pe(pe({},Xs),e),this.fetch=vi(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await tn(e.fetch,`${e.url}/bucket`,{name:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}async listBuckets(n){var e=this;try{const t=new URLSearchParams;(n==null?void 0:n.limit)!==void 0&&t.set("limit",n.limit.toString()),(n==null?void 0:n.offset)!==void 0&&t.set("offset",n.offset.toString()),n!=null&&n.sortColumn&&t.set("sortColumn",n.sortColumn),n!=null&&n.sortOrder&&t.set("sortOrder",n.sortOrder),n!=null&&n.search&&t.set("search",n.search);const r=t.toString(),i=r?`${e.url}/bucket?${r}`:`${e.url}/bucket`;return{data:await wr(e.fetch,i,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await yi(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Ye(t))return{data:null,error:t};throw t}}from(n){var e=this;if(!Fl(n))throw new ha("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const t=new Dl({baseUrl:this.url,catalogName:n,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),r=this.shouldThrowOnError;return new Proxy(t,{get(i,o){const l=i[o];return typeof l!="function"?l:async(...d)=>{try{return{data:await l.apply(i,d),error:null}}catch(f){if(r)throw f;return{data:null,error:f}}}}})}};const bi={"X-Client-Info":`storage-js/${Qs}`,"Content-Type":"application/json"};var Zs=class extends Error{constructor(n){super(n),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}};function Lt(n){return typeof n=="object"&&n!==null&&"__isStorageVectorsError"in n}var Ha=class extends Zs{constructor(n,e,t){super(n),this.name="StorageVectorsApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},tc=class extends Zs{constructor(n,e){super(n),this.name="StorageVectorsUnknownError",this.originalError=e}};const _i=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),nc=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},ps=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),rc=async(n,e,t)=>{if(n&&typeof n=="object"&&"status"in n&&"ok"in n&&typeof n.status=="number"&&!(t!=null&&t.noResolveJson)){const r=n.status||500,i=n;if(typeof i.json=="function")i.json().then(o=>{const l=(o==null?void 0:o.statusCode)||(o==null?void 0:o.code)||r+"";e(new Ha(ps(o),r,l))}).catch(()=>{const o=r+"";e(new Ha(i.statusText||`HTTP ${r} error`,r,o))});else{const o=r+"";e(new Ha(i.statusText||`HTTP ${r} error`,r,o))}}else e(new tc(ps(n),n))},ac=(n,e,t,r)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return r?(nc(r)?(i.headers=pe({"Content-Type":"application/json"},e==null?void 0:e.headers),i.body=JSON.stringify(r)):i.body=r,pe(pe({},i),t)):i};async function ic(n,e,t,r,i,o){return new Promise((l,d)=>{n(t,ac(e,r,i,o)).then(f=>{if(!f.ok)throw f;if(r!=null&&r.noResolveJson)return f;const m=f.headers.get("content-type");return!m||!m.includes("application/json")?{}:f.json()}).then(f=>l(f)).catch(f=>rc(f,d,r))})}async function qt(n,e,t,r,i){return ic(n,"POST",e,r,i,t)}var sc=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=pe(pe({},bi),e),this.fetch=_i(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createIndex(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/CreateIndex`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async getIndex(n,e){var t=this;try{return{data:await qt(t.fetch,`${t.url}/GetIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Lt(r))return{data:null,error:r};throw r}}async listIndexes(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/ListIndexes`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async deleteIndex(n,e){var t=this;try{return{data:await qt(t.fetch,`${t.url}/DeleteIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers})||{},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Lt(r))return{data:null,error:r};throw r}}},oc=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=pe(pe({},bi),e),this.fetch=_i(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async putVectors(n){var e=this;try{if(n.vectors.length<1||n.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:await qt(e.fetch,`${e.url}/PutVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async getVectors(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/GetVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async listVectors(n){var e=this;try{if(n.segmentCount!==void 0){if(n.segmentCount<1||n.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(n.segmentIndex!==void 0&&(n.segmentIndex<0||n.segmentIndex>=n.segmentCount))throw new Error(`segmentIndex must be between 0 and ${n.segmentCount-1}`)}return{data:await qt(e.fetch,`${e.url}/ListVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async queryVectors(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/QueryVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async deleteVectors(n){var e=this;try{if(n.keys.length<1||n.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:await qt(e.fetch,`${e.url}/DeleteVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}},lc=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=pe(pe({},bi),e),this.fetch=_i(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async listBuckets(n={}){var e=this;try{return{data:await qt(e.fetch,`${e.url}/ListVectorBuckets`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await qt(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Lt(t))return{data:null,error:t};throw t}}},cc=class extends lc{constructor(n,e={}){super(n,e.headers||{},e.fetch)}from(n){return new uc(this.url,this.headers,n,this.fetch)}async createBucket(n){var e=()=>super.createBucket,t=this;return e().call(t,n)}async getBucket(n){var e=()=>super.getBucket,t=this;return e().call(t,n)}async listBuckets(n={}){var e=()=>super.listBuckets,t=this;return e().call(t,n)}async deleteBucket(n){var e=()=>super.deleteBucket,t=this;return e().call(t,n)}},uc=class extends sc{constructor(n,e,t,r){super(n,e,r),this.vectorBucketName=t}async createIndex(n){var e=()=>super.createIndex,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName}))}async listIndexes(n={}){var e=()=>super.listIndexes,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName}))}async getIndex(n){var e=()=>super.getIndex,t=this;return e().call(t,t.vectorBucketName,n)}async deleteIndex(n){var e=()=>super.deleteIndex,t=this;return e().call(t,t.vectorBucketName,n)}index(n){return new dc(this.url,this.headers,this.vectorBucketName,n,this.fetch)}},dc=class extends oc{constructor(n,e,t,r,i){super(n,e,i),this.vectorBucketName=t,this.indexName=r}async putVectors(n){var e=()=>super.putVectors,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async getVectors(n){var e=()=>super.getVectors,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async listVectors(n={}){var e=()=>super.listVectors,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async queryVectors(n){var e=()=>super.queryVectors,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async deleteVectors(n){var e=()=>super.deleteVectors,t=this;return e().call(t,pe(pe({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}},hc=class extends Zl{constructor(n,e={},t,r){super(n,e,t,r)}from(n){return new Xl(this.url,this.headers,n,this.fetch)}get vectors(){return new cc(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new ec(this.url+"/iceberg",this.headers,this.fetch)}};const eo="2.91.1",er=30*1e3,oi=3,Wa=oi*er,fc="http://localhost:9999",pc="supabase.auth.token",mc={"X-Client-Info":`gotrue-js/${eo}`},li="X-Supabase-Api-Version",to={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},gc=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,vc=10*60*1e3;class kr extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}}function oe(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class yc extends kr{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}}function bc(n){return oe(n)&&n.name==="AuthApiError"}class Mn extends kr{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class yn extends kr{constructor(e,t,r,i){super(e,r,i),this.name=t,this.status=r}}class It extends yn{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function _c(n){return oe(n)&&n.name==="AuthSessionMissingError"}class Gn extends yn{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class Jr extends yn{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Yr extends yn{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function wc(n){return oe(n)&&n.name==="AuthImplicitGrantRedirectError"}class ms extends yn{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class kc extends yn{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class ci extends yn{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Va(n){return oe(n)&&n.name==="AuthRetryableFetchError"}class gs extends yn{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}}class ui extends yn{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const na="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),vs=` 	
\r=`.split(""),Sc=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<vs.length;e+=1)n[vs[e].charCodeAt(0)]=-2;for(let e=0;e<na.length;e+=1)n[na[e].charCodeAt(0)]=e;return n})();function ys(n,e,t){if(n!==null)for(e.queue=e.queue<<8|n,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(na[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(na[r]),e.queuedBits-=6}}function no(n,e,t){const r=Sc[n];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function bs(n){const e=[],t=l=>{e.push(String.fromCodePoint(l))},r={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},o=l=>{Tc(l,r,t)};for(let l=0;l<n.length;l+=1)no(n.charCodeAt(l),i,o);return e.join("")}function Ec(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function Cc(n,e){for(let t=0;t<n.length;t+=1){let r=n.charCodeAt(t);if(r>55295&&r<=56319){const i=(r-55296)*1024&65535;r=(n.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}Ec(r,e)}}function Tc(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let r=1;r<6;r+=1)if(!(n>>7-r&1)){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function ar(n){const e=[],t={queue:0,queuedBits:0},r=i=>{e.push(i)};for(let i=0;i<n.length;i+=1)no(n.charCodeAt(i),t,r);return new Uint8Array(e)}function Ac(n){const e=[];return Cc(n,t=>e.push(t)),new Uint8Array(e)}function Un(n){const e=[],t={queue:0,queuedBits:0},r=i=>{e.push(i)};return n.forEach(i=>ys(i,t,r)),ys(null,t,r),e.join("")}function xc(n){return Math.round(Date.now()/1e3)+n}function Oc(){return Symbol("auth-callback")}const mt=()=>typeof window<"u"&&typeof document<"u",Ln={tested:!1,writable:!1},ro=()=>{if(!mt())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Ln.tested)return Ln.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),Ln.tested=!0,Ln.writable=!0}catch{Ln.tested=!0,Ln.writable=!1}return Ln.writable};function $c(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,o)=>{e[o]=i})}catch{}return t.searchParams.forEach((r,i)=>{e[i]=r}),e}const ao=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Rc=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",tr=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},qn=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},pt=async(n,e)=>{await n.removeItem(e)};class fa{constructor(){this.promise=new fa.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}fa.promiseConstructor=Promise;function Ga(n){const e=n.split(".");if(e.length!==3)throw new ui("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!gc.test(e[r]))throw new ui("JWT not in base64url format");return{header:JSON.parse(bs(e[0])),payload:JSON.parse(bs(e[1])),signature:ar(e[2]),raw:{header:e[0],payload:e[1]}}}async function Pc(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function Nc(n,e){return new Promise((r,i)=>{(async()=>{for(let o=0;o<1/0;o++)try{const l=await n(o);if(!e(o,null,l)){r(l);return}}catch(l){if(!e(o,l)){i(l);return}}})()})}function Ic(n){return("0"+n.toString(16)).substr(-2)}function jc(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let i="";for(let o=0;o<56;o++)i+=t.charAt(Math.floor(Math.random()*r));return i}return crypto.getRandomValues(e),Array.from(e,Ic).join("")}async function Lc(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(r);return Array.from(i).map(o=>String.fromCharCode(o)).join("")}async function qc(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await Lc(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Jn(n,e,t=!1){const r=jc();let i=r;t&&(i+="/PASSWORD_RECOVERY"),await tr(n,`${e}-code-verifier`,i);const o=await qc(r);return[o,r===o?"plain":"s256"]}const Dc=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Bc(n){const e=n.headers.get(li);if(!e||!e.match(Dc))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Mc(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function Uc(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Fc=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Yn(n){if(!Fc.test(n))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Ja(){const n={};return new Proxy(n,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Kc(n,e){return new Proxy(n,{get:(t,r,i)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){const o=r.toString();if(o==="Symbol(Symbol.toPrimitive)"||o==="Symbol(Symbol.toStringTag)"||o==="Symbol(util.inspect.custom)"||o==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,r,i)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,r,i)}})}function _s(n){return JSON.parse(JSON.stringify(n))}const Dn=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),zc=[502,503,504];async function ws(n){var e;if(!Rc(n))throw new ci(Dn(n),0);if(zc.includes(n.status))throw new ci(Dn(n),n.status);let t;try{t=await n.json()}catch(o){throw new Mn(Dn(o),o)}let r;const i=Bc(n);if(i&&i.getTime()>=to["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new gs(Dn(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new It}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((o,l)=>o&&typeof l=="string",!0))throw new gs(Dn(t),n.status,t.weak_password.reasons);throw new yc(Dn(t),n.status||500,r)}const Hc=(n,e,t,r)=>{const i={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),t))};async function fe(n,e,t,r){var i;const o=Object.assign({},r==null?void 0:r.headers);o[li]||(o[li]=to["2024-01-01"].name),r!=null&&r.jwt&&(o.Authorization=`Bearer ${r.jwt}`);const l=(i=r==null?void 0:r.query)!==null&&i!==void 0?i:{};r!=null&&r.redirectTo&&(l.redirect_to=r.redirectTo);const d=Object.keys(l).length?"?"+new URLSearchParams(l).toString():"",f=await Wc(n,e,t+d,{headers:o,noResolveJson:r==null?void 0:r.noResolveJson},{},r==null?void 0:r.body);return r!=null&&r.xform?r==null?void 0:r.xform(f):{data:Object.assign({},f),error:null}}async function Wc(n,e,t,r,i,o){const l=Hc(e,r,i,o);let d;try{d=await n(t,Object.assign({},l))}catch(f){throw console.error(f),new ci(Dn(f),0)}if(d.ok||await ws(d),r!=null&&r.noResolveJson)return d;try{return await d.json()}catch(f){await ws(f)}}function en(n){var e;let t=null;Jc(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=xc(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function ks(n){const e=en(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function Cn(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function Vc(n){return{data:n,error:null}}function Gc(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:i,verification_type:o}=n,l=da(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),d={action_link:e,email_otp:t,hashed_token:r,redirect_to:i,verification_type:o},f=Object.assign({},l);return{data:{properties:d,user:f},error:null}}function Ss(n){return n}function Jc(n){return n.access_token&&n.refresh_token&&n.expires_in}const Ya=["global","local","others"];class Yc{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=ao(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=Ya[0]){if(Ya.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Ya.join(", ")}`);try{return await fe(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(oe(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await fe(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:Cn})}catch(r){if(oe(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=da(e,["options"]),i=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(i.new_email=r==null?void 0:r.newEmail,delete i.newEmail),await fe(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:Gc,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(oe(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await fe(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:Cn})}catch(t){if(oe(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,i,o,l,d,f;try{const m={nextPage:null,lastPage:0,total:0},v=await fe(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(o=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&o!==void 0?o:""},xform:Ss});if(v.error)throw v.error;const y=await v.json(),_=(l=v.headers.get("x-total-count"))!==null&&l!==void 0?l:0,C=(f=(d=v.headers.get("link"))===null||d===void 0?void 0:d.split(","))!==null&&f!==void 0?f:[];return C.length>0&&(C.forEach(w=>{const N=parseInt(w.split(";")[0].split("=")[1].substring(0,1)),I=JSON.parse(w.split(";")[1].split("=")[1]);m[`${I}Page`]=N}),m.total=parseInt(_)),{data:Object.assign(Object.assign({},y),m),error:null}}catch(m){if(oe(m))return{data:{users:[]},error:m};throw m}}async getUserById(e){Yn(e);try{return await fe(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:Cn})}catch(t){if(oe(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){Yn(e);try{return await fe(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:Cn})}catch(r){if(oe(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){Yn(e);try{return await fe(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:Cn})}catch(r){if(oe(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){Yn(e.userId);try{const{data:t,error:r}=await fe(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:r}}catch(t){if(oe(t))return{data:null,error:t};throw t}}async _deleteFactor(e){Yn(e.userId),Yn(e.id);try{return{data:await fe(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(oe(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,r,i,o,l,d,f;try{const m={nextPage:null,lastPage:0,total:0},v=await fe(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(o=(i=e==null?void 0:e.perPage)===null||i===void 0?void 0:i.toString())!==null&&o!==void 0?o:""},xform:Ss});if(v.error)throw v.error;const y=await v.json(),_=(l=v.headers.get("x-total-count"))!==null&&l!==void 0?l:0,C=(f=(d=v.headers.get("link"))===null||d===void 0?void 0:d.split(","))!==null&&f!==void 0?f:[];return C.length>0&&(C.forEach(w=>{const N=parseInt(w.split(";")[0].split("=")[1].substring(0,1)),I=JSON.parse(w.split(";")[1].split("=")[1]);m[`${I}Page`]=N}),m.total=parseInt(_)),{data:Object.assign(Object.assign({},y),m),error:null}}catch(m){if(oe(m))return{data:{clients:[]},error:m};throw m}}async _createOAuthClient(e){try{return await fe(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(oe(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await fe(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(oe(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await fe(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(oe(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await fe(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(oe(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await fe(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(oe(t))return{data:null,error:t};throw t}}}function Es(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}const Qn={debug:!!(globalThis&&ro()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class io extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Qc extends io{}async function Xc(n,e,t){Qn.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),Qn.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async i=>{if(i){Qn.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,i.name);try{return await t()}finally{Qn.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,i.name)}}else{if(e===0)throw Qn.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new Qc(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(Qn.debug)try{const o=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(o,null,"  "))}catch(o){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",o)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function Zc(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function so(n){if(!/^0x[a-fA-F0-9]{40}$/.test(n))throw new Error(`@supabase/auth-js: Address "${n}" is invalid.`);return n.toLowerCase()}function eu(n){return parseInt(n,16)}function tu(n){const e=new TextEncoder().encode(n);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function nu(n){var e;const{chainId:t,domain:r,expirationTime:i,issuedAt:o=new Date,nonce:l,notBefore:d,requestId:f,resources:m,scheme:v,uri:y,version:_}=n;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(l&&l.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${l}`);if(!y)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(_!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${_}`);if(!((e=n.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${n.statement}`)}const C=so(n.address),w=v?`${v}://${r}`:r,N=n.statement?`${n.statement}
`:"",I=`${w} wants you to sign in with your Ethereum account:
${C}

${N}`;let O=`URI: ${y}
Version: ${_}
Chain ID: ${t}${l?`
Nonce: ${l}`:""}
Issued At: ${o.toISOString()}`;if(i&&(O+=`
Expiration Time: ${i.toISOString()}`),d&&(O+=`
Not Before: ${d.toISOString()}`),f&&(O+=`
Request ID: ${f}`),m){let U=`
Resources:`;for(const D of m){if(!D||typeof D!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${D}`);U+=`
- ${D}`}O+=U}return`${I}
${O}`}class at extends Error{constructor({message:e,code:t,cause:r,name:i}){var o;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(o=i??(r instanceof Error?r.name:void 0))!==null&&o!==void 0?o:"Unknown Error",this.code=t}}class ra extends at{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function ru({error:n,options:e}){var t,r,i;const{publicKey:o}=e;if(!o)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new at({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else if(n.name==="ConstraintError"){if(((t=o.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new at({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:n});if(e.mediation==="conditional"&&((r=o.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new at({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:n});if(((i=o.authenticatorSelection)===null||i===void 0?void 0:i.userVerification)==="required")return new at({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:n})}else{if(n.name==="InvalidStateError")return new at({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:n});if(n.name==="NotAllowedError")return new at({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="NotSupportedError")return o.pubKeyCredParams.filter(d=>d.type==="public-key").length===0?new at({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:n}):new at({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:n});if(n.name==="SecurityError"){const l=window.location.hostname;if(oo(l)){if(o.rp.id!==l)return new at({message:`The RP ID "${o.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new at({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="TypeError"){if(o.user.id.byteLength<1||o.user.id.byteLength>64)return new at({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:n})}else if(n.name==="UnknownError")return new at({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new at({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}function au({error:n,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new at({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else{if(n.name==="NotAllowedError")return new at({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="SecurityError"){const r=window.location.hostname;if(oo(r)){if(t.rpId!==r)return new at({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new at({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="UnknownError")return new at({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new at({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}class iu{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const su=new iu;function ou(n){if(!n)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(n);const{challenge:e,user:t,excludeCredentials:r}=n,i=da(n,["challenge","user","excludeCredentials"]),o=ar(e).buffer,l=Object.assign(Object.assign({},t),{id:ar(t.id).buffer}),d=Object.assign(Object.assign({},i),{challenge:o,user:l});if(r&&r.length>0){d.excludeCredentials=new Array(r.length);for(let f=0;f<r.length;f++){const m=r[f];d.excludeCredentials[f]=Object.assign(Object.assign({},m),{id:ar(m.id).buffer,type:m.type||"public-key",transports:m.transports})}}return d}function lu(n){if(!n)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(n);const{challenge:e,allowCredentials:t}=n,r=da(n,["challenge","allowCredentials"]),i=ar(e).buffer,o=Object.assign(Object.assign({},r),{challenge:i});if(t&&t.length>0){o.allowCredentials=new Array(t.length);for(let l=0;l<t.length;l++){const d=t[l];o.allowCredentials[l]=Object.assign(Object.assign({},d),{id:ar(d.id).buffer,type:d.type||"public-key",transports:d.transports})}}return o}function cu(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n;return{id:n.id,rawId:n.id,response:{attestationObject:Un(new Uint8Array(n.response.attestationObject)),clientDataJSON:Un(new Uint8Array(n.response.clientDataJSON))},type:"public-key",clientExtensionResults:n.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function uu(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n,r=n.getClientExtensionResults(),i=n.response;return{id:n.id,rawId:n.id,response:{authenticatorData:Un(new Uint8Array(i.authenticatorData)),clientDataJSON:Un(new Uint8Array(i.clientDataJSON)),signature:Un(new Uint8Array(i.signature)),userHandle:i.userHandle?Un(new Uint8Array(i.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function oo(n){return n==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(n)}function Cs(){var n,e;return!!(mt()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((n=navigator==null?void 0:navigator.credentials)===null||n===void 0?void 0:n.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function du(n){try{const e=await navigator.credentials.create(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new ra("Browser returned unexpected credential type",e)}:{data:null,error:new ra("Empty credential response",e)}}catch(e){return{data:null,error:ru({error:e,options:n})}}}async function hu(n){try{const e=await navigator.credentials.get(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new ra("Browser returned unexpected credential type",e)}:{data:null,error:new ra("Empty credential response",e)}}catch(e){return{data:null,error:au({error:e,options:n})}}}const fu={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},pu={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function aa(...n){const e=i=>i!==null&&typeof i=="object"&&!Array.isArray(i),t=i=>i instanceof ArrayBuffer||ArrayBuffer.isView(i),r={};for(const i of n)if(i)for(const o in i){const l=i[o];if(l!==void 0)if(Array.isArray(l))r[o]=l;else if(t(l))r[o]=l;else if(e(l)){const d=r[o];e(d)?r[o]=aa(d,l):r[o]=aa(l)}else r[o]=l}return r}function mu(n,e){return aa(fu,n,e||{})}function gu(n,e){return aa(pu,n,e||{})}class vu{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:r,signal:i},o){try{const{data:l,error:d}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!l)return{data:null,error:d};const f=i??su.createNewAbortSignal();if(l.webauthn.type==="create"){const{user:m}=l.webauthn.credential_options.publicKey;m.name||(m.name=`${m.id}:${r}`),m.displayName||(m.displayName=m.name)}switch(l.webauthn.type){case"create":{const m=mu(l.webauthn.credential_options.publicKey,o==null?void 0:o.create),{data:v,error:y}=await du({publicKey:m,signal:f});return v?{data:{factorId:e,challengeId:l.id,webauthn:{type:l.webauthn.type,credential_response:v}},error:null}:{data:null,error:y}}case"request":{const m=gu(l.webauthn.credential_options.publicKey,o==null?void 0:o.request),{data:v,error:y}=await hu(Object.assign(Object.assign({},l.webauthn.credential_options),{publicKey:m,signal:f}));return v?{data:{factorId:e,challengeId:l.id,webauthn:{type:l.webauthn.type,credential_response:v}},error:null}:{data:null,error:y}}}}catch(l){return oe(l)?{data:null,error:l}:{data:null,error:new Mn("Unexpected error in challenge",l)}}}async _verify({challengeId:e,factorId:t,webauthn:r}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},o){if(!t)return{data:null,error:new kr("rpId is required for WebAuthn authentication")};try{if(!Cs())return{data:null,error:new Mn("Browser does not support WebAuthn",null)};const{data:l,error:d}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:r},signal:i},{request:o});if(!l)return{data:null,error:d};const{webauthn:f}=l;return this._verify({factorId:e,challengeId:l.challengeId,webauthn:{type:f.type,rpId:t,rpOrigins:r,credential_response:f.credential_response}})}catch(l){return oe(l)?{data:null,error:l}:{data:null,error:new Mn("Unexpected error in authenticate",l)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:i}={}},o){if(!t)return{data:null,error:new kr("rpId is required for WebAuthn registration")};try{if(!Cs())return{data:null,error:new Mn("Browser does not support WebAuthn",null)};const{data:l,error:d}=await this._enroll({friendlyName:e});if(!l)return await this.client.mfa.listFactors().then(v=>{var y;return(y=v.data)===null||y===void 0?void 0:y.all.find(_=>_.factor_type==="webauthn"&&_.friendly_name===e&&_.status!=="unverified")}).then(v=>v?this.client.mfa.unenroll({factorId:v==null?void 0:v.id}):void 0),{data:null,error:d};const{data:f,error:m}=await this._challenge({factorId:l.id,friendlyName:l.friendly_name,webauthn:{rpId:t,rpOrigins:r},signal:i},{create:o});return f?this._verify({factorId:l.id,challengeId:f.challengeId,webauthn:{rpId:t,rpOrigins:r,type:f.webauthn.type,credential_response:f.webauthn.credential_response}}):{data:null,error:m}}catch(l){return oe(l)?{data:null,error:l}:{data:null,error:new Mn("Unexpected error in register",l)}}}}Zc();const yu={url:fc,storageKey:pc,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:mc,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function Ts(n,e,t){return await t()}const Xn={};class Sr{get jwks(){var e,t;return(t=(e=Xn[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){Xn[this.storageKey]=Object.assign(Object.assign({},Xn[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=Xn[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){Xn[this.storageKey]=Object.assign(Object.assign({},Xn[this.storageKey]),{cachedAt:e})}constructor(e){var t,r,i;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const o=Object.assign(Object.assign({},yu),e);if(this.storageKey=o.storageKey,this.instanceID=(t=Sr.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,Sr.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!o.debug,typeof o.debug=="function"&&(this.logger=o.debug),this.instanceID>0&&mt()){const l=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(l),this.logDebugMessages&&console.trace(l)}if(this.persistSession=o.persistSession,this.autoRefreshToken=o.autoRefreshToken,this.admin=new Yc({url:o.url,headers:o.headers,fetch:o.fetch}),this.url=o.url,this.headers=o.headers,this.fetch=ao(o.fetch),this.lock=o.lock||Ts,this.detectSessionInUrl=o.detectSessionInUrl,this.flowType=o.flowType,this.hasCustomAuthorizationHeader=o.hasCustomAuthorizationHeader,this.throwOnError=o.throwOnError,this.lockAcquireTimeout=o.lockAcquireTimeout,o.lock?this.lock=o.lock:this.persistSession&&mt()&&(!((r=globalThis==null?void 0:globalThis.navigator)===null||r===void 0)&&r.locks)?this.lock=Xc:this.lock=Ts,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new vu(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(o.storage?this.storage=o.storage:ro()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Es(this.memoryStorage)),o.userStorage&&(this.userStorage=o.userStorage)):(this.memoryStorage={},this.storage=Es(this.memoryStorage)),mt()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(l){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",l)}(i=this.broadcastChannel)===null||i===void 0||i.addEventListener("message",async l=>{this._debug("received broadcast notification from other tab or client",l),await this._notifyAllSubscribers(l.data.event,l.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${eo}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},r="none";if(mt()&&(t=$c(window.location.href),this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce")),mt()&&this.detectSessionInUrl&&r!=="none"){const{data:i,error:o}=await this._getSessionFromURL(t,r);if(o){if(this._debug("#_initialize()","error detecting session from URL",o),wc(o)){const f=(e=o.details)===null||e===void 0?void 0:e.code;if(f==="identity_already_exists"||f==="identity_not_found"||f==="single_identity_not_deletable")return{error:o}}return{error:o}}const{session:l,redirectType:d}=i;return this._debug("#_initialize()","detected session in URL",l,"redirect type",d),await this._saveSession(l),setTimeout(async()=>{d==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",l):await this._notifyAllSubscribers("SIGNED_IN",l)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return oe(t)?this._returnResult({error:t}):this._returnResult({error:new Mn("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,i;try{const o=await fe(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(i=e==null?void 0:e.options)===null||i===void 0?void 0:i.captchaToken}},xform:en}),{data:l,error:d}=o;if(d||!l)return this._returnResult({data:{user:null,session:null},error:d});const f=l.session,m=l.user;return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",f)),this._returnResult({data:{user:m,session:f},error:null})}catch(o){if(oe(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async signUp(e){var t,r,i;try{let o;if("email"in e){const{email:v,password:y,options:_}=e;let C=null,w=null;this.flowType==="pkce"&&([C,w]=await Jn(this.storage,this.storageKey)),o=await fe(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:_==null?void 0:_.emailRedirectTo,body:{email:v,password:y,data:(t=_==null?void 0:_.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:_==null?void 0:_.captchaToken},code_challenge:C,code_challenge_method:w},xform:en})}else if("phone"in e){const{phone:v,password:y,options:_}=e;o=await fe(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:v,password:y,data:(r=_==null?void 0:_.data)!==null&&r!==void 0?r:{},channel:(i=_==null?void 0:_.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:_==null?void 0:_.captchaToken}},xform:en})}else throw new Jr("You must provide either an email or phone number and a password");const{data:l,error:d}=o;if(d||!l)return await pt(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:d});const f=l.session,m=l.user;return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",f)),this._returnResult({data:{user:m,session:f},error:null})}catch(o){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async signInWithPassword(e){try{let t;if("email"in e){const{email:o,password:l,options:d}=e;t=await fe(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:o,password:l,gotrue_meta_security:{captcha_token:d==null?void 0:d.captchaToken}},xform:ks})}else if("phone"in e){const{phone:o,password:l,options:d}=e;t=await fe(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:o,password:l,gotrue_meta_security:{captcha_token:d==null?void 0:d.captchaToken}},xform:ks})}else throw new Jr("You must provide either an email or phone number and a password");const{data:r,error:i}=t;if(i)return this._returnResult({data:{user:null,session:null},error:i});if(!r||!r.session||!r.user){const o=new Gn;return this._returnResult({data:{user:null,session:null},error:o})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:i})}catch(t){if(oe(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,r,i,o;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(o=e.options)===null||o===void 0?void 0:o.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,r,i,o,l,d,f,m,v,y,_;let C,w;if("message"in e)C=e.message,w=e.signature;else{const{chain:N,wallet:I,statement:O,options:U}=e;let D;if(mt())if(typeof I=="object")D=I;else{const ne=window;if("ethereum"in ne&&typeof ne.ethereum=="object"&&"request"in ne.ethereum&&typeof ne.ethereum.request=="function")D=ne.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof I!="object"||!(U!=null&&U.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");D=I}const B=new URL((t=U==null?void 0:U.url)!==null&&t!==void 0?t:window.location.href),K=await D.request({method:"eth_requestAccounts"}).then(ne=>ne).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!K||K.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const M=so(K[0]);let L=(r=U==null?void 0:U.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!L){const ne=await D.request({method:"eth_chainId"});L=eu(ne)}const te={domain:B.host,address:M,statement:O,uri:B.href,version:"1",chainId:L,nonce:(i=U==null?void 0:U.signInWithEthereum)===null||i===void 0?void 0:i.nonce,issuedAt:(l=(o=U==null?void 0:U.signInWithEthereum)===null||o===void 0?void 0:o.issuedAt)!==null&&l!==void 0?l:new Date,expirationTime:(d=U==null?void 0:U.signInWithEthereum)===null||d===void 0?void 0:d.expirationTime,notBefore:(f=U==null?void 0:U.signInWithEthereum)===null||f===void 0?void 0:f.notBefore,requestId:(m=U==null?void 0:U.signInWithEthereum)===null||m===void 0?void 0:m.requestId,resources:(v=U==null?void 0:U.signInWithEthereum)===null||v===void 0?void 0:v.resources};C=nu(te),w=await D.request({method:"personal_sign",params:[tu(C),M]})}try{const{data:N,error:I}=await fe(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:C,signature:w},!((y=e.options)===null||y===void 0)&&y.captchaToken?{gotrue_meta_security:{captcha_token:(_=e.options)===null||_===void 0?void 0:_.captchaToken}}:null),xform:en});if(I)throw I;if(!N||!N.session||!N.user){const O=new Gn;return this._returnResult({data:{user:null,session:null},error:O})}return N.session&&(await this._saveSession(N.session),await this._notifyAllSubscribers("SIGNED_IN",N.session)),this._returnResult({data:Object.assign({},N),error:I})}catch(N){if(oe(N))return this._returnResult({data:{user:null,session:null},error:N});throw N}}async signInWithSolana(e){var t,r,i,o,l,d,f,m,v,y,_,C;let w,N;if("message"in e)w=e.message,N=e.signature;else{const{chain:I,wallet:O,statement:U,options:D}=e;let B;if(mt())if(typeof O=="object")B=O;else{const M=window;if("solana"in M&&typeof M.solana=="object"&&("signIn"in M.solana&&typeof M.solana.signIn=="function"||"signMessage"in M.solana&&typeof M.solana.signMessage=="function"))B=M.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof O!="object"||!(D!=null&&D.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");B=O}const K=new URL((t=D==null?void 0:D.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in B&&B.signIn){const M=await B.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},D==null?void 0:D.signInWithSolana),{version:"1",domain:K.host,uri:K.href}),U?{statement:U}:null));let L;if(Array.isArray(M)&&M[0]&&typeof M[0]=="object")L=M[0];else if(M&&typeof M=="object"&&"signedMessage"in M&&"signature"in M)L=M;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in L&&"signature"in L&&(typeof L.signedMessage=="string"||L.signedMessage instanceof Uint8Array)&&L.signature instanceof Uint8Array)w=typeof L.signedMessage=="string"?L.signedMessage:new TextDecoder().decode(L.signedMessage),N=L.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in B)||typeof B.signMessage!="function"||!("publicKey"in B)||typeof B!="object"||!B.publicKey||!("toBase58"in B.publicKey)||typeof B.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");w=[`${K.host} wants you to sign in with your Solana account:`,B.publicKey.toBase58(),...U?["",U,""]:[""],"Version: 1",`URI: ${K.href}`,`Issued At: ${(i=(r=D==null?void 0:D.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((o=D==null?void 0:D.signInWithSolana)===null||o===void 0)&&o.notBefore?[`Not Before: ${D.signInWithSolana.notBefore}`]:[],...!((l=D==null?void 0:D.signInWithSolana)===null||l===void 0)&&l.expirationTime?[`Expiration Time: ${D.signInWithSolana.expirationTime}`]:[],...!((d=D==null?void 0:D.signInWithSolana)===null||d===void 0)&&d.chainId?[`Chain ID: ${D.signInWithSolana.chainId}`]:[],...!((f=D==null?void 0:D.signInWithSolana)===null||f===void 0)&&f.nonce?[`Nonce: ${D.signInWithSolana.nonce}`]:[],...!((m=D==null?void 0:D.signInWithSolana)===null||m===void 0)&&m.requestId?[`Request ID: ${D.signInWithSolana.requestId}`]:[],...!((y=(v=D==null?void 0:D.signInWithSolana)===null||v===void 0?void 0:v.resources)===null||y===void 0)&&y.length?["Resources",...D.signInWithSolana.resources.map(L=>`- ${L}`)]:[]].join(`
`);const M=await B.signMessage(new TextEncoder().encode(w),"utf8");if(!M||!(M instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");N=M}}try{const{data:I,error:O}=await fe(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:w,signature:Un(N)},!((_=e.options)===null||_===void 0)&&_.captchaToken?{gotrue_meta_security:{captcha_token:(C=e.options)===null||C===void 0?void 0:C.captchaToken}}:null),xform:en});if(O)throw O;if(!I||!I.session||!I.user){const U=new Gn;return this._returnResult({data:{user:null,session:null},error:U})}return I.session&&(await this._saveSession(I.session),await this._notifyAllSubscribers("SIGNED_IN",I.session)),this._returnResult({data:Object.assign({},I),error:O})}catch(I){if(oe(I))return this._returnResult({data:{user:null,session:null},error:I});throw I}}async _exchangeCodeForSession(e){const t=await qn(this.storage,`${this.storageKey}-code-verifier`),[r,i]=(t??"").split("/");try{if(!r&&this.flowType==="pkce")throw new kc;const{data:o,error:l}=await fe(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:en});if(await pt(this.storage,`${this.storageKey}-code-verifier`),l)throw l;if(!o||!o.session||!o.user){const d=new Gn;return this._returnResult({data:{user:null,session:null,redirectType:null},error:d})}return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",o.session)),this._returnResult({data:Object.assign(Object.assign({},o),{redirectType:i??null}),error:l})}catch(o){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(o))return this._returnResult({data:{user:null,session:null,redirectType:null},error:o});throw o}}async signInWithIdToken(e){try{const{options:t,provider:r,token:i,access_token:o,nonce:l}=e,d=await fe(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:i,access_token:o,nonce:l,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:en}),{data:f,error:m}=d;if(m)return this._returnResult({data:{user:null,session:null},error:m});if(!f||!f.session||!f.user){const v=new Gn;return this._returnResult({data:{user:null,session:null},error:v})}return f.session&&(await this._saveSession(f.session),await this._notifyAllSubscribers("SIGNED_IN",f.session)),this._returnResult({data:f,error:m})}catch(t){if(oe(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,r,i,o,l;try{if("email"in e){const{email:d,options:f}=e;let m=null,v=null;this.flowType==="pkce"&&([m,v]=await Jn(this.storage,this.storageKey));const{error:y}=await fe(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:d,data:(t=f==null?void 0:f.data)!==null&&t!==void 0?t:{},create_user:(r=f==null?void 0:f.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:f==null?void 0:f.captchaToken},code_challenge:m,code_challenge_method:v},redirectTo:f==null?void 0:f.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:y})}if("phone"in e){const{phone:d,options:f}=e,{data:m,error:v}=await fe(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:d,data:(i=f==null?void 0:f.data)!==null&&i!==void 0?i:{},create_user:(o=f==null?void 0:f.shouldCreateUser)!==null&&o!==void 0?o:!0,gotrue_meta_security:{captcha_token:f==null?void 0:f.captchaToken},channel:(l=f==null?void 0:f.channel)!==null&&l!==void 0?l:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:m==null?void 0:m.message_id},error:v})}throw new Jr("You must provide either an email or phone number.")}catch(d){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(d))return this._returnResult({data:{user:null,session:null},error:d});throw d}}async verifyOtp(e){var t,r;try{let i,o;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,o=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:l,error:d}=await fe(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:o}}),redirectTo:i,xform:en});if(d)throw d;if(!l)throw new Error("An error occurred on token verification.");const f=l.session,m=l.user;return f!=null&&f.access_token&&(await this._saveSession(f),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",f)),this._returnResult({data:{user:m,session:f},error:null})}catch(i){if(oe(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithSSO(e){var t,r,i,o,l;try{let d=null,f=null;this.flowType==="pkce"&&([d,f]=await Jn(this.storage,this.storageKey));const m=await fe(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((i=e==null?void 0:e.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:d,code_challenge_method:f}),headers:this.headers,xform:Vc});return!((o=m.data)===null||o===void 0)&&o.url&&mt()&&!(!((l=e.options)===null||l===void 0)&&l.skipBrowserRedirect)&&window.location.assign(m.data.url),this._returnResult(m)}catch(d){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(d))return this._returnResult({data:null,error:d});throw d}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new It;const{error:i}=await fe(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:i})})}catch(e){if(oe(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:i,options:o}=e,{error:l}=await fe(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},redirectTo:o==null?void 0:o.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:l})}else if("phone"in e){const{phone:r,type:i,options:o}=e,{data:l,error:d}=await fe(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:d})}throw new Jr("You must provide either an email or phone number and a type")}catch(t){if(oe(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await qn(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<Wa:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const l=await qn(this.userStorage,this.storageKey+"-user");l!=null&&l.user?e.user=l.user:e.user=Ja()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const l={value:this.suppressGetSessionWarning};e.user=Kc(e.user,l),l.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:i,error:o}=await this._callRefreshToken(e.refresh_token);return o?this._returnResult({data:{session:null},error:o}):this._returnResult({data:{session:i},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const t=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return t.data.user&&(this.suppressGetSessionWarning=!0),t}async _getUser(e){try{return e?await fe(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:Cn}):await this._useSession(async t=>{var r,i,o;const{data:l,error:d}=t;if(d)throw d;return!(!((r=l.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new It}:await fe(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(o=(i=l.session)===null||i===void 0?void 0:i.access_token)!==null&&o!==void 0?o:void 0,xform:Cn})})}catch(t){if(oe(t))return _c(t)&&(await this._removeSession(),await pt(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:i,error:o}=r;if(o)throw o;if(!i.session)throw new It;const l=i.session;let d=null,f=null;this.flowType==="pkce"&&e.email!=null&&([d,f]=await Jn(this.storage,this.storageKey));const{data:m,error:v}=await fe(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:d,code_challenge_method:f}),jwt:l.access_token,xform:Cn});if(v)throw v;return l.user=m.user,await this._saveSession(l),await this._notifyAllSubscribers("USER_UPDATED",l),this._returnResult({data:{user:l.user},error:null})})}catch(r){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new It;const t=Date.now()/1e3;let r=t,i=!0,o=null;const{payload:l}=Ga(e.access_token);if(l.exp&&(r=l.exp,i=r<=t),i){const{data:d,error:f}=await this._callRefreshToken(e.refresh_token);if(f)return this._returnResult({data:{user:null,session:null},error:f});if(!d)return{data:{user:null,session:null},error:null};o=d}else{const{data:d,error:f}=await this._getUser(e.access_token);if(f)throw f;o={access_token:e.access_token,refresh_token:e.refresh_token,user:d.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(o),await this._notifyAllSubscribers("SIGNED_IN",o)}return this._returnResult({data:{user:o.user,session:o},error:null})}catch(t){if(oe(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:l,error:d}=t;if(d)throw d;e=(r=l.session)!==null&&r!==void 0?r:void 0}if(!(e!=null&&e.refresh_token))throw new It;const{data:i,error:o}=await this._callRefreshToken(e.refresh_token);return o?this._returnResult({data:{user:null,session:null},error:o}):i?this._returnResult({data:{user:i.user,session:i},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(oe(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!mt())throw new Yr("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Yr(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new ms("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Yr("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new ms("No code detected.");const{data:U,error:D}=await this._exchangeCodeForSession(e.code);if(D)throw D;const B=new URL(window.location.href);return B.searchParams.delete("code"),window.history.replaceState(window.history.state,"",B.toString()),{data:{session:U.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:i,access_token:o,refresh_token:l,expires_in:d,expires_at:f,token_type:m}=e;if(!o||!d||!l||!m)throw new Yr("No session defined in URL");const v=Math.round(Date.now()/1e3),y=parseInt(d);let _=v+y;f&&(_=parseInt(f));const C=_-v;C*1e3<=er&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${C}s, should have been closer to ${y}s`);const w=_-y;v-w>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",w,_,v):v-w<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",w,_,v);const{data:N,error:I}=await this._getUser(o);if(I)throw I;const O={provider_token:r,provider_refresh_token:i,access_token:o,expires_in:y,expires_at:_,refresh_token:l,token_type:m,user:N.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:O,redirectType:e.type},error:null})}catch(r){if(oe(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await qn(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:i,error:o}=t;if(o)return this._returnResult({error:o});const l=(r=i.session)===null||r===void 0?void 0:r.access_token;if(l){const{error:d}=await this.admin.signOut(l,e);if(d&&!(bc(d)&&(d.status===404||d.status===401||d.status===403)))return this._returnResult({error:d})}return e!=="others"&&(await this._removeSession(),await pt(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=Oc(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,i;try{const{data:{session:o},error:l}=t;if(l)throw l;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",o)),this._debug("INITIAL_SESSION","callback id",e,"session",o)}catch(o){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",o),console.error(o)}})}async resetPasswordForEmail(e,t={}){let r=null,i=null;this.flowType==="pkce"&&([r,i]=await Jn(this.storage,this.storageKey,!0));try{return await fe(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(o){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(o))return this._returnResult({data:null,error:o});throw o}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:r,error:i}=await this._useSession(async o=>{var l,d,f,m,v;const{data:y,error:_}=o;if(_)throw _;const C=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(l=e.options)===null||l===void 0?void 0:l.redirectTo,scopes:(d=e.options)===null||d===void 0?void 0:d.scopes,queryParams:(f=e.options)===null||f===void 0?void 0:f.queryParams,skipBrowserRedirect:!0});return await fe(this.fetch,"GET",C,{headers:this.headers,jwt:(v=(m=y.session)===null||m===void 0?void 0:m.access_token)!==null&&v!==void 0?v:void 0})});if(i)throw i;return mt()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),this._returnResult({data:{provider:e.provider,url:r==null?void 0:r.url},error:null})}catch(r){if(oe(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var r;try{const{error:i,data:{session:o}}=t;if(i)throw i;const{options:l,provider:d,token:f,access_token:m,nonce:v}=e,y=await fe(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=o==null?void 0:o.access_token)!==null&&r!==void 0?r:void 0,body:{provider:d,id_token:f,access_token:m,nonce:v,link_identity:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken}},xform:en}),{data:_,error:C}=y;return C?this._returnResult({data:{user:null,session:null},error:C}):!_||!_.session||!_.user?this._returnResult({data:{user:null,session:null},error:new Gn}):(_.session&&(await this._saveSession(_.session),await this._notifyAllSubscribers("USER_UPDATED",_.session)),this._returnResult({data:_,error:C}))}catch(i){if(await pt(this.storage,`${this.storageKey}-code-verifier`),oe(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,i;const{data:o,error:l}=t;if(l)throw l;return await fe(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(r=o.session)===null||r===void 0?void 0:r.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await Nc(async i=>(i>0&&await Pc(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await fe(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:en})),(i,o)=>{const l=200*Math.pow(2,i);return o&&Va(o)&&Date.now()+l-r<er})}catch(r){if(this._debug(t,"error",r),oe(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),mt()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const i=await qn(this.storage,this.storageKey);if(i&&this.userStorage){let l=await qn(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!l&&(l={user:i.user},await tr(this.userStorage,this.storageKey+"-user",l)),i.user=(e=l==null?void 0:l.user)!==null&&e!==void 0?e:Ja()}else if(i&&!i.user&&!i.user){const l=await qn(this.storage,this.storageKey+"-user");l&&(l!=null&&l.user)?(i.user=l.user,await pt(this.storage,this.storageKey+"-user"),await tr(this.storage,this.storageKey,i)):i.user=Ja()}if(this._debug(r,"session from storage",i),!this._isValidSession(i)){this._debug(r,"session is not valid"),i!==null&&await this._removeSession();return}const o=((t=i.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Wa;if(this._debug(r,`session has${o?"":" not"} expired with margin of ${Wa}s`),o){if(this.autoRefreshToken&&i.refresh_token){const{error:l}=await this._callRefreshToken(i.refresh_token);l&&(console.error(l),Va(l)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",l),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{const{data:l,error:d}=await this._getUser(i.access_token);!d&&(l!=null&&l.user)?(i.user=l.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(l){console.error("Error getting user data:",l),this._debug(r,"error getting user data, skipping SIGNED_IN notification",l)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(r,"error",i),console.error(i);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new It;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new fa;const{data:o,error:l}=await this._refreshAccessToken(e);if(l)throw l;if(!o.session)throw new It;await this._saveSession(o.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",o.session);const d={data:o.session,error:null};return this.refreshingDeferred.resolve(d),d}catch(o){if(this._debug(i,"error",o),oe(o)){const l={data:null,error:o};return Va(o)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(l),l}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(o),o}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,r=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const o=[],l=Array.from(this.stateChangeEmitters.values()).map(async d=>{try{await d.callback(e,t)}catch(f){o.push(f)}});if(await Promise.all(l),o.length>0){for(let d=0;d<o.length;d+=1)console.error(o[d]);throw o[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await pt(this.storage,`${this.storageKey}-code-verifier`);const t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await tr(this.userStorage,this.storageKey+"-user",{user:t.user});const i=Object.assign({},t);delete i.user;const o=_s(i);await tr(this.storage,this.storageKey,o)}else{const i=_s(t);await tr(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await pt(this.storage,this.storageKey),await pt(this.storage,this.storageKey+"-code-verifier"),await pt(this.storage,this.storageKey+"-user"),this.userStorage&&await pt(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&mt()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),er);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const t=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const t=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,t&&clearTimeout(t)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((r.expires_at*1e3-e)/er);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${er}ms, refresh threshold is ${oi} ticks`),i<=oi&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof io)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!mt()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const i=[`provider=${encodeURIComponent(t)}`];if(r!=null&&r.redirectTo&&i.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&i.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[o,l]=await Jn(this.storage,this.storageKey),d=new URLSearchParams({code_challenge:`${encodeURIComponent(o)}`,code_challenge_method:`${encodeURIComponent(l)}`});i.push(d.toString())}if(r!=null&&r.queryParams){const o=new URLSearchParams(r.queryParams);i.push(o.toString())}return r!=null&&r.skipBrowserRedirect&&i.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:i,error:o}=t;return o?this._returnResult({data:null,error:o}):await fe(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,i;const{data:o,error:l}=t;if(l)return this._returnResult({data:null,error:l});const d=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:f,error:m}=await fe(this.fetch,"POST",`${this.url}/factors`,{body:d,headers:this.headers,jwt:(r=o==null?void 0:o.session)===null||r===void 0?void 0:r.access_token});return m?this._returnResult({data:null,error:m}):(e.factorType==="totp"&&f.type==="totp"&&(!((i=f==null?void 0:f.totp)===null||i===void 0)&&i.qr_code)&&(f.totp.qr_code=`data:image/svg+xml;utf-8,${f.totp.qr_code}`),this._returnResult({data:f,error:null}))})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:i,error:o}=t;if(o)return this._returnResult({data:null,error:o});const l=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?cu(e.webauthn.credential_response):uu(e.webauthn.credential_response)})}:{code:e.code}),{data:d,error:f}=await fe(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:l,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return f?this._returnResult({data:null,error:f}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+d.expires_in},d)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",d),this._returnResult({data:d,error:f}))})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:i,error:o}=t;if(o)return this._returnResult({data:null,error:o});const l=await fe(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});if(l.error)return l;const{data:d}=l;if(d.type!=="webauthn")return{data:d,error:null};switch(d.webauthn.type){case"create":return{data:Object.assign(Object.assign({},d),{webauthn:Object.assign(Object.assign({},d.webauthn),{credential_options:Object.assign(Object.assign({},d.webauthn.credential_options),{publicKey:ou(d.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},d),{webauthn:Object.assign(Object.assign({},d.webauthn),{credential_options:Object.assign(Object.assign({},d.webauthn.credential_options),{publicKey:lu(d.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:r}=await this.getUser();if(r)return{data:null,error:r};const i={all:[],phone:[],totp:[],webauthn:[]};for(const o of(e=t==null?void 0:t.factors)!==null&&e!==void 0?e:[])i.all.push(o),o.status==="verified"&&i[o.factor_type].push(o);return{data:i,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:r},error:i}=await this.getSession();if(i)return this._returnResult({data:null,error:i});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:o}=Ga(r.access_token);let l=null;o.aal&&(l=o.aal);let d=l;((t=(e=r.user.factors)===null||e===void 0?void 0:e.filter(v=>v.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(d="aal2");const m=o.amr||[];return{data:{currentLevel:l,nextLevel:d,currentAuthenticationMethods:m},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:r},error:i}=t;return i?this._returnResult({data:null,error:i}):r?await fe(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:o=>({data:o,error:null})}):this._returnResult({data:null,error:new It})})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:i},error:o}=r;if(o)return this._returnResult({data:null,error:o});if(!i)return this._returnResult({data:null,error:new It});const l=await fe(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"approve"},xform:d=>({data:d,error:null})});return l.data&&l.data.redirect_url&&mt()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(l.data.redirect_url),l})}catch(r){if(oe(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:i},error:o}=r;if(o)return this._returnResult({data:null,error:o});if(!i)return this._returnResult({data:null,error:new It});const l=await fe(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:i.access_token,body:{action:"deny"},xform:d=>({data:d,error:null})});return l.data&&l.data.redirect_url&&mt()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(l.data.redirect_url),l})}catch(r){if(oe(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;return r?this._returnResult({data:null,error:r}):t?await fe(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new It})})}catch(e){if(oe(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{const{data:{session:r},error:i}=t;return i?this._returnResult({data:null,error:i}):r?(await fe(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new It})})}catch(t){if(oe(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(d=>d.kid===e);if(r)return r;const i=Date.now();if(r=this.jwks.keys.find(d=>d.kid===e),r&&this.jwks_cached_at+vc>i)return r;const{data:o,error:l}=await fe(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(l)throw l;return!o.keys||o.keys.length===0||(this.jwks=o,this.jwks_cached_at=i,r=o.keys.find(d=>d.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){const{data:C,error:w}=await this.getSession();if(w||!C.session)return this._returnResult({data:null,error:w});r=C.session.access_token}const{header:i,payload:o,signature:l,raw:{header:d,payload:f}}=Ga(r);t!=null&&t.allowExpired||Mc(o.exp);const m=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,t!=null&&t.keys?{keys:t.keys}:t==null?void 0:t.jwks);if(!m){const{error:C}=await this.getUser(r);if(C)throw C;return{data:{claims:o,header:i,signature:l},error:null}}const v=Uc(i.alg),y=await crypto.subtle.importKey("jwk",m,v,!0,["verify"]);if(!await crypto.subtle.verify(v,y,l,Ac(`${d}.${f}`)))throw new ui("Invalid JWT signature");return{data:{claims:o,header:i,signature:l},error:null}}catch(r){if(oe(r))return this._returnResult({data:null,error:r});throw r}}}Sr.nextInstanceID={};const bu=Sr,_u="2.91.1";let gr="";typeof Deno<"u"?gr="deno":typeof document<"u"?gr="web":typeof navigator<"u"&&navigator.product==="ReactNative"?gr="react-native":gr="node";const wu={"X-Client-Info":`supabase-js-${gr}/${_u}`},ku={headers:wu},Su={schema:"public"},Eu={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Cu={};function Er(n){"@babel/helpers - typeof";return Er=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Er(n)}function Tu(n,e){if(Er(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(Er(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Au(n){var e=Tu(n,"string");return Er(e)=="symbol"?e:e+""}function xu(n,e,t){return(e=Au(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function As(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(n,i).enumerable})),t.push.apply(t,r)}return t}function Xe(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?As(Object(t),!0).forEach(function(r){xu(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):As(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const Ou=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),$u=()=>Headers,Ru=(n,e,t)=>{const r=Ou(t),i=$u();return async(o,l)=>{var d;const f=(d=await e())!==null&&d!==void 0?d:n;let m=new i(l==null?void 0:l.headers);return m.has("apikey")||m.set("apikey",n),m.has("Authorization")||m.set("Authorization",`Bearer ${f}`),r(o,Xe(Xe({},l),{},{headers:m}))}};function Pu(n){return n.endsWith("/")?n:n+"/"}function Nu(n,e){var t,r;const{db:i,auth:o,realtime:l,global:d}=n,{db:f,auth:m,realtime:v,global:y}=e,_={db:Xe(Xe({},f),i),auth:Xe(Xe({},m),o),realtime:Xe(Xe({},v),l),storage:{},global:Xe(Xe(Xe({},y),d),{},{headers:Xe(Xe({},(t=y==null?void 0:y.headers)!==null&&t!==void 0?t:{}),(r=d==null?void 0:d.headers)!==null&&r!==void 0?r:{})}),accessToken:async()=>""};return n.accessToken?_.accessToken=n.accessToken:delete _.accessToken,_}function Iu(n){const e=n==null?void 0:n.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Pu(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var ju=class extends bu{constructor(n){super(n)}},Lu=class{constructor(n,e,t){var r,i;this.supabaseUrl=n,this.supabaseKey=e;const o=Iu(n);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const l=`sb-${o.hostname.split(".")[0]}-auth-token`,d={db:Su,realtime:Cu,auth:Xe(Xe({},Eu),{},{storageKey:l}),global:ku},f=Nu(t??{},d);if(this.storageKey=(r=f.auth.storageKey)!==null&&r!==void 0?r:"",this.headers=(i=f.global.headers)!==null&&i!==void 0?i:{},f.accessToken)this.accessToken=f.accessToken,this.auth=new Proxy({},{get:(v,y)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(y)} is not possible`)}});else{var m;this.auth=this._initSupabaseAuthClient((m=f.auth)!==null&&m!==void 0?m:{},this.headers,f.global.fetch)}this.fetch=Ru(e,this._getAccessToken.bind(this),f.global.fetch),this.realtime=this._initRealtimeClient(Xe({headers:this.headers,accessToken:this._getAccessToken.bind(this)},f.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(v=>this.realtime.setAuth(v)).catch(v=>console.warn("Failed to set initial Realtime auth token:",v)),this.rest=new ml(new URL("rest/v1",o).href,{headers:this.headers,schema:f.db.schema,fetch:this.fetch}),this.storage=new hc(this.storageUrl.href,this.headers,this.fetch,t==null?void 0:t.storage),f.accessToken||this._listenForAuthEvents()}get functions(){return new ul(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(n){return this.rest.from(n)}schema(n){return this.rest.schema(n)}rpc(n,e={},t={head:!1,get:!1,count:void 0}){return this.rest.rpc(n,e,t)}channel(n,e={config:{}}){return this.realtime.channel(n,e)}getChannels(){return this.realtime.getChannels()}removeChannel(n){return this.realtime.removeChannel(n)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var n=this,e,t;if(n.accessToken)return await n.accessToken();const{data:r}=await n.auth.getSession();return(e=(t=r.session)===null||t===void 0?void 0:t.access_token)!==null&&e!==void 0?e:n.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:i,storageKey:o,flowType:l,lock:d,debug:f,throwOnError:m},v,y){const _={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new ju({url:this.authUrl.href,headers:Xe(Xe({},_),v),storageKey:o,autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:i,flowType:l,lock:d,debug:f,throwOnError:m,fetch:y,hasCustomAuthorizationHeader:Object.keys(this.headers).some(C=>C.toLowerCase()==="authorization")})}_initRealtimeClient(n){return new Pl(this.realtimeUrl.href,Xe(Xe({},n),{},{params:Xe(Xe({},{apikey:this.supabaseKey}),n==null?void 0:n.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((n,e)=>{this._handleTokenChanged(n,"CLIENT",e==null?void 0:e.access_token)})}_handleTokenChanged(n,e,t){(n==="TOKEN_REFRESHED"||n==="SIGNED_IN")&&this.changedAccessToken!==t?(this.changedAccessToken=t,this.realtime.setAuth(t)):n==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const qu=(n,e,t)=>new Lu(n,e,t);function Du(){if(typeof window<"u")return!1;const n=globalThis.process;if(!n)return!1;const e=n.version;if(e==null)return!1;const t=e.match(/^v(\d+)\./);return t?parseInt(t[1],10)<=18:!1}Du()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Bu="https://alkjydvhfeaoyydldesp.supabase.co",Mu="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsa2p5ZHZoZmVhb3l5ZGxkZXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MjEwMjksImV4cCI6MjA4NDk5NzAyOX0.RxY5idXs54mxlW43AMr3TVQphyFJ89qirD_Hu9MYHvo",Ie=qu(Bu,Mu);async function Uu(){var e;const{data:n}=await Ie.auth.getSession();zt({user:((e=n.session)==null?void 0:e.user)??null}),Ie.auth.onAuthStateChange((t,r)=>{r!=null&&r.user?zt({user:r.user}):Zo()})}async function lo(n){var e;n&&await Ie.from("profiles").upsert({id:n.id,display_name:((e=n.user_metadata)==null?void 0:e.display_name)??""})}async function Fu(){await Ie.auth.signOut()}function Ku(n){n.innerHTML=`
    <section class="card login-card">
      <h2>Accedi</h2>
      <p>Usa email e password per entrare o creare l'account.</p>
      <form data-login-form>
        <label class="field">
          <span>Email</span>
          <input type="email" name="email" required placeholder="nome@email.it" />
        </label>
        <label class="field">
          <span>Password</span>
          <input type="password" name="password" required minlength="6" />
        </label>
        <label class="checkbox">
          <input type="checkbox" name="signup" />
          <span>Nuovo account</span>
        </label>
        <button class="primary" type="submit">Continua</button>
      </form>
    </section>
  `;const e=n.querySelector("[data-login-form]");e.addEventListener("submit",async t=>{t.preventDefault();const r=new FormData(e),i=String(r.get("email")),o=String(r.get("password")),l=r.get("signup")==="on";try{const d=l?await Ie.auth.signUp({email:i,password:o}):await Ie.auth.signInWithPassword({email:i,password:o});if(d.error)throw d.error;const f=d.data.user;f&&(zt({user:f}),await lo(f),window.location.hash="#/home")}catch(d){le(d.message??"Errore login","error")}})}async function co(n){const{data:e,error:t}=await Ie.from("characters").select("*").eq("user_id",n).order("created_at",{ascending:!0});if(t)throw t;return e??[]}async function zu(n){const{data:e,error:t}=await Ie.from("characters").insert(n).select("*").single();if(t)throw t;return e}async function uo(n,e){const{data:t,error:r}=await Ie.from("characters").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Hu(n,e){var f;const{data:t,error:r}=await Ie.from("resources").select("*").eq("character_id",n);if(r)throw r;const o=(t??[]).map(m=>{const v=Number(m.max_uses)||0,y=Number(m.used)||0;if(v===0||y===0||m.reset_on==="none"||m.reset_on===null)return null;const _=m.recovery_short===null||m.recovery_short===""?NaN:Number(m.recovery_short),C=m.recovery_long===null||m.recovery_long===""?NaN:Number(m.recovery_long),w=m.reset_on==="short_rest"?v:0,N=m.reset_on==="long_rest"?v:0,I=Number.isNaN(_)?w:_,O=Number.isNaN(C)?N:C;if(e==="short_rest"&&m.reset_on!=="short_rest")return null;const D=e==="short_rest"||e==="long_rest"&&m.reset_on==="short_rest"?I:O;if(!D)return null;const B=Math.max(y-D,0);return B===y?null:{id:m.id,used:B}}).filter(Boolean);if(!o.length)return;const d=(f=(await Promise.all(o.map(m=>Ie.from("resources").update({used:m.used}).eq("id",m.id)))).find(m=>m.error))==null?void 0:f.error;if(d)throw d}async function ho(n){const{data:e,error:t}=await Ie.from("resources").select("*").eq("character_id",n).order("created_at",{ascending:!0});if(t)throw t;return e??[]}async function Wu(n){const{data:e,error:t}=await Ie.from("resources").insert(n).select("*").single();if(t)throw t;return e}async function fo(n,e){const{data:t,error:r}=await Ie.from("resources").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Vu(n){const{error:e}=await Ie.from("resources").delete().eq("id",n);if(e)throw e}async function po(n){const{data:e,error:t}=await Ie.from("items").select("*").eq("character_id",n).order("created_at",{ascending:!0});if(t)throw t;return e??[]}async function mo(n){const{data:e,error:t}=await Ie.from("items").insert(n).select("*").single();if(t)throw t;return e}async function Zr(n,e){const{data:t,error:r}=await Ie.from("items").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Gu(n){const{error:e}=await Ie.from("items").delete().eq("id",n);if(e)throw e}var xs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ju(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var go={exports:{}};(function(n,e){(function(t,r){n.exports=r()})(xs,function(){var t=function(a,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(c,u){c.__proto__=u}||function(c,u){for(var h in u)Object.prototype.hasOwnProperty.call(u,h)&&(c[h]=u[h])})(a,s)},r=function(){return(r=Object.assign||function(a){for(var s,c=1,u=arguments.length;c<u;c++)for(var h in s=arguments[c])Object.prototype.hasOwnProperty.call(s,h)&&(a[h]=s[h]);return a}).apply(this,arguments)};function i(a,s,c){for(var u,h=0,p=s.length;h<p;h++)!u&&h in s||((u=u||Array.prototype.slice.call(s,0,h))[h]=s[h]);return a.concat(u||Array.prototype.slice.call(s))}var o=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:xs,l=Object.keys,d=Array.isArray;function f(a,s){return typeof s!="object"||l(s).forEach(function(c){a[c]=s[c]}),a}typeof Promise>"u"||o.Promise||(o.Promise=Promise);var m=Object.getPrototypeOf,v={}.hasOwnProperty;function y(a,s){return v.call(a,s)}function _(a,s){typeof s=="function"&&(s=s(m(a))),(typeof Reflect>"u"?l:Reflect.ownKeys)(s).forEach(function(c){w(a,c,s[c])})}var C=Object.defineProperty;function w(a,s,c,u){C(a,s,f(c&&y(c,"get")&&typeof c.get=="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},u))}function N(a){return{from:function(s){return a.prototype=Object.create(s.prototype),w(a.prototype,"constructor",a),{extend:_.bind(null,a.prototype)}}}}var I=Object.getOwnPropertyDescriptor,O=[].slice;function U(a,s,c){return O.call(a,s,c)}function D(a,s){return s(a)}function B(a){if(!a)throw new Error("Assertion Failed")}function K(a){o.setImmediate?setImmediate(a):setTimeout(a,0)}function M(a,s){if(typeof s=="string"&&y(a,s))return a[s];if(!s)return a;if(typeof s!="string"){for(var c=[],u=0,h=s.length;u<h;++u){var p=M(a,s[u]);c.push(p)}return c}var g=s.indexOf(".");if(g!==-1){var b=a[s.substr(0,g)];return b==null?void 0:M(b,s.substr(g+1))}}function L(a,s,c){if(a&&s!==void 0&&!("isFrozen"in Object&&Object.isFrozen(a)))if(typeof s!="string"&&"length"in s){B(typeof c!="string"&&"length"in c);for(var u=0,h=s.length;u<h;++u)L(a,s[u],c[u])}else{var p,g,b=s.indexOf(".");b!==-1?(p=s.substr(0,b),(g=s.substr(b+1))===""?c===void 0?d(a)&&!isNaN(parseInt(p))?a.splice(p,1):delete a[p]:a[p]=c:L(b=!(b=a[p])||!y(a,p)?a[p]={}:b,g,c)):c===void 0?d(a)&&!isNaN(parseInt(s))?a.splice(s,1):delete a[s]:a[s]=c}}function te(a){var s,c={};for(s in a)y(a,s)&&(c[s]=a[s]);return c}var ne=[].concat;function we(a){return ne.apply([],a)}var Ze="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(we([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(s){return s+a+"Array"})}))).filter(function(a){return o[a]}),me=new Set(Ze.map(function(a){return o[a]})),he=null;function ge(a){return he=new WeakMap,a=function s(c){if(!c||typeof c!="object")return c;var u=he.get(c);if(u)return u;if(d(c)){u=[],he.set(c,u);for(var h=0,p=c.length;h<p;++h)u.push(s(c[h]))}else if(me.has(c.constructor))u=c;else{var g,b=m(c);for(g in u=b===Object.prototype?{}:Object.create(b),he.set(c,u),c)y(c,g)&&(u[g]=s(c[g]))}return u}(a),he=null,a}var qe={}.toString;function Be(a){return qe.call(a).slice(8,-1)}var Me=typeof Symbol<"u"?Symbol.iterator:"@@iterator",se=typeof Me=="symbol"?function(a){var s;return a!=null&&(s=a[Me])&&s.apply(a)}:function(){return null};function ve(a,s){return s=a.indexOf(s),0<=s&&a.splice(s,1),0<=s}var be={};function Te(a){var s,c,u,h;if(arguments.length===1){if(d(a))return a.slice();if(this===be&&typeof a=="string")return[a];if(h=se(a)){for(c=[];!(u=h.next()).done;)c.push(u.value);return c}if(a==null)return[a];if(typeof(s=a.length)!="number")return[a];for(c=new Array(s);s--;)c[s]=a[s];return c}for(s=arguments.length,c=new Array(s);s--;)c[s]=arguments[s];return c}var We=typeof Symbol<"u"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},He=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ft=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(He),At={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Ve(a,s){this.name=a,this.message=s}function gt(a,s){return a+". Errors: "+Object.keys(s).map(function(c){return s[c].toString()}).filter(function(c,u,h){return h.indexOf(c)===u}).join(`
`)}function Qe(a,s,c,u){this.failures=s,this.failedKeys=u,this.successCount=c,this.message=gt(a,s)}function Ge(a,s){this.name="BulkError",this.failures=Object.keys(s).map(function(c){return s[c]}),this.failuresByPos=s,this.message=gt(a,this.failures)}N(Ve).from(Error).extend({toString:function(){return this.name+": "+this.message}}),N(Qe).from(Ve),N(Ge).from(Ve);var Bt=Ft.reduce(function(a,s){return a[s]=s+"Error",a},{}),Ht=Ve,re=Ft.reduce(function(a,s){var c=s+"Error";function u(h,p){this.name=c,h?typeof h=="string"?(this.message="".concat(h).concat(p?`
 `+p:""),this.inner=p||null):typeof h=="object"&&(this.message="".concat(h.name," ").concat(h.message),this.inner=h):(this.message=At[s]||c,this.inner=null)}return N(u).from(Ht),a[s]=u,a},{});re.Syntax=SyntaxError,re.Type=TypeError,re.Range=RangeError;var Mt=He.reduce(function(a,s){return a[s+"Error"]=re[s],a},{}),Ot=Ft.reduce(function(a,s){return["Syntax","Type","Range"].indexOf(s)===-1&&(a[s+"Error"]=re[s]),a},{});function Se(){}function ct(a){return a}function Ee(a,s){return a==null||a===ct?s:function(c){return s(a(c))}}function dt(a,s){return function(){a.apply(this,arguments),s.apply(this,arguments)}}function vt(a,s){return a===Se?s:function(){var c=a.apply(this,arguments);c!==void 0&&(arguments[0]=c);var u=this.onsuccess,h=this.onerror;this.onsuccess=null,this.onerror=null;var p=s.apply(this,arguments);return u&&(this.onsuccess=this.onsuccess?dt(u,this.onsuccess):u),h&&(this.onerror=this.onerror?dt(h,this.onerror):h),p!==void 0?p:c}}function Wt(a,s){return a===Se?s:function(){a.apply(this,arguments);var c=this.onsuccess,u=this.onerror;this.onsuccess=this.onerror=null,s.apply(this,arguments),c&&(this.onsuccess=this.onsuccess?dt(c,this.onsuccess):c),u&&(this.onerror=this.onerror?dt(u,this.onerror):u)}}function sn(a,s){return a===Se?s:function(c){var u=a.apply(this,arguments);f(c,u);var h=this.onsuccess,p=this.onerror;return this.onsuccess=null,this.onerror=null,c=s.apply(this,arguments),h&&(this.onsuccess=this.onsuccess?dt(h,this.onsuccess):h),p&&(this.onerror=this.onerror?dt(p,this.onerror):p),u===void 0?c===void 0?void 0:c:f(u,c)}}function Vt(a,s){return a===Se?s:function(){return s.apply(this,arguments)!==!1&&a.apply(this,arguments)}}function St(a,s){return a===Se?s:function(){var c=a.apply(this,arguments);if(c&&typeof c.then=="function"){for(var u=this,h=arguments.length,p=new Array(h);h--;)p[h]=arguments[h];return c.then(function(){return s.apply(u,p)})}return s.apply(this,arguments)}}Ot.ModifyError=Qe,Ot.DexieError=Ve,Ot.BulkError=Ge;var Je=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Ut(a){Je=a}var Oe={},Fe=100,Ze=typeof Promise>"u"?[]:function(){var a=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[a,m(a),a];var s=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[s,m(s),a]}(),He=Ze[0],Ft=Ze[1],Ze=Ze[2],Ft=Ft&&Ft.then,De=He&&He.constructor,un=!!Ze,Gt=function(a,s){xe.push([a,s]),ce&&(queueMicrotask(bn),ce=!1)},ht=!0,ce=!0,$t=[],Pe=[],dn=ct,V={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Se,pgp:!1,env:{},finalize:Se},H=V,xe=[],Ue=0,it=[];function Y(a){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var s=this._PSD=H;if(typeof a!="function"){if(a!==Oe)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&yt(this,this._value))}this._state=null,this._value=null,++s.ref,function c(u,h){try{h(function(p){if(u._state===null){if(p===u)throw new TypeError("A promise cannot be resolved with itself.");var g=u._lib&&Qt();p&&typeof p.then=="function"?c(u,function(b,S){p instanceof Y?p._then(b,S):p.then(b,S)}):(u._state=!0,u._value=p,Yt(u)),g&&Xt()}},yt.bind(null,u))}catch(p){yt(u,p)}}(this,a)}var Rt={get:function(){var a=H,s=On;function c(u,h){var p=this,g=!a.global&&(a!==H||s!==On),b=g&&!Re(),S=new Y(function(E,$){ft(p,new Jt(Ti(u,a,g,b),Ti(h,a,g,b),E,$,a))});return this._consoleTask&&(S._consoleTask=this._consoleTask),S}return c.prototype=Oe,c},set:function(a){w(this,"then",a&&a.prototype===Oe?Rt:{get:function(){return a},set:Rt.set})}};function Jt(a,s,c,u,h){this.onFulfilled=typeof a=="function"?a:null,this.onRejected=typeof s=="function"?s:null,this.resolve=c,this.reject=u,this.psd=h}function yt(a,s){var c,u;Pe.push(s),a._state===null&&(c=a._lib&&Qt(),s=dn(s),a._state=!1,a._value=s,u=a,$t.some(function(h){return h._value===u._value})||$t.push(u),Yt(a),c&&Xt())}function Yt(a){var s=a._listeners;a._listeners=[];for(var c=0,u=s.length;c<u;++c)ft(a,s[c]);var h=a._PSD;--h.ref||h.finalize(),Ue===0&&(++Ue,Gt(function(){--Ue==0&&_n()},[]))}function ft(a,s){if(a._state!==null){var c=a._state?s.onFulfilled:s.onRejected;if(c===null)return(a._state?s.resolve:s.reject)(a._value);++s.psd.ref,++Ue,Gt(Le,[c,a,s])}else a._listeners.push(s)}function Le(a,s,c){try{var u,h=s._value;!s._state&&Pe.length&&(Pe=[]),u=Je&&s._consoleTask?s._consoleTask.run(function(){return a(h)}):a(h),s._state||Pe.indexOf(h)!==-1||function(p){for(var g=$t.length;g;)if($t[--g]._value===p._value)return $t.splice(g,1)}(s),c.resolve(u)}catch(p){c.reject(p)}finally{--Ue==0&&_n(),--c.psd.ref||c.psd.finalize()}}function bn(){$n(V,function(){Qt()&&Xt()})}function Qt(){var a=ht;return ce=ht=!1,a}function Xt(){var a,s,c;do for(;0<xe.length;)for(a=xe,xe=[],c=a.length,s=0;s<c;++s){var u=a[s];u[0].apply(null,u[1])}while(0<xe.length);ce=ht=!0}function _n(){var a=$t;$t=[],a.forEach(function(u){u._PSD.onunhandled.call(null,u._value,u)});for(var s=it.slice(0),c=s.length;c;)s[--c]()}function hn(a){return new Y(Oe,!1,a)}function je(a,s){var c=H;return function(){var u=Qt(),h=H;try{return Zt(c,!0),a.apply(this,arguments)}catch(p){s&&s(p)}finally{Zt(h,!1),u&&Xt()}}}_(Y.prototype,{then:Rt,_then:function(a,s){ft(this,new Jt(null,null,a,s,H))},catch:function(a){if(arguments.length===1)return this.then(null,a);var s=a,c=arguments[1];return typeof s=="function"?this.then(null,function(u){return(u instanceof s?c:hn)(u)}):this.then(null,function(u){return(u&&u.name===s?c:hn)(u)})},finally:function(a){return this.then(function(s){return Y.resolve(a()).then(function(){return s})},function(s){return Y.resolve(a()).then(function(){return hn(s)})})},timeout:function(a,s){var c=this;return a<1/0?new Y(function(u,h){var p=setTimeout(function(){return h(new re.Timeout(s))},a);c.then(u,h).finally(clearTimeout.bind(null,p))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&w(Y.prototype,Symbol.toStringTag,"Dexie.Promise"),V.env=Ci(),_(Y,{all:function(){var a=Te.apply(null,arguments).map(tt);return new Y(function(s,c){a.length===0&&s([]);var u=a.length;a.forEach(function(h,p){return Y.resolve(h).then(function(g){a[p]=g,--u||s(a)},c)})})},resolve:function(a){return a instanceof Y?a:a&&typeof a.then=="function"?new Y(function(s,c){a.then(s,c)}):new Y(Oe,!0,a)},reject:hn,race:function(){var a=Te.apply(null,arguments).map(tt);return new Y(function(s,c){a.map(function(u){return Y.resolve(u).then(s,c)})})},PSD:{get:function(){return H},set:function(a){return H=a}},totalEchoes:{get:function(){return On}},newPSD:ue,usePSD:$n,scheduler:{get:function(){return Gt},set:function(a){Gt=a}},rejectionMapper:{get:function(){return dn},set:function(a){dn=a}},follow:function(a,s){return new Y(function(c,u){return ue(function(h,p){var g=H;g.unhandleds=[],g.onunhandled=p,g.finalize=dt(function(){var b,S=this;b=function(){S.unhandleds.length===0?h():p(S.unhandleds[0])},it.push(function E(){b(),it.splice(it.indexOf(E),1)}),++Ue,Gt(function(){--Ue==0&&_n()},[])},g.finalize),a()},s,c,u)})}}),De&&(De.allSettled&&w(Y,"allSettled",function(){var a=Te.apply(null,arguments).map(tt);return new Y(function(s){a.length===0&&s([]);var c=a.length,u=new Array(c);a.forEach(function(h,p){return Y.resolve(h).then(function(g){return u[p]={status:"fulfilled",value:g}},function(g){return u[p]={status:"rejected",reason:g}}).then(function(){return--c||s(u)})})})}),De.any&&typeof AggregateError<"u"&&w(Y,"any",function(){var a=Te.apply(null,arguments).map(tt);return new Y(function(s,c){a.length===0&&c(new AggregateError([]));var u=a.length,h=new Array(u);a.forEach(function(p,g){return Y.resolve(p).then(function(b){return s(b)},function(b){h[g]=b,--u||c(new AggregateError(h))})})})}),De.withResolvers&&(Y.withResolvers=De.withResolvers));var et={awaits:0,echoes:0,id:0},xr=0,An=[],xn=0,On=0,G=0;function ue(a,s,c,u){var h=H,p=Object.create(h);return p.parent=h,p.ref=0,p.global=!1,p.id=++G,V.env,p.env=un?{Promise:Y,PromiseProp:{value:Y,configurable:!0,writable:!0},all:Y.all,race:Y.race,allSettled:Y.allSettled,any:Y.any,resolve:Y.resolve,reject:Y.reject}:{},s&&f(p,s),++h.ref,p.finalize=function(){--this.parent.ref||this.parent.finalize()},u=$n(p,a,c,u),p.ref===0&&p.finalize(),u}function $e(){return et.id||(et.id=++xr),++et.awaits,et.echoes+=Fe,et.id}function Re(){return!!et.awaits&&(--et.awaits==0&&(et.id=0),et.echoes=et.awaits*Fe,!0)}function tt(a){return et.echoes&&a&&a.constructor===De?($e(),a.then(function(s){return Re(),s},function(s){return Re(),nt(s)})):a}function pa(){var a=An[An.length-1];An.pop(),Zt(a,!1)}function Zt(a,s){var c,u=H;(s?!et.echoes||xn++&&a===H:!xn||--xn&&a===H)||queueMicrotask(s?(function(h){++On,et.echoes&&--et.echoes!=0||(et.echoes=et.awaits=et.id=0),An.push(H),Zt(h,!0)}).bind(null,a):pa),a!==H&&(H=a,u===V&&(V.env=Ci()),un&&(c=V.env.Promise,s=a.env,(u.global||a.global)&&(Object.defineProperty(o,"Promise",s.PromiseProp),c.all=s.all,c.race=s.race,c.resolve=s.resolve,c.reject=s.reject,s.allSettled&&(c.allSettled=s.allSettled),s.any&&(c.any=s.any))))}function Ci(){var a=o.Promise;return un?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(o,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function $n(a,s,c,u,h){var p=H;try{return Zt(a,!0),s(c,u,h)}finally{Zt(p,!1)}}function Ti(a,s,c,u){return typeof a!="function"?a:function(){var h=H;c&&$e(),Zt(s,!0);try{return a.apply(this,arguments)}finally{Zt(h,!1),u&&queueMicrotask(Re)}}}function ma(a){Promise===De&&et.echoes===0?xn===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}(""+Ft).indexOf("[native code]")===-1&&($e=Re=Se);var nt=Y.reject,Rn="",fn="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Ai="String expected.",Fn=[],Or="__dbnames",ga="readonly",va="readwrite";function Pn(a,s){return a?s?function(){return a.apply(this,arguments)&&s.apply(this,arguments)}:a:s}var xi={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function $r(a){return typeof a!="string"||/\./.test(a)?function(s){return s}:function(s){return s[a]===void 0&&a in s&&delete(s=ge(s))[a],s}}function Oi(){throw re.Type("Entity instances must never be new:ed. Instances are generated by the framework bypassing the constructor.")}function Ae(a,s){try{var c=$i(a),u=$i(s);if(c!==u)return c==="Array"?1:u==="Array"?-1:c==="binary"?1:u==="binary"?-1:c==="string"?1:u==="string"?-1:c==="Date"?1:u!=="Date"?NaN:-1;switch(c){case"number":case"Date":case"string":return s<a?1:a<s?-1:0;case"binary":return function(h,p){for(var g=h.length,b=p.length,S=g<b?g:b,E=0;E<S;++E)if(h[E]!==p[E])return h[E]<p[E]?-1:1;return g===b?0:g<b?-1:1}(Ri(a),Ri(s));case"Array":return function(h,p){for(var g=h.length,b=p.length,S=g<b?g:b,E=0;E<S;++E){var $=Ae(h[E],p[E]);if($!==0)return $}return g===b?0:g<b?-1:1}(a,s)}}catch{}return NaN}function $i(a){var s=typeof a;return s!="object"?s:ArrayBuffer.isView(a)?"binary":(a=Be(a),a==="ArrayBuffer"?"binary":a)}function Ri(a){return a instanceof Uint8Array?a:ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}function Rr(a,s,c){var u=a.schema.yProps;return u?(s&&0<c.numFailures&&(s=s.filter(function(h,p){return!c.failures[p]})),Promise.all(u.map(function(h){return h=h.updatesTable,s?a.db.table(h).where("k").anyOf(s).delete():a.db.table(h).clear()})).then(function(){return c})):c}var or=(Pi.prototype.execute=function(a){var s=this["@@propmod"];if(s.add!==void 0){var c=s.add;if(d(c))return i(i([],d(a)?a:[],!0),c).sort();if(typeof c=="number")return(Number(a)||0)+c;if(typeof c=="bigint")try{return BigInt(a)+c}catch{return BigInt(0)+c}throw new TypeError("Invalid term ".concat(c))}if(s.remove!==void 0){var u=s.remove;if(d(u))return d(a)?a.filter(function(h){return!u.includes(h)}).sort():[];if(typeof u=="number")return Number(a)-u;if(typeof u=="bigint")try{return BigInt(a)-u}catch{return BigInt(0)-u}throw new TypeError("Invalid subtrahend ".concat(u))}return c=(c=s.replacePrefix)===null||c===void 0?void 0:c[0],c&&typeof a=="string"&&a.startsWith(c)?s.replacePrefix[1]+a.substring(c.length):a},Pi);function Pi(a){this["@@propmod"]=a}function Ni(a,s){for(var c=l(s),u=c.length,h=!1,p=0;p<u;++p){var g=c[p],b=s[g],S=M(a,g);b instanceof or?(L(a,g,b.execute(S)),h=!0):S!==b&&(L(a,g,b),h=!0)}return h}var Ii=(Ke.prototype._trans=function(a,s,c){var u=this._tx||H.trans,h=this.name,p=Je&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(a==="readonly"?"read":"write"," ").concat(this.name));function g(E,$,k){if(!k.schema[h])throw new re.NotFound("Table "+h+" not part of transaction");return s(k.idbtrans,k)}var b=Qt();try{var S=u&&u.db._novip===this.db._novip?u===H.trans?u._promise(a,g,c):ue(function(){return u._promise(a,g,c)},{trans:u,transless:H.transless||H}):function E($,k,P,T){if($.idbdb&&($._state.openComplete||H.letThrough||$._vip)){var A=$._createTransaction(k,P,$._dbSchema);try{A.create(),$._state.PR1398_maxLoop=3}catch(x){return x.name===Bt.InvalidState&&$.isOpen()&&0<--$._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),$.close({disableAutoOpen:!1}),$.open().then(function(){return E($,k,P,T)})):nt(x)}return A._promise(k,function(x,R){return ue(function(){return H.trans=A,T(x,R,A)})}).then(function(x){if(k==="readwrite")try{A.idbtrans.commit()}catch{}return k==="readonly"?x:A._completion.then(function(){return x})})}if($._state.openComplete)return nt(new re.DatabaseClosed($._state.dbOpenError));if(!$._state.isBeingOpened){if(!$._state.autoOpen)return nt(new re.DatabaseClosed);$.open().catch(Se)}return $._state.dbReadyPromise.then(function(){return E($,k,P,T)})}(this.db,a,[this.name],g);return p&&(S._consoleTask=p,S=S.catch(function(E){return console.trace(E),nt(E)})),S}finally{b&&Xt()}},Ke.prototype.get=function(a,s){var c=this;return a&&a.constructor===Object?this.where(a).first(s):a==null?nt(new re.Type("Invalid argument to Table.get()")):this._trans("readonly",function(u){return c.core.get({trans:u,key:a}).then(function(h){return c.hook.reading.fire(h)})}).then(s)},Ke.prototype.where=function(a){if(typeof a=="string")return new this.db.WhereClause(this,a);if(d(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var s=l(a);if(s.length===1)return this.where(s[0]).equals(a[s[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(b){if(b.compound&&s.every(function(E){return 0<=b.keyPath.indexOf(E)})){for(var S=0;S<s.length;++S)if(s.indexOf(b.keyPath[S])===-1)return!1;return!0}return!1}).sort(function(b,S){return b.keyPath.length-S.keyPath.length})[0];if(c&&this.db._maxKey!==Rn){var p=c.keyPath.slice(0,s.length);return this.where(p).equals(p.map(function(S){return a[S]}))}!c&&Je&&console.warn("The query ".concat(JSON.stringify(a)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(s.join("+"),"]"));var u=this.schema.idxByName;function h(b,S){return Ae(b,S)===0}var g=s.reduce(function(k,S){var E=k[0],$=k[1],k=u[S],P=a[S];return[E||k,E||!k?Pn($,k&&k.multi?function(T){return T=M(T,S),d(T)&&T.some(function(A){return h(P,A)})}:function(T){return h(P,M(T,S))}):$]},[null,null]),p=g[0],g=g[1];return p?this.where(p.name).equals(a[p.keyPath]).filter(g):c?this.filter(g):this.where(s).equals("")},Ke.prototype.filter=function(a){return this.toCollection().and(a)},Ke.prototype.count=function(a){return this.toCollection().count(a)},Ke.prototype.offset=function(a){return this.toCollection().offset(a)},Ke.prototype.limit=function(a){return this.toCollection().limit(a)},Ke.prototype.each=function(a){return this.toCollection().each(a)},Ke.prototype.toArray=function(a){return this.toCollection().toArray(a)},Ke.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},Ke.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,d(a)?"[".concat(a.join("+"),"]"):a))},Ke.prototype.reverse=function(){return this.toCollection().reverse()},Ke.prototype.mapToClass=function(a){var s,c=this.db,u=this.name;function h(){return s!==null&&s.apply(this,arguments)||this}(this.schema.mappedClass=a).prototype instanceof Oi&&(function(S,E){if(typeof E!="function"&&E!==null)throw new TypeError("Class extends value "+String(E)+" is not a constructor or null");function $(){this.constructor=S}t(S,E),S.prototype=E===null?Object.create(E):($.prototype=E.prototype,new $)}(h,s=a),Object.defineProperty(h.prototype,"db",{get:function(){return c},enumerable:!1,configurable:!0}),h.prototype.table=function(){return u},a=h);for(var p=new Set,g=a.prototype;g;g=m(g))Object.getOwnPropertyNames(g).forEach(function(S){return p.add(S)});function b(S){if(!S)return S;var E,$=Object.create(a.prototype);for(E in S)if(!p.has(E))try{$[E]=S[E]}catch{}return $}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=b,this.hook("reading",b),a},Ke.prototype.defineClass=function(){return this.mapToClass(function(a){f(this,a)})},Ke.prototype.add=function(a,s){var c=this,u=this.schema.primKey,h=u.auto,p=u.keyPath,g=a;return p&&h&&(g=$r(p)(a)),this._trans("readwrite",function(b){return c.core.mutate({trans:b,type:"add",keys:s!=null?[s]:null,values:[g]})}).then(function(b){return b.numFailures?Y.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{L(a,p,b)}catch{}return b})},Ke.prototype.upsert=function(a,s){var c=this,u=this.schema.primKey.keyPath;return this._trans("readwrite",function(h){return c.core.get({trans:h,key:a}).then(function(p){var g=p??{};return Ni(g,s),u&&L(g,u,a),c.core.mutate({trans:h,type:"put",values:[g],keys:[a],upsert:!0,updates:{keys:[a],changeSpecs:[s]}}).then(function(b){return b.numFailures?Y.reject(b.failures[0]):!!p})})})},Ke.prototype.update=function(a,s){return typeof a!="object"||d(a)?this.where(":id").equals(a).modify(s):(a=M(a,this.schema.primKey.keyPath),a===void 0?nt(new re.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(a).modify(s))},Ke.prototype.put=function(a,s){var c=this,u=this.schema.primKey,h=u.auto,p=u.keyPath,g=a;return p&&h&&(g=$r(p)(a)),this._trans("readwrite",function(b){return c.core.mutate({trans:b,type:"put",values:[g],keys:s!=null?[s]:null})}).then(function(b){return b.numFailures?Y.reject(b.failures[0]):b.lastResult}).then(function(b){if(p)try{L(a,p,b)}catch{}return b})},Ke.prototype.delete=function(a){var s=this;return this._trans("readwrite",function(c){return s.core.mutate({trans:c,type:"delete",keys:[a]}).then(function(u){return Rr(s,[a],u)}).then(function(u){return u.numFailures?Y.reject(u.failures[0]):void 0})})},Ke.prototype.clear=function(){var a=this;return this._trans("readwrite",function(s){return a.core.mutate({trans:s,type:"deleteRange",range:xi}).then(function(c){return Rr(a,null,c)})}).then(function(s){return s.numFailures?Y.reject(s.failures[0]):void 0})},Ke.prototype.bulkGet=function(a){var s=this;return this._trans("readonly",function(c){return s.core.getMany({keys:a,trans:c}).then(function(u){return u.map(function(h){return s.hook.reading.fire(h)})})})},Ke.prototype.bulkAdd=function(a,s,c){var u=this,h=Array.isArray(s)?s:void 0,p=(c=c||(h?void 0:s))?c.allKeys:void 0;return this._trans("readwrite",function(g){var E=u.schema.primKey,b=E.auto,E=E.keyPath;if(E&&h)throw new re.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new re.InvalidArgument("Arguments objects and keys must have the same length");var S=a.length,E=E&&b?a.map($r(E)):a;return u.core.mutate({trans:g,type:"add",keys:h,values:E,wantResults:p}).then(function(A){var k=A.numFailures,P=A.results,T=A.lastResult,A=A.failures;if(k===0)return p?P:T;throw new Ge("".concat(u.name,".bulkAdd(): ").concat(k," of ").concat(S," operations failed"),A)})})},Ke.prototype.bulkPut=function(a,s,c){var u=this,h=Array.isArray(s)?s:void 0,p=(c=c||(h?void 0:s))?c.allKeys:void 0;return this._trans("readwrite",function(g){var E=u.schema.primKey,b=E.auto,E=E.keyPath;if(E&&h)throw new re.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(h&&h.length!==a.length)throw new re.InvalidArgument("Arguments objects and keys must have the same length");var S=a.length,E=E&&b?a.map($r(E)):a;return u.core.mutate({trans:g,type:"put",keys:h,values:E,wantResults:p}).then(function(A){var k=A.numFailures,P=A.results,T=A.lastResult,A=A.failures;if(k===0)return p?P:T;throw new Ge("".concat(u.name,".bulkPut(): ").concat(k," of ").concat(S," operations failed"),A)})})},Ke.prototype.bulkUpdate=function(a){var s=this,c=this.core,u=a.map(function(g){return g.key}),h=a.map(function(g){return g.changes}),p=[];return this._trans("readwrite",function(g){return c.getMany({trans:g,keys:u,cache:"clone"}).then(function(b){var S=[],E=[];a.forEach(function(k,P){var T=k.key,A=k.changes,x=b[P];if(x){for(var R=0,j=Object.keys(A);R<j.length;R++){var q=j[R],F=A[q];if(q===s.schema.primKey.keyPath){if(Ae(F,T)!==0)throw new re.Constraint("Cannot update primary key in bulkUpdate()")}else L(x,q,F)}p.push(P),S.push(T),E.push(x)}});var $=S.length;return c.mutate({trans:g,type:"put",keys:S,values:E,updates:{keys:u,changeSpecs:h}}).then(function(k){var P=k.numFailures,T=k.failures;if(P===0)return $;for(var A=0,x=Object.keys(T);A<x.length;A++){var R,j=x[A],q=p[Number(j)];q!=null&&(R=T[j],delete T[j],T[q]=R)}throw new Ge("".concat(s.name,".bulkUpdate(): ").concat(P," of ").concat($," operations failed"),T)})})})},Ke.prototype.bulkDelete=function(a){var s=this,c=a.length;return this._trans("readwrite",function(u){return s.core.mutate({trans:u,type:"delete",keys:a}).then(function(h){return Rr(s,a,h)})}).then(function(g){var h=g.numFailures,p=g.lastResult,g=g.failures;if(h===0)return p;throw new Ge("".concat(s.name,".bulkDelete(): ").concat(h," of ").concat(c," operations failed"),g)})},Ke);function Ke(){}function lr(a){function s(g,b){if(b){for(var S=arguments.length,E=new Array(S-1);--S;)E[S-1]=arguments[S];return c[g].subscribe.apply(null,E),a}if(typeof g=="string")return c[g]}var c={};s.addEventType=p;for(var u=1,h=arguments.length;u<h;++u)p(arguments[u]);return s;function p(g,b,S){if(typeof g!="object"){var E;b=b||Vt;var $={subscribers:[],fire:S=S||Se,subscribe:function(k){$.subscribers.indexOf(k)===-1&&($.subscribers.push(k),$.fire=b($.fire,k))},unsubscribe:function(k){$.subscribers=$.subscribers.filter(function(P){return P!==k}),$.fire=$.subscribers.reduce(b,S)}};return c[g]=s[g]=$}l(E=g).forEach(function(k){var P=E[k];if(d(P))p(k,E[k][0],E[k][1]);else{if(P!=="asap")throw new re.InvalidArgument("Invalid event config");var T=p(k,ct,function(){for(var A=arguments.length,x=new Array(A);A--;)x[A]=arguments[A];T.subscribers.forEach(function(R){K(function(){R.apply(null,x)})})})}})}}function cr(a,s){return N(s).from({prototype:a}),s}function Kn(a,s){return!(a.filter||a.algorithm||a.or)&&(s?a.justLimit:!a.replayFilter)}function ya(a,s){a.filter=Pn(a.filter,s)}function ba(a,s,c){var u=a.replayFilter;a.replayFilter=u?function(){return Pn(u(),s())}:s,a.justLimit=c&&!u}function Pr(a,s){if(a.isPrimKey)return s.primaryKey;var c=s.getIndexByKeyPath(a.index);if(!c)throw new re.Schema("KeyPath "+a.index+" on object store "+s.name+" is not indexed");return c}function ji(a,s,c){var u=Pr(a,s.schema);return s.openCursor({trans:c,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:u,range:a.range}})}function Nr(a,s,c,u){var h=a.replayFilter?Pn(a.filter,a.replayFilter()):a.filter;if(a.or){var p={},g=function(b,S,E){var $,k;h&&!h(S,E,function(P){return S.stop(P)},function(P){return S.fail(P)})||((k=""+($=S.primaryKey))=="[object ArrayBuffer]"&&(k=""+new Uint8Array($)),y(p,k)||(p[k]=!0,s(b,S,E)))};return Promise.all([a.or._iterate(g,c),Li(ji(a,u,c),a.algorithm,g,!a.keysOnly&&a.valueMapper)])}return Li(ji(a,u,c),Pn(a.algorithm,h),s,!a.keysOnly&&a.valueMapper)}function Li(a,s,c,u){var h=je(u?function(p,g,b){return c(u(p),g,b)}:c);return a.then(function(p){if(p)return p.start(function(){var g=function(){return p.continue()};s&&!s(p,function(b){return g=b},function(b){p.stop(b),g=Se},function(b){p.fail(b),g=Se})||h(p.value,p,function(b){return g=b}),g()})})}var $o=(Ne.prototype._read=function(a,s){var c=this._ctx;return c.error?c.table._trans(null,nt.bind(null,c.error)):c.table._trans("readonly",a).then(s)},Ne.prototype._write=function(a){var s=this._ctx;return s.error?s.table._trans(null,nt.bind(null,s.error)):s.table._trans("readwrite",a,"locked")},Ne.prototype._addAlgorithm=function(a){var s=this._ctx;s.algorithm=Pn(s.algorithm,a)},Ne.prototype._iterate=function(a,s){return Nr(this._ctx,a,s,this._ctx.table.core)},Ne.prototype.clone=function(a){var s=Object.create(this.constructor.prototype),c=Object.create(this._ctx);return a&&f(c,a),s._ctx=c,s},Ne.prototype.raw=function(){return this._ctx.valueMapper=null,this},Ne.prototype.each=function(a){var s=this._ctx;return this._read(function(c){return Nr(s,a,c,s.table.core)})},Ne.prototype.count=function(a){var s=this;return this._read(function(c){var u=s._ctx,h=u.table.core;if(Kn(u,!0))return h.count({trans:c,query:{index:Pr(u,h.schema),range:u.range}}).then(function(g){return Math.min(g,u.limit)});var p=0;return Nr(u,function(){return++p,!1},c,h).then(function(){return p})}).then(a)},Ne.prototype.sortBy=function(a,s){var c=a.split(".").reverse(),u=c[0],h=c.length-1;function p(S,E){return E?p(S[c[E]],E-1):S[u]}var g=this._ctx.dir==="next"?1:-1;function b(S,E){return Ae(p(S,h),p(E,h))*g}return this.toArray(function(S){return S.sort(b)}).then(s)},Ne.prototype.toArray=function(a){var s=this;return this._read(function(c){var u=s._ctx;if(u.dir==="next"&&Kn(u,!0)&&0<u.limit){var h=u.valueMapper,p=Pr(u,u.table.core.schema);return u.table.core.query({trans:c,limit:u.limit,values:!0,query:{index:p,range:u.range}}).then(function(b){return b=b.result,h?b.map(h):b})}var g=[];return Nr(u,function(b){return g.push(b)},c,u.table.core).then(function(){return g})},a)},Ne.prototype.offset=function(a){var s=this._ctx;return a<=0||(s.offset+=a,Kn(s)?ba(s,function(){var c=a;return function(u,h){return c===0||(c===1?--c:h(function(){u.advance(c),c=0}),!1)}}):ba(s,function(){var c=a;return function(){return--c<0}})),this},Ne.prototype.limit=function(a){return this._ctx.limit=Math.min(this._ctx.limit,a),ba(this._ctx,function(){var s=a;return function(c,u,h){return--s<=0&&u(h),0<=s}},!0),this},Ne.prototype.until=function(a,s){return ya(this._ctx,function(c,u,h){return!a(c.value)||(u(h),s)}),this},Ne.prototype.first=function(a){return this.limit(1).toArray(function(s){return s[0]}).then(a)},Ne.prototype.last=function(a){return this.reverse().first(a)},Ne.prototype.filter=function(a){var s;return ya(this._ctx,function(c){return a(c.value)}),(s=this._ctx).isMatch=Pn(s.isMatch,a),this},Ne.prototype.and=function(a){return this.filter(a)},Ne.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)},Ne.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Ne.prototype.desc=function(){return this.reverse()},Ne.prototype.eachKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(c,u){a(u.key,u)})},Ne.prototype.eachUniqueKey=function(a){return this._ctx.unique="unique",this.eachKey(a)},Ne.prototype.eachPrimaryKey=function(a){var s=this._ctx;return s.keysOnly=!s.isMatch,this.each(function(c,u){a(u.primaryKey,u)})},Ne.prototype.keys=function(a){var s=this._ctx;s.keysOnly=!s.isMatch;var c=[];return this.each(function(u,h){c.push(h.key)}).then(function(){return c}).then(a)},Ne.prototype.primaryKeys=function(a){var s=this._ctx;if(s.dir==="next"&&Kn(s,!0)&&0<s.limit)return this._read(function(u){var h=Pr(s,s.table.core.schema);return s.table.core.query({trans:u,values:!1,limit:s.limit,query:{index:h,range:s.range}})}).then(function(u){return u.result}).then(a);s.keysOnly=!s.isMatch;var c=[];return this.each(function(u,h){c.push(h.primaryKey)}).then(function(){return c}).then(a)},Ne.prototype.uniqueKeys=function(a){return this._ctx.unique="unique",this.keys(a)},Ne.prototype.firstKey=function(a){return this.limit(1).keys(function(s){return s[0]}).then(a)},Ne.prototype.lastKey=function(a){return this.reverse().firstKey(a)},Ne.prototype.distinct=function(){var a=this._ctx,a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var s={};return ya(this._ctx,function(h){var u=h.primaryKey.toString(),h=y(s,u);return s[u]=!0,!h}),this},Ne.prototype.modify=function(a){var s=this,c=this._ctx;return this._write(function(u){var h=typeof a=="function"?a:function(x){return Ni(x,a)},p=c.table.core,E=p.schema.primaryKey,g=E.outbound,b=E.extractKey,S=200,E=s.db._options.modifyChunkSize;E&&(S=typeof E=="object"?E[p.name]||E["*"]||200:E);function $(x,q){var j=q.failures,q=q.numFailures;P+=x-q;for(var F=0,z=l(j);F<z.length;F++){var J=z[F];k.push(j[J])}}var k=[],P=0,T=[],A=a===qi;return s.clone().primaryKeys().then(function(x){function R(q){var F=Math.min(S,x.length-q),z=x.slice(q,q+F);return(A?Promise.resolve([]):p.getMany({trans:u,keys:z,cache:"immutable"})).then(function(J){var Z=[],W=[],Q=g?[]:null,ee=A?z:[];if(!A)for(var X=0;X<F;++X){var ae=J[X],_e={value:ge(ae),primKey:x[q+X]};h.call(_e,_e.value,_e)!==!1&&(_e.value==null?ee.push(x[q+X]):g||Ae(b(ae),b(_e.value))===0?(W.push(_e.value),g&&Q.push(x[q+X])):(ee.push(x[q+X]),Z.push(_e.value)))}return Promise.resolve(0<Z.length&&p.mutate({trans:u,type:"add",values:Z}).then(function(ke){for(var Ce in ke.failures)ee.splice(parseInt(Ce),1);$(Z.length,ke)})).then(function(){return(0<W.length||j&&typeof a=="object")&&p.mutate({trans:u,type:"put",keys:Q,values:W,criteria:j,changeSpec:typeof a!="function"&&a,isAdditionalChunk:0<q}).then(function(ke){return $(W.length,ke)})}).then(function(){return(0<ee.length||j&&A)&&p.mutate({trans:u,type:"delete",keys:ee,criteria:j,isAdditionalChunk:0<q}).then(function(ke){return Rr(c.table,ee,ke)}).then(function(ke){return $(ee.length,ke)})}).then(function(){return x.length>q+F&&R(q+S)})})}var j=Kn(c)&&c.limit===1/0&&(typeof a!="function"||A)&&{index:c.index,range:c.range};return R(0).then(function(){if(0<k.length)throw new Qe("Error modifying one or more objects",k,P,T);return x.length})})})},Ne.prototype.delete=function(){var a=this._ctx,s=a.range;return!Kn(a)||a.table.schema.yProps||!a.isPrimKey&&s.type!==3?this.modify(qi):this._write(function(c){var u=a.table.core.schema.primaryKey,h=s;return a.table.core.count({trans:c,query:{index:u,range:h}}).then(function(p){return a.table.core.mutate({trans:c,type:"deleteRange",range:h}).then(function(S){var b=S.failures,S=S.numFailures;if(S)throw new Qe("Could not delete some values",Object.keys(b).map(function(E){return b[E]}),p-S);return p-S})})})},Ne);function Ne(){}var qi=function(a,s){return s.value=null};function Ro(a,s){return a<s?-1:a===s?0:1}function Po(a,s){return s<a?-1:a===s?0:1}function Pt(a,s,c){return a=a instanceof Bi?new a.Collection(a):a,a._ctx.error=new(c||TypeError)(s),a}function zn(a){return new a.Collection(a,function(){return Di("")}).limit(0)}function Ir(a,s,c,u){var h,p,g,b,S,E,$,k=c.length;if(!c.every(function(A){return typeof A=="string"}))return Pt(a,Ai);function P(A){h=A==="next"?function(R){return R.toUpperCase()}:function(R){return R.toLowerCase()},p=A==="next"?function(R){return R.toLowerCase()}:function(R){return R.toUpperCase()},g=A==="next"?Ro:Po;var x=c.map(function(R){return{lower:p(R),upper:h(R)}}).sort(function(R,j){return g(R.lower,j.lower)});b=x.map(function(R){return R.upper}),S=x.map(function(R){return R.lower}),$=(E=A)==="next"?"":u}P("next"),a=new a.Collection(a,function(){return wn(b[0],S[k-1]+u)}),a._ondirectionchange=function(A){P(A)};var T=0;return a._addAlgorithm(function(A,x,R){var j=A.key;if(typeof j!="string")return!1;var q=p(j);if(s(q,S,T))return!0;for(var F=null,z=T;z<k;++z){var J=function(Z,W,Q,ee,X,ae){for(var _e=Math.min(Z.length,ee.length),ke=-1,Ce=0;Ce<_e;++Ce){var Nt=W[Ce];if(Nt!==ee[Ce])return X(Z[Ce],Q[Ce])<0?Z.substr(0,Ce)+Q[Ce]+Q.substr(Ce+1):X(Z[Ce],ee[Ce])<0?Z.substr(0,Ce)+ee[Ce]+Q.substr(Ce+1):0<=ke?Z.substr(0,ke)+W[ke]+Q.substr(ke+1):null;X(Z[Ce],Nt)<0&&(ke=Ce)}return _e<ee.length&&ae==="next"?Z+Q.substr(Z.length):_e<Z.length&&ae==="prev"?Z.substr(0,Q.length):ke<0?null:Z.substr(0,ke)+ee[ke]+Q.substr(ke+1)}(j,q,b[z],S[z],g,E);J===null&&F===null?T=z+1:(F===null||0<g(F,J))&&(F=J)}return x(F!==null?function(){A.continue(F+$)}:R),!1}),a}function wn(a,s,c,u){return{type:2,lower:a,upper:s,lowerOpen:c,upperOpen:u}}function Di(a){return{type:1,lower:a,upper:a}}var Bi=(Object.defineProperty(ut.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),ut.prototype.between=function(a,s,c,u){c=c!==!1,u=u===!0;try{return 0<this._cmp(a,s)||this._cmp(a,s)===0&&(c||u)&&(!c||!u)?zn(this):new this.Collection(this,function(){return wn(a,s,!c,!u)})}catch{return Pt(this,fn)}},ut.prototype.equals=function(a){return a==null?Pt(this,fn):new this.Collection(this,function(){return Di(a)})},ut.prototype.above=function(a){return a==null?Pt(this,fn):new this.Collection(this,function(){return wn(a,void 0,!0)})},ut.prototype.aboveOrEqual=function(a){return a==null?Pt(this,fn):new this.Collection(this,function(){return wn(a,void 0,!1)})},ut.prototype.below=function(a){return a==null?Pt(this,fn):new this.Collection(this,function(){return wn(void 0,a,!1,!0)})},ut.prototype.belowOrEqual=function(a){return a==null?Pt(this,fn):new this.Collection(this,function(){return wn(void 0,a)})},ut.prototype.startsWith=function(a){return typeof a!="string"?Pt(this,Ai):this.between(a,a+Rn,!0,!0)},ut.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):Ir(this,function(s,c){return s.indexOf(c[0])===0},[a],Rn)},ut.prototype.equalsIgnoreCase=function(a){return Ir(this,function(s,c){return s===c[0]},[a],"")},ut.prototype.anyOfIgnoreCase=function(){var a=Te.apply(be,arguments);return a.length===0?zn(this):Ir(this,function(s,c){return c.indexOf(s)!==-1},a,"")},ut.prototype.startsWithAnyOfIgnoreCase=function(){var a=Te.apply(be,arguments);return a.length===0?zn(this):Ir(this,function(s,c){return c.some(function(u){return s.indexOf(u)===0})},a,Rn)},ut.prototype.anyOf=function(){var a=this,s=Te.apply(be,arguments),c=this._cmp;try{s.sort(c)}catch{return Pt(this,fn)}if(s.length===0)return zn(this);var u=new this.Collection(this,function(){return wn(s[0],s[s.length-1])});u._ondirectionchange=function(p){c=p==="next"?a._ascending:a._descending,s.sort(c)};var h=0;return u._addAlgorithm(function(p,g,b){for(var S=p.key;0<c(S,s[h]);)if(++h===s.length)return g(b),!1;return c(S,s[h])===0||(g(function(){p.continue(s[h])}),!1)}),u},ut.prototype.notEqual=function(a){return this.inAnyRange([[-1/0,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},ut.prototype.noneOf=function(){var a=Te.apply(be,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch{return Pt(this,fn)}var s=a.reduce(function(c,u){return c?c.concat([[c[c.length-1][1],u]]):[[-1/0,u]]},null);return s.push([a[a.length-1],this.db._maxKey]),this.inAnyRange(s,{includeLowers:!1,includeUppers:!1})},ut.prototype.inAnyRange=function(j,s){var c=this,u=this._cmp,h=this._ascending,p=this._descending,g=this._min,b=this._max;if(j.length===0)return zn(this);if(!j.every(function(q){return q[0]!==void 0&&q[1]!==void 0&&h(q[0],q[1])<=0}))return Pt(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",re.InvalidArgument);var S=!s||s.includeLowers!==!1,E=s&&s.includeUppers===!0,$,k=h;function P(q,F){return k(q[0],F[0])}try{($=j.reduce(function(q,F){for(var z=0,J=q.length;z<J;++z){var Z=q[z];if(u(F[0],Z[1])<0&&0<u(F[1],Z[0])){Z[0]=g(Z[0],F[0]),Z[1]=b(Z[1],F[1]);break}}return z===J&&q.push(F),q},[])).sort(P)}catch{return Pt(this,fn)}var T=0,A=E?function(q){return 0<h(q,$[T][1])}:function(q){return 0<=h(q,$[T][1])},x=S?function(q){return 0<p(q,$[T][0])}:function(q){return 0<=p(q,$[T][0])},R=A,j=new this.Collection(this,function(){return wn($[0][0],$[$.length-1][1],!S,!E)});return j._ondirectionchange=function(q){k=q==="next"?(R=A,h):(R=x,p),$.sort(P)},j._addAlgorithm(function(q,F,z){for(var J,Z=q.key;R(Z);)if(++T===$.length)return F(z),!1;return!A(J=Z)&&!x(J)||(c._cmp(Z,$[T][1])===0||c._cmp(Z,$[T][0])===0||F(function(){k===h?q.continue($[T][0]):q.continue($[T][1])}),!1)}),j},ut.prototype.startsWithAnyOf=function(){var a=Te.apply(be,arguments);return a.every(function(s){return typeof s=="string"})?a.length===0?zn(this):this.inAnyRange(a.map(function(s){return[s,s+Rn]})):Pt(this,"startsWithAnyOf() only works with strings")},ut);function ut(){}function on(a){return je(function(s){return ur(s),a(s.target.error),!1})}function ur(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var dr="storagemutated",_a="x-storagemutated-1",kn=lr(null,dr),No=(ln.prototype._lock=function(){return B(!H.global),++this._reculock,this._reculock!==1||H.global||(H.lockOwnerFor=this),this},ln.prototype._unlock=function(){if(B(!H.global),--this._reculock==0)for(H.global||(H.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{$n(a[1],a[0])}catch{}}return this},ln.prototype._locked=function(){return this._reculock&&H.lockOwnerFor!==this},ln.prototype.create=function(a){var s=this;if(!this.mode)return this;var c=this.db.idbdb,u=this.db._state.dbOpenError;if(B(!this.idbtrans),!a&&!c)switch(u&&u.name){case"DatabaseClosedError":throw new re.DatabaseClosed(u);case"MissingAPIError":throw new re.MissingAPI(u.message,u);default:throw new re.OpenFailed(u)}if(!this.active)throw new re.TransactionInactive;return B(this._completion._state===null),(a=this.idbtrans=a||(this.db.core||c).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=je(function(h){ur(h),s._reject(a.error)}),a.onabort=je(function(h){ur(h),s.active&&s._reject(new re.Abort(a.error)),s.active=!1,s.on("abort").fire(h)}),a.oncomplete=je(function(){s.active=!1,s._resolve(),"mutatedParts"in a&&kn.storagemutated.fire(a.mutatedParts)}),this},ln.prototype._promise=function(a,s,c){var u=this;if(a==="readwrite"&&this.mode!=="readwrite")return nt(new re.ReadOnly("Transaction is readonly"));if(!this.active)return nt(new re.TransactionInactive);if(this._locked())return new Y(function(p,g){u._blockedFuncs.push([function(){u._promise(a,s,c).then(p,g)},H])});if(c)return ue(function(){var p=new Y(function(g,b){u._lock();var S=s(g,b,u);S&&S.then&&S.then(g,b)});return p.finally(function(){return u._unlock()}),p._lib=!0,p});var h=new Y(function(p,g){var b=s(p,g,u);b&&b.then&&b.then(p,g)});return h._lib=!0,h},ln.prototype._root=function(){return this.parent?this.parent._root():this},ln.prototype.waitFor=function(a){var s,c=this._root(),u=Y.resolve(a);c._waitingFor?c._waitingFor=c._waitingFor.then(function(){return u}):(c._waitingFor=u,c._waitingQueue=[],s=c.idbtrans.objectStore(c.storeNames[0]),function p(){for(++c._spinCount;c._waitingQueue.length;)c._waitingQueue.shift()();c._waitingFor&&(s.get(-1/0).onsuccess=p)}());var h=c._waitingFor;return new Y(function(p,g){u.then(function(b){return c._waitingQueue.push(je(p.bind(null,b)))},function(b){return c._waitingQueue.push(je(g.bind(null,b)))}).finally(function(){c._waitingFor===h&&(c._waitingFor=null)})})},ln.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new re.Abort))},ln.prototype.table=function(a){var s=this._memoizedTables||(this._memoizedTables={});if(y(s,a))return s[a];var c=this.schema[a];if(!c)throw new re.NotFound("Table "+a+" not part of transaction");return c=new this.db.Table(a,c,this),c.core=this.db.core.table(a),s[a]=c},ln);function ln(){}function wa(a,s,c,u,h,p,g,b){return{name:a,keyPath:s,unique:c,multi:u,auto:h,compound:p,src:(c&&!g?"&":"")+(u?"*":"")+(h?"++":"")+Mi(s),type:b}}function Mi(a){return typeof a=="string"?a:a?"["+[].join.call(a,"+")+"]":""}function ka(a,s,c){return{name:a,primKey:s,indexes:c,mappedClass:null,idxByName:(u=function(h){return[h.name,h]},c.reduce(function(h,p,g){return g=u(p,g),g&&(h[g[0]]=g[1]),h},{}))};var u}var hr=function(a){try{return a.only([[]]),hr=function(){return[[]]},[[]]}catch{return hr=function(){return Rn},Rn}};function Sa(a){return a==null?function(){}:typeof a=="string"?(s=a).split(".").length===1?function(c){return c[s]}:function(c){return M(c,s)}:function(c){return M(c,a)};var s}function Ui(a){return[].slice.call(a)}var Io=0;function fr(a){return a==null?":id":typeof a=="string"?a:"[".concat(a.join("+"),"]")}function jo(a,s,S){function u(R){if(R.type===3)return null;if(R.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var T=R.lower,A=R.upper,x=R.lowerOpen,R=R.upperOpen;return T===void 0?A===void 0?null:s.upperBound(A,!!R):A===void 0?s.lowerBound(T,!!x):s.bound(T,A,!!x,!!R)}function h(P){var T,A=P.name;return{name:A,schema:P,mutate:function(x){var R=x.trans,j=x.type,q=x.keys,F=x.values,z=x.range;return new Promise(function(J,Z){J=je(J);var W=R.objectStore(A),Q=W.keyPath==null,ee=j==="put"||j==="add";if(!ee&&j!=="delete"&&j!=="deleteRange")throw new Error("Invalid operation type: "+j);var X,ae=(q||F||{length:1}).length;if(q&&F&&q.length!==F.length)throw new Error("Given keys array must have same length as given values array.");if(ae===0)return J({numFailures:0,failures:{},results:[],lastResult:void 0});function _e(Et){++Nt,ur(Et)}var ke=[],Ce=[],Nt=0;if(j==="deleteRange"){if(z.type===4)return J({numFailures:Nt,failures:Ce,results:[],lastResult:void 0});z.type===3?ke.push(X=W.clear()):ke.push(X=W.delete(u(z)))}else{var Q=ee?Q?[F,q]:[F,null]:[q,null],ye=Q[0],_t=Q[1];if(ee)for(var wt=0;wt<ae;++wt)ke.push(X=_t&&_t[wt]!==void 0?W[j](ye[wt],_t[wt]):W[j](ye[wt])),X.onerror=_e;else for(wt=0;wt<ae;++wt)ke.push(X=W[j](ye[wt])),X.onerror=_e}function Wr(Et){Et=Et.target.result,ke.forEach(function(jn,Ua){return jn.error!=null&&(Ce[Ua]=jn.error)}),J({numFailures:Nt,failures:Ce,results:j==="delete"?q:ke.map(function(jn){return jn.result}),lastResult:Et})}X.onerror=function(Et){_e(Et),Wr(Et)},X.onsuccess=Wr})},getMany:function(x){var R=x.trans,j=x.keys;return new Promise(function(q,F){q=je(q);for(var z,J=R.objectStore(A),Z=j.length,W=new Array(Z),Q=0,ee=0,X=function(ke){ke=ke.target,W[ke._pos]=ke.result,++ee===Q&&q(W)},ae=on(F),_e=0;_e<Z;++_e)j[_e]!=null&&((z=J.get(j[_e]))._pos=_e,z.onsuccess=X,z.onerror=ae,++Q);Q===0&&q(W)})},get:function(x){var R=x.trans,j=x.key;return new Promise(function(q,F){q=je(q);var z=R.objectStore(A).get(j);z.onsuccess=function(J){return q(J.target.result)},z.onerror=on(F)})},query:(T=E,function(x){return new Promise(function(R,j){R=je(R);var q,F,z,Q=x.trans,J=x.values,Z=x.limit,X=x.query,W=Z===1/0?void 0:Z,ee=X.index,X=X.range,Q=Q.objectStore(A),ee=ee.isPrimaryKey?Q:Q.index(ee.name),X=u(X);if(Z===0)return R({result:[]});T?((W=J?ee.getAll(X,W):ee.getAllKeys(X,W)).onsuccess=function(ae){return R({result:ae.target.result})},W.onerror=on(j)):(q=0,F=!J&&"openKeyCursor"in ee?ee.openKeyCursor(X):ee.openCursor(X),z=[],F.onsuccess=function(ae){var _e=F.result;return _e?(z.push(J?_e.value:_e.primaryKey),++q===Z?R({result:z}):void _e.continue()):R({result:z})},F.onerror=on(j))})}),openCursor:function(x){var R=x.trans,j=x.values,q=x.query,F=x.reverse,z=x.unique;return new Promise(function(J,Z){J=je(J);var ee=q.index,W=q.range,Q=R.objectStore(A),Q=ee.isPrimaryKey?Q:Q.index(ee.name),ee=F?z?"prevunique":"prev":z?"nextunique":"next",X=!j&&"openKeyCursor"in Q?Q.openKeyCursor(u(W),ee):Q.openCursor(u(W),ee);X.onerror=on(Z),X.onsuccess=je(function(ae){var _e,ke,Ce,Nt,ye=X.result;ye?(ye.___id=++Io,ye.done=!1,_e=ye.continue.bind(ye),ke=(ke=ye.continuePrimaryKey)&&ke.bind(ye),Ce=ye.advance.bind(ye),Nt=function(){throw new Error("Cursor not stopped")},ye.trans=R,ye.stop=ye.continue=ye.continuePrimaryKey=ye.advance=function(){throw new Error("Cursor not started")},ye.fail=je(Z),ye.next=function(){var _t=this,wt=1;return this.start(function(){return wt--?_t.continue():_t.stop()}).then(function(){return _t})},ye.start=function(_t){function wt(){if(X.result)try{_t()}catch(Et){ye.fail(Et)}else ye.done=!0,ye.start=function(){throw new Error("Cursor behind last entry")},ye.stop()}var Wr=new Promise(function(Et,jn){Et=je(Et),X.onerror=on(jn),ye.fail=jn,ye.stop=function(Ua){ye.stop=ye.continue=ye.continuePrimaryKey=ye.advance=Nt,Et(Ua)}});return X.onsuccess=je(function(Et){X.onsuccess=wt,wt()}),ye.continue=_e,ye.continuePrimaryKey=ke,ye.advance=Ce,wt(),Wr},J(ye)):J(null)},Z)})},count:function(x){var R=x.query,j=x.trans,q=R.index,F=R.range;return new Promise(function(z,J){var Z=j.objectStore(A),W=q.isPrimaryKey?Z:Z.index(q.name),Z=u(F),W=Z?W.count(Z):W.count();W.onsuccess=je(function(Q){return z(Q.target.result)}),W.onerror=on(J)})}}}var p,g,b,$=(g=S,b=Ui((p=a).objectStoreNames),{schema:{name:p.name,tables:b.map(function(P){return g.objectStore(P)}).map(function(P){var T=P.keyPath,R=P.autoIncrement,A=d(T),x={},R={name:P.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:T==null,compound:A,keyPath:T,autoIncrement:R,unique:!0,extractKey:Sa(T)},indexes:Ui(P.indexNames).map(function(j){return P.index(j)}).map(function(z){var q=z.name,F=z.unique,J=z.multiEntry,z=z.keyPath,J={name:q,compound:d(z),keyPath:z,unique:F,multiEntry:J,extractKey:Sa(z)};return x[fr(z)]=J}),getIndexByKeyPath:function(j){return x[fr(j)]}};return x[":id"]=R.primaryKey,T!=null&&(x[fr(T)]=R.primaryKey),R})},hasGetAll:0<b.length&&"getAll"in g.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),S=$.schema,E=$.hasGetAll,$=S.tables.map(h),k={};return $.forEach(function(P){return k[P.name]=P}),{stack:"dbcore",transaction:a.transaction.bind(a),table:function(P){if(!k[P])throw new Error("Table '".concat(P,"' not found"));return k[P]},MIN_KEY:-1/0,MAX_KEY:hr(s),schema:S}}function Lo(a,s,c,u){var h=c.IDBKeyRange;return c.indexedDB,{dbcore:(u=jo(s,h,u),a.dbcore.reduce(function(p,g){return g=g.create,r(r({},p),g(p))},u))}}function jr(a,u){var c=u.db,u=Lo(a._middlewares,c,a._deps,u);a.core=u.dbcore,a.tables.forEach(function(h){var p=h.name;a.core.schema.tables.some(function(g){return g.name===p})&&(h.core=a.core.table(p),a[p]instanceof a.Table&&(a[p].core=h.core))})}function Lr(a,s,c,u){c.forEach(function(h){var p=u[h];s.forEach(function(g){var b=function S(E,$){return I(E,$)||(E=m(E))&&S(E,$)}(g,h);(!b||"value"in b&&b.value===void 0)&&(g===a.Transaction.prototype||g instanceof a.Transaction?w(g,h,{get:function(){return this.table(h)},set:function(S){C(this,h,{value:S,writable:!0,configurable:!0,enumerable:!0})}}):g[h]=new a.Table(h,p))})})}function Ea(a,s){s.forEach(function(c){for(var u in c)c[u]instanceof a.Table&&delete c[u]})}function qo(a,s){return a._cfg.version-s._cfg.version}function Do(a,s,c,u){var h=a._dbSchema;c.objectStoreNames.contains("$meta")&&!h.$meta&&(h.$meta=ka("$meta",Ki("")[0],[]),a._storeNames.push("$meta"));var p=a._createTransaction("readwrite",a._storeNames,h);p.create(c),p._completion.catch(u);var g=p._reject.bind(p),b=H.transless||H;ue(function(){return H.trans=p,H.transless=b,s!==0?(jr(a,c),E=s,((S=p).storeNames.includes("$meta")?S.table("$meta").get("version").then(function($){return $??E}):Y.resolve(E)).then(function($){return P=$,T=p,A=c,x=[],$=(k=a)._versions,R=k._dbSchema=Dr(0,k.idbdb,A),($=$.filter(function(j){return j._cfg.version>=P})).length!==0?($.forEach(function(j){x.push(function(){var q=R,F=j._cfg.dbschema;Br(k,q,A),Br(k,F,A),R=k._dbSchema=F;var z=Ca(q,F);z.add.forEach(function(ee){Ta(A,ee[0],ee[1].primKey,ee[1].indexes)}),z.change.forEach(function(ee){if(ee.recreate)throw new re.Upgrade("Not yet support for changing primary key");var X=A.objectStore(ee.name);ee.add.forEach(function(ae){return qr(X,ae)}),ee.change.forEach(function(ae){X.deleteIndex(ae.name),qr(X,ae)}),ee.del.forEach(function(ae){return X.deleteIndex(ae)})});var J=j._cfg.contentUpgrade;if(J&&j._cfg.version>P){jr(k,A),T._memoizedTables={};var Z=te(F);z.del.forEach(function(ee){Z[ee]=q[ee]}),Ea(k,[k.Transaction.prototype]),Lr(k,[k.Transaction.prototype],l(Z),Z),T.schema=Z;var W,Q=We(J);return Q&&$e(),z=Y.follow(function(){var ee;(W=J(T))&&Q&&(ee=Re.bind(null,null),W.then(ee,ee))}),W&&typeof W.then=="function"?Y.resolve(W):z.then(function(){return W})}}),x.push(function(q){var F,z,J=j._cfg.dbschema;F=J,z=q,[].slice.call(z.db.objectStoreNames).forEach(function(Z){return F[Z]==null&&z.db.deleteObjectStore(Z)}),Ea(k,[k.Transaction.prototype]),Lr(k,[k.Transaction.prototype],k._storeNames,k._dbSchema),T.schema=k._dbSchema}),x.push(function(q){k.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(k.idbdb.version/10)===j._cfg.version?(k.idbdb.deleteObjectStore("$meta"),delete k._dbSchema.$meta,k._storeNames=k._storeNames.filter(function(F){return F!=="$meta"})):q.objectStore("$meta").put(j._cfg.version,"version"))})}),function j(){return x.length?Y.resolve(x.shift()(T.idbtrans)).then(j):Y.resolve()}().then(function(){Fi(R,A)})):Y.resolve();var k,P,T,A,x,R}).catch(g)):(l(h).forEach(function($){Ta(c,$,h[$].primKey,h[$].indexes)}),jr(a,c),void Y.follow(function(){return a.on.populate.fire(p)}).catch(g));var S,E})}function Bo(a,s){Fi(a._dbSchema,s),s.db.version%10!=0||s.objectStoreNames.contains("$meta")||s.db.createObjectStore("$meta").add(Math.ceil(s.db.version/10-1),"version");var c=Dr(0,a.idbdb,s);Br(a,a._dbSchema,s);for(var u=0,h=Ca(c,a._dbSchema).change;u<h.length;u++){var p=function(g){if(g.change.length||g.recreate)return console.warn("Unable to patch indexes of table ".concat(g.name," because it has changes on the type of index or primary key.")),{value:void 0};var b=s.objectStore(g.name);g.add.forEach(function(S){Je&&console.debug("Dexie upgrade patch: Creating missing index ".concat(g.name,".").concat(S.src)),qr(b,S)})}(h[u]);if(typeof p=="object")return p.value}}function Ca(a,s){var c,u={del:[],add:[],change:[]};for(c in a)s[c]||u.del.push(c);for(c in s){var h=a[c],p=s[c];if(h){var g={name:c,def:p,recreate:!1,del:[],add:[],change:[]};if(""+(h.primKey.keyPath||"")!=""+(p.primKey.keyPath||"")||h.primKey.auto!==p.primKey.auto)g.recreate=!0,u.change.push(g);else{var b=h.idxByName,S=p.idxByName,E=void 0;for(E in b)S[E]||g.del.push(E);for(E in S){var $=b[E],k=S[E];$?$.src!==k.src&&g.change.push(k):g.add.push(k)}(0<g.del.length||0<g.add.length||0<g.change.length)&&u.change.push(g)}}else u.add.push([c,p])}return u}function Ta(a,s,c,u){var h=a.db.createObjectStore(s,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});return u.forEach(function(p){return qr(h,p)}),h}function Fi(a,s){l(a).forEach(function(c){s.db.objectStoreNames.contains(c)||(Je&&console.debug("Dexie: Creating missing table",c),Ta(s,c,a[c].primKey,a[c].indexes))})}function qr(a,s){a.createIndex(s.name,s.keyPath,{unique:s.unique,multiEntry:s.multi})}function Dr(a,s,c){var u={};return U(s.objectStoreNames,0).forEach(function(h){for(var p=c.objectStore(h),g=wa(Mi(E=p.keyPath),E||"",!0,!1,!!p.autoIncrement,E&&typeof E!="string",!0),b=[],S=0;S<p.indexNames.length;++S){var $=p.index(p.indexNames[S]),E=$.keyPath,$=wa($.name,E,!!$.unique,!!$.multiEntry,!1,E&&typeof E!="string",!1);b.push($)}u[h]=ka(h,g,b)}),u}function Br(a,s,c){for(var u=c.db.objectStoreNames,h=0;h<u.length;++h){var p=u[h],g=c.objectStore(p);a._hasGetAll="getAll"in g;for(var b=0;b<g.indexNames.length;++b){var S=g.indexNames[b],E=g.index(S).keyPath,$=typeof E=="string"?E:"["+U(E).join("+")+"]";!s[p]||(E=s[p].idxByName[$])&&(E.name=S,delete s[p].idxByName[$],s[p].idxByName[S]=E)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&o.WorkerGlobalScope&&o instanceof o.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function Ki(a){return a.split(",").map(function(s,c){var p=s.split(":"),u=(h=p[1])===null||h===void 0?void 0:h.trim(),h=(s=p[0].trim()).replace(/([&*]|\+\+)/g,""),p=/^\[/.test(h)?h.match(/^\[(.*)\]$/)[1].split("+"):h;return wa(h,p||null,/\&/.test(s),/\*/.test(s),/\+\+/.test(s),d(p),c===0,u)})}var Mo=(Hn.prototype._createTableSchema=ka,Hn.prototype._parseIndexSyntax=Ki,Hn.prototype._parseStoresSpec=function(a,s){var c=this;l(a).forEach(function(u){if(a[u]!==null){var h=c._parseIndexSyntax(a[u]),p=h.shift();if(!p)throw new re.Schema("Invalid schema for table "+u+": "+a[u]);if(p.unique=!0,p.multi)throw new re.Schema("Primary key cannot be multiEntry*");h.forEach(function(g){if(g.auto)throw new re.Schema("Only primary key can be marked as autoIncrement (++)");if(!g.keyPath)throw new re.Schema("Index must have a name and cannot be an empty string")}),h=c._createTableSchema(u,p,h),s[u]=h}})},Hn.prototype.stores=function(c){var s=this.db;this._cfg.storesSource=this._cfg.storesSource?f(this._cfg.storesSource,c):c;var c=s._versions,u={},h={};return c.forEach(function(p){f(u,p._cfg.storesSource),h=p._cfg.dbschema={},p._parseStoresSpec(u,h)}),s._dbSchema=h,Ea(s,[s._allTables,s,s.Transaction.prototype]),Lr(s,[s._allTables,s,s.Transaction.prototype,this._cfg.tables],l(h),h),s._storeNames=l(h),this},Hn.prototype.upgrade=function(a){return this._cfg.contentUpgrade=St(this._cfg.contentUpgrade||Se,a),this},Hn);function Hn(){}function Aa(a,s){var c=a._dbNamesDB;return c||(c=a._dbNamesDB=new pn(Or,{addons:[],indexedDB:a,IDBKeyRange:s})).version(1).stores({dbnames:"name"}),c.table("dbnames")}function xa(a){return a&&typeof a.databases=="function"}function Oa(a){return ue(function(){return H.letThrough=!0,a()})}function $a(a){return!("from"in a)}var bt=function(a,s){if(!this){var c=new bt;return a&&"d"in a&&f(c,a),c}f(this,arguments.length?{d:1,from:a,to:1<arguments.length?s:a}:{d:0})};function pr(a,s,c){var u=Ae(s,c);if(!isNaN(u)){if(0<u)throw RangeError();if($a(a))return f(a,{from:s,to:c,d:1});var h=a.l,u=a.r;if(Ae(c,a.from)<0)return h?pr(h,s,c):a.l={from:s,to:c,d:1,l:null,r:null},Hi(a);if(0<Ae(s,a.to))return u?pr(u,s,c):a.r={from:s,to:c,d:1,l:null,r:null},Hi(a);Ae(s,a.from)<0&&(a.from=s,a.l=null,a.d=u?u.d+1:1),0<Ae(c,a.to)&&(a.to=c,a.r=null,a.d=a.l?a.l.d+1:1),c=!a.r,h&&!a.l&&mr(a,h),u&&c&&mr(a,u)}}function mr(a,s){$a(s)||function c(u,S){var p=S.from,g=S.to,b=S.l,S=S.r;pr(u,p,g),b&&c(u,b),S&&c(u,S)}(a,s)}function zi(a,s){var c=Mr(s),u=c.next();if(u.done)return!1;for(var h=u.value,p=Mr(a),g=p.next(h.from),b=g.value;!u.done&&!g.done;){if(Ae(b.from,h.to)<=0&&0<=Ae(b.to,h.from))return!0;Ae(h.from,b.from)<0?h=(u=c.next(b.from)).value:b=(g=p.next(h.from)).value}return!1}function Mr(a){var s=$a(a)?null:{s:0,n:a};return{next:function(c){for(var u=0<arguments.length;s;)switch(s.s){case 0:if(s.s=1,u)for(;s.n.l&&Ae(c,s.n.from)<0;)s={up:s,n:s.n.l,s:1};else for(;s.n.l;)s={up:s,n:s.n.l,s:1};case 1:if(s.s=2,!u||Ae(c,s.n.to)<=0)return{value:s.n,done:!1};case 2:if(s.n.r){s.s=3,s={up:s,n:s.n.r,s:0};continue}case 3:s=s.up}return{done:!0}}}}function Hi(a){var s,c,u=(((s=a.r)===null||s===void 0?void 0:s.d)||0)-(((c=a.l)===null||c===void 0?void 0:c.d)||0),h=1<u?"r":u<-1?"l":"";h&&(s=h=="r"?"l":"r",c=r({},a),u=a[h],a.from=u.from,a.to=u.to,a[h]=u[h],c[h]=u[s],(a[s]=c).d=Wi(c)),a.d=Wi(a)}function Wi(c){var s=c.r,c=c.l;return(s?c?Math.max(s.d,c.d):s.d:c?c.d:0)+1}function Ur(a,s){return l(s).forEach(function(c){a[c]?mr(a[c],s[c]):a[c]=function u(h){var p,g,b={};for(p in h)y(h,p)&&(g=h[p],b[p]=!g||typeof g!="object"||me.has(g.constructor)?g:u(g));return b}(s[c])}),a}function Ra(a,s){return a.all||s.all||Object.keys(a).some(function(c){return s[c]&&zi(s[c],a[c])})}_(bt.prototype,((Ft={add:function(a){return mr(this,a),this},addKey:function(a){return pr(this,a,a),this},addKeys:function(a){var s=this;return a.forEach(function(c){return pr(s,c,c)}),this},hasKey:function(a){var s=Mr(this).next(a).value;return s&&Ae(s.from,a)<=0&&0<=Ae(s.to,a)}})[Me]=function(){return Mr(this)},Ft));var Nn={},Pa={},Na=!1;function Fr(a){Ur(Pa,a),Na||(Na=!0,setTimeout(function(){Na=!1,Ia(Pa,!(Pa={}))},0))}function Ia(a,s){s===void 0&&(s=!1);var c=new Set;if(a.all)for(var u=0,h=Object.values(Nn);u<h.length;u++)Vi(g=h[u],a,c,s);else for(var p in a){var g,b=/^idb\:\/\/(.*)\/(.*)\//.exec(p);b&&(p=b[1],b=b[2],(g=Nn["idb://".concat(p,"/").concat(b)])&&Vi(g,a,c,s))}c.forEach(function(S){return S()})}function Vi(a,s,c,u){for(var h=[],p=0,g=Object.entries(a.queries.query);p<g.length;p++){for(var b=g[p],S=b[0],E=[],$=0,k=b[1];$<k.length;$++){var P=k[$];Ra(s,P.obsSet)?P.subscribers.forEach(function(R){return c.add(R)}):u&&E.push(P)}u&&h.push([S,E])}if(u)for(var T=0,A=h;T<A.length;T++){var x=A[T],S=x[0],E=x[1];a.queries.query[S]=E}}function Uo(a){var s=a._state,c=a._deps.indexedDB;if(s.isBeingOpened||a.idbdb)return s.dbReadyPromise.then(function(){return s.dbOpenError?nt(s.dbOpenError):a});s.isBeingOpened=!0,s.dbOpenError=null,s.openComplete=!1;var u=s.openCanceller,h=Math.round(10*a.verno),p=!1;function g(){if(s.openCanceller!==u)throw new re.DatabaseClosed("db.open() was cancelled")}function b(){return new Y(function(P,T){if(g(),!c)throw new re.MissingAPI;var A=a.name,x=s.autoSchema||!h?c.open(A):c.open(A,h);if(!x)throw new re.MissingAPI;x.onerror=on(T),x.onblocked=je(a._fireOnBlocked),x.onupgradeneeded=je(function(R){var j;$=x.transaction,s.autoSchema&&!a._options.allowEmptyDB?(x.onerror=ur,$.abort(),x.result.close(),(j=c.deleteDatabase(A)).onsuccess=j.onerror=je(function(){T(new re.NoSuchDatabase("Database ".concat(A," doesnt exist")))})):($.onerror=on(T),R=R.oldVersion>Math.pow(2,62)?0:R.oldVersion,k=R<1,a.idbdb=x.result,p&&Bo(a,$),Do(a,R/10,$,T))},T),x.onsuccess=je(function(){$=null;var R,j,q,F,z,J=a.idbdb=x.result,Z=U(J.objectStoreNames);if(0<Z.length)try{var W=J.transaction((F=Z).length===1?F[0]:F,"readonly");if(s.autoSchema)j=J,q=W,(R=a).verno=j.version/10,q=R._dbSchema=Dr(0,j,q),R._storeNames=U(j.objectStoreNames,0),Lr(R,[R._allTables],l(q),q);else if(Br(a,a._dbSchema,W),((z=Ca(Dr(0,(z=a).idbdb,W),z._dbSchema)).add.length||z.change.some(function(Q){return Q.add.length||Q.change.length}))&&!p)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),J.close(),h=J.version+1,p=!0,P(b());jr(a,W)}catch{}Fn.push(a),J.onversionchange=je(function(Q){s.vcFired=!0,a.on("versionchange").fire(Q)}),J.onclose=je(function(){a.close({disableAutoOpen:!1})}),k&&(z=a._deps,W=A,J=z.indexedDB,z=z.IDBKeyRange,xa(J)||W===Or||Aa(J,z).put({name:W}).catch(Se)),P()},T)}).catch(function(P){switch(P==null?void 0:P.name){case"UnknownError":if(0<s.PR1398_maxLoop)return s.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),b();break;case"VersionError":if(0<h)return h=0,b()}return Y.reject(P)})}var S,E=s.dbReadyResolve,$=null,k=!1;return Y.race([u,(typeof navigator>"u"?Y.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(P){function T(){return indexedDB.databases().finally(P)}S=setInterval(T,100),T()}).finally(function(){return clearInterval(S)}):Promise.resolve()).then(b)]).then(function(){return g(),s.onReadyBeingFired=[],Y.resolve(Oa(function(){return a.on.ready.fire(a.vip)})).then(function P(){if(0<s.onReadyBeingFired.length){var T=s.onReadyBeingFired.reduce(St,Se);return s.onReadyBeingFired=[],Y.resolve(Oa(function(){return T(a.vip)})).then(P)}})}).finally(function(){s.openCanceller===u&&(s.onReadyBeingFired=null,s.isBeingOpened=!1)}).catch(function(P){s.dbOpenError=P;try{$&&$.abort()}catch{}return u===s.openCanceller&&a._close(),nt(P)}).finally(function(){s.openComplete=!0,E()}).then(function(){var P;return k&&(P={},a.tables.forEach(function(T){T.schema.indexes.forEach(function(A){A.name&&(P["idb://".concat(a.name,"/").concat(T.name,"/").concat(A.name)]=new bt(-1/0,[[[]]]))}),P["idb://".concat(a.name,"/").concat(T.name,"/")]=P["idb://".concat(a.name,"/").concat(T.name,"/:dels")]=new bt(-1/0,[[[]]])}),kn(dr).fire(P),Ia(P,!0)),a})}function ja(a){function s(p){return a.next(p)}var c=h(s),u=h(function(p){return a.throw(p)});function h(p){return function(S){var b=p(S),S=b.value;return b.done?S:S&&typeof S.then=="function"?S.then(c,u):d(S)?Promise.all(S).then(c,u):c(S)}}return h(s)()}function Kr(a,s,c){for(var u=d(a)?a.slice():[a],h=0;h<c;++h)u.push(s);return u}var Fo={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(a){return r(r({},a),{table:function(s){var c=a.table(s),u=c.schema,h={},p=[];function g(k,P,T){var A=fr(k),x=h[A]=h[A]||[],R=k==null?0:typeof k=="string"?1:k.length,j=0<P,j=r(r({},T),{name:j?"".concat(A,"(virtual-from:").concat(T.name,")"):T.name,lowLevelIndex:T,isVirtual:j,keyTail:P,keyLength:R,extractKey:Sa(k),unique:!j&&T.unique});return x.push(j),j.isPrimaryKey||p.push(j),1<R&&g(R===2?k[0]:k.slice(0,R-1),P+1,T),x.sort(function(q,F){return q.keyTail-F.keyTail}),j}s=g(u.primaryKey.keyPath,0,u.primaryKey),h[":id"]=[s];for(var b=0,S=u.indexes;b<S.length;b++){var E=S[b];g(E.keyPath,0,E)}function $(k){var P,T=k.query.index;return T.isVirtual?r(r({},k),{query:{index:T.lowLevelIndex,range:(P=k.query.range,T=T.keyTail,{type:P.type===1?2:P.type,lower:Kr(P.lower,P.lowerOpen?a.MAX_KEY:a.MIN_KEY,T),lowerOpen:!0,upper:Kr(P.upper,P.upperOpen?a.MIN_KEY:a.MAX_KEY,T),upperOpen:!0})}}):k}return r(r({},c),{schema:r(r({},u),{primaryKey:s,indexes:p,getIndexByKeyPath:function(k){return(k=h[fr(k)])&&k[0]}}),count:function(k){return c.count($(k))},query:function(k){return c.query($(k))},openCursor:function(k){var P=k.query.index,T=P.keyTail,A=P.isVirtual,x=P.keyLength;return A?c.openCursor($(k)).then(function(j){return j&&R(j)}):c.openCursor(k);function R(j){return Object.create(j,{continue:{value:function(q){q!=null?j.continue(Kr(q,k.reverse?a.MAX_KEY:a.MIN_KEY,T)):k.unique?j.continue(j.key.slice(0,x).concat(k.reverse?a.MIN_KEY:a.MAX_KEY,T)):j.continue()}},continuePrimaryKey:{value:function(q,F){j.continuePrimaryKey(Kr(q,a.MAX_KEY,T),F)}},primaryKey:{get:function(){return j.primaryKey}},key:{get:function(){var q=j.key;return x===1?q[0]:q.slice(0,x)}},value:{get:function(){return j.value}}})}}})}})}};function La(a,s,c,u){return c=c||{},u=u||"",l(a).forEach(function(h){var p,g,b;y(s,h)?(p=a[h],g=s[h],typeof p=="object"&&typeof g=="object"&&p&&g?(b=Be(p))!==Be(g)?c[u+h]=s[h]:b==="Object"?La(p,g,c,u+h+"."):p!==g&&(c[u+h]=s[h]):p!==g&&(c[u+h]=s[h])):c[u+h]=void 0}),l(s).forEach(function(h){y(a,h)||(c[u+h]=s[h])}),c}function qa(a,s){return s.type==="delete"?s.keys:s.keys||s.values.map(a.extractKey)}var Ko={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return r(r({},a),{table:function(s){var c=a.table(s),u=c.schema.primaryKey;return r(r({},c),{mutate:function(h){var p=H.trans,g=p.table(s).hook,b=g.deleting,S=g.creating,E=g.updating;switch(h.type){case"add":if(S.fire===Se)break;return p._promise("readwrite",function(){return $(h)},!0);case"put":if(S.fire===Se&&E.fire===Se)break;return p._promise("readwrite",function(){return $(h)},!0);case"delete":if(b.fire===Se)break;return p._promise("readwrite",function(){return $(h)},!0);case"deleteRange":if(b.fire===Se)break;return p._promise("readwrite",function(){return function k(P,T,A){return c.query({trans:P,values:!1,query:{index:u,range:T},limit:A}).then(function(x){var R=x.result;return $({type:"delete",keys:R,trans:P}).then(function(j){return 0<j.numFailures?Promise.reject(j.failures[0]):R.length<A?{failures:[],numFailures:0,lastResult:void 0}:k(P,r(r({},T),{lower:R[R.length-1],lowerOpen:!0}),A)})})}(h.trans,h.range,1e4)},!0)}return c.mutate(h);function $(k){var P,T,A,x=H.trans,R=k.keys||qa(u,k);if(!R)throw new Error("Keys missing");return(k=k.type==="add"||k.type==="put"?r(r({},k),{keys:R}):r({},k)).type!=="delete"&&(k.values=i([],k.values)),k.keys&&(k.keys=i([],k.keys)),P=c,A=R,((T=k).type==="add"?Promise.resolve([]):P.getMany({trans:T.trans,keys:A,cache:"immutable"})).then(function(j){var q=R.map(function(F,z){var J,Z,W,Q=j[z],ee={onerror:null,onsuccess:null};return k.type==="delete"?b.fire.call(ee,F,Q,x):k.type==="add"||Q===void 0?(J=S.fire.call(ee,F,k.values[z],x),F==null&&J!=null&&(k.keys[z]=F=J,u.outbound||L(k.values[z],u.keyPath,F))):(J=La(Q,k.values[z]),(Z=E.fire.call(ee,J,F,Q,x))&&(W=k.values[z],Object.keys(Z).forEach(function(X){y(W,X)?W[X]=Z[X]:L(W,X,Z[X])}))),ee});return c.mutate(k).then(function(F){for(var z=F.failures,J=F.results,Z=F.numFailures,F=F.lastResult,W=0;W<R.length;++W){var Q=(J||R)[W],ee=q[W];Q==null?ee.onerror&&ee.onerror(z[W]):ee.onsuccess&&ee.onsuccess(k.type==="put"&&j[W]?k.values[W]:Q)}return{failures:z,results:J,numFailures:Z,lastResult:F}}).catch(function(F){return q.forEach(function(z){return z.onerror&&z.onerror(F)}),Promise.reject(F)})})}}})}})}};function Gi(a,s,c){try{if(!s||s.keys.length<a.length)return null;for(var u=[],h=0,p=0;h<s.keys.length&&p<a.length;++h)Ae(s.keys[h],a[p])===0&&(u.push(c?ge(s.values[h]):s.values[h]),++p);return u.length===a.length?u:null}catch{return null}}var zo={stack:"dbcore",level:-1,create:function(a){return{table:function(s){var c=a.table(s);return r(r({},c),{getMany:function(u){if(!u.cache)return c.getMany(u);var h=Gi(u.keys,u.trans._cache,u.cache==="clone");return h?Y.resolve(h):c.getMany(u).then(function(p){return u.trans._cache={keys:u.keys,values:u.cache==="clone"?ge(p):p},p})},mutate:function(u){return u.type!=="add"&&(u.trans._cache=null),c.mutate(u)}})}}}};function Ji(a,s){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!s.schema.primaryKey.outbound}function Yi(a,s){switch(a){case"query":return s.values&&!s.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Ho={stack:"dbcore",level:0,name:"Observability",create:function(a){var s=a.schema.name,c=new bt(a.MIN_KEY,a.MAX_KEY);return r(r({},a),{transaction:function(u,h,p){if(H.subscr&&h!=="readonly")throw new re.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(H.querier));return a.transaction(u,h,p)},table:function(u){var h=a.table(u),p=h.schema,g=p.primaryKey,k=p.indexes,b=g.extractKey,S=g.outbound,E=g.autoIncrement&&k.filter(function(T){return T.compound&&T.keyPath.includes(g.keyPath)}),$=r(r({},h),{mutate:function(T){function A(X){return X="idb://".concat(s,"/").concat(u,"/").concat(X),F[X]||(F[X]=new bt)}var x,R,j,q=T.trans,F=T.mutatedParts||(T.mutatedParts={}),z=A(""),J=A(":dels"),Z=T.type,ee=T.type==="deleteRange"?[T.range]:T.type==="delete"?[T.keys]:T.values.length<50?[qa(g,T).filter(function(X){return X}),T.values]:[],W=ee[0],Q=ee[1],ee=T.trans._cache;return d(W)?(z.addKeys(W),(ee=Z==="delete"||W.length===Q.length?Gi(W,ee):null)||J.addKeys(W),(ee||Q)&&(x=A,R=ee,j=Q,p.indexes.forEach(function(X){var ae=x(X.name||"");function _e(Ce){return Ce!=null?X.extractKey(Ce):null}function ke(Ce){return X.multiEntry&&d(Ce)?Ce.forEach(function(Nt){return ae.addKey(Nt)}):ae.addKey(Ce)}(R||j).forEach(function(Ce,_t){var ye=R&&_e(R[_t]),_t=j&&_e(j[_t]);Ae(ye,_t)!==0&&(ye!=null&&ke(ye),_t!=null&&ke(_t))})}))):W?(Q={from:(Q=W.lower)!==null&&Q!==void 0?Q:a.MIN_KEY,to:(Q=W.upper)!==null&&Q!==void 0?Q:a.MAX_KEY},J.add(Q),z.add(Q)):(z.add(c),J.add(c),p.indexes.forEach(function(X){return A(X.name).add(c)})),h.mutate(T).then(function(X){return!W||T.type!=="add"&&T.type!=="put"||(z.addKeys(X.results),E&&E.forEach(function(ae){for(var _e=T.values.map(function(ye){return ae.extractKey(ye)}),ke=ae.keyPath.findIndex(function(ye){return ye===g.keyPath}),Ce=0,Nt=X.results.length;Ce<Nt;++Ce)_e[Ce][ke]=X.results[Ce];A(ae.name).addKeys(_e)})),q.mutatedParts=Ur(q.mutatedParts||{},F),X})}}),k=function(A){var x=A.query,A=x.index,x=x.range;return[A,new bt((A=x.lower)!==null&&A!==void 0?A:a.MIN_KEY,(x=x.upper)!==null&&x!==void 0?x:a.MAX_KEY)]},P={get:function(T){return[g,new bt(T.key)]},getMany:function(T){return[g,new bt().addKeys(T.keys)]},count:k,query:k,openCursor:k};return l(P).forEach(function(T){$[T]=function(A){var x=H.subscr,R=!!x,j=Ji(H,h)&&Yi(T,A)?A.obsSet={}:x;if(R){var q=function(Q){return Q="idb://".concat(s,"/").concat(u,"/").concat(Q),j[Q]||(j[Q]=new bt)},F=q(""),z=q(":dels"),x=P[T](A),R=x[0],x=x[1];if((T==="query"&&R.isPrimaryKey&&!A.values?z:q(R.name||"")).add(x),!R.isPrimaryKey){if(T!=="count"){var J=T==="query"&&S&&A.values&&h.query(r(r({},A),{values:!1}));return h[T].apply(this,arguments).then(function(Q){if(T==="query"){if(S&&A.values)return J.then(function(_e){return _e=_e.result,F.addKeys(_e),Q});var ee=A.values?Q.result.map(b):Q.result;(A.values?F:z).addKeys(ee)}else if(T==="openCursor"){var X=Q,ae=A.values;return X&&Object.create(X,{key:{get:function(){return z.addKey(X.primaryKey),X.key}},primaryKey:{get:function(){var _e=X.primaryKey;return z.addKey(_e),_e}},value:{get:function(){return ae&&F.addKey(X.primaryKey),X.value}}})}return Q})}z.add(c)}}return h[T].apply(this,arguments)}}),$}})}};function Qi(a,s,c){if(c.numFailures===0)return s;if(s.type==="deleteRange")return null;var u=s.keys?s.keys.length:"values"in s&&s.values?s.values.length:1;return c.numFailures===u?null:(s=r({},s),d(s.keys)&&(s.keys=s.keys.filter(function(h,p){return!(p in c.failures)})),"values"in s&&d(s.values)&&(s.values=s.values.filter(function(h,p){return!(p in c.failures)})),s)}function Da(a,s){return c=a,((u=s).lower===void 0||(u.lowerOpen?0<Ae(c,u.lower):0<=Ae(c,u.lower)))&&(a=a,(s=s).upper===void 0||(s.upperOpen?Ae(a,s.upper)<0:Ae(a,s.upper)<=0));var c,u}function Xi(a,s,P,u,h,p){if(!P||P.length===0)return a;var g=s.query.index,b=g.multiEntry,S=s.query.range,E=u.schema.primaryKey.extractKey,$=g.extractKey,k=(g.lowLevelIndex||g).extractKey,P=P.reduce(function(T,A){var x=T,R=[];if(A.type==="add"||A.type==="put")for(var j=new bt,q=A.values.length-1;0<=q;--q){var F,z=A.values[q],J=E(z);j.hasKey(J)||(F=$(z),(b&&d(F)?F.some(function(X){return Da(X,S)}):Da(F,S))&&(j.addKey(J),R.push(z)))}switch(A.type){case"add":var Z=new bt().addKeys(s.values?T.map(function(ae){return E(ae)}):T),x=T.concat(s.values?R.filter(function(ae){return ae=E(ae),!Z.hasKey(ae)&&(Z.addKey(ae),!0)}):R.map(function(ae){return E(ae)}).filter(function(ae){return!Z.hasKey(ae)&&(Z.addKey(ae),!0)}));break;case"put":var W=new bt().addKeys(A.values.map(function(ae){return E(ae)}));x=T.filter(function(ae){return!W.hasKey(s.values?E(ae):ae)}).concat(s.values?R:R.map(function(ae){return E(ae)}));break;case"delete":var Q=new bt().addKeys(A.keys);x=T.filter(function(ae){return!Q.hasKey(s.values?E(ae):ae)});break;case"deleteRange":var ee=A.range;x=T.filter(function(ae){return!Da(E(ae),ee)})}return x},a);return P===a?a:(P.sort(function(T,A){return Ae(k(T),k(A))||Ae(E(T),E(A))}),s.limit&&s.limit<1/0&&(P.length>s.limit?P.length=s.limit:a.length===s.limit&&P.length<s.limit&&(h.dirty=!0)),p?Object.freeze(P):P)}function Zi(a,s){return Ae(a.lower,s.lower)===0&&Ae(a.upper,s.upper)===0&&!!a.lowerOpen==!!s.lowerOpen&&!!a.upperOpen==!!s.upperOpen}function Wo(a,s){return function(c,u,h,p){if(c===void 0)return u!==void 0?-1:0;if(u===void 0)return 1;if((u=Ae(c,u))===0){if(h&&p)return 0;if(h)return 1;if(p)return-1}return u}(a.lower,s.lower,a.lowerOpen,s.lowerOpen)<=0&&0<=function(c,u,h,p){if(c===void 0)return u!==void 0?1:0;if(u===void 0)return-1;if((u=Ae(c,u))===0){if(h&&p)return 0;if(h)return-1;if(p)return 1}return u}(a.upper,s.upper,a.upperOpen,s.upperOpen)}function Vo(a,s,c,u){a.subscribers.add(c),u.addEventListener("abort",function(){var h,p;a.subscribers.delete(c),a.subscribers.size===0&&(h=a,p=s,setTimeout(function(){h.subscribers.size===0&&ve(p,h)},3e3))})}var Go={stack:"dbcore",level:0,name:"Cache",create:function(a){var s=a.schema.name;return r(r({},a),{transaction:function(c,u,h){var p,g,b=a.transaction(c,u,h);return u==="readwrite"&&(g=(p=new AbortController).signal,h=function(S){return function(){if(p.abort(),u==="readwrite"){for(var E=new Set,$=0,k=c;$<k.length;$++){var P=k[$],T=Nn["idb://".concat(s,"/").concat(P)];if(T){var A=a.table(P),x=T.optimisticOps.filter(function(ae){return ae.trans===b});if(b._explicit&&S&&b.mutatedParts)for(var R=0,j=Object.values(T.queries.query);R<j.length;R++)for(var q=0,F=(Z=j[R]).slice();q<F.length;q++)Ra((W=F[q]).obsSet,b.mutatedParts)&&(ve(Z,W),W.subscribers.forEach(function(ae){return E.add(ae)}));else if(0<x.length){T.optimisticOps=T.optimisticOps.filter(function(ae){return ae.trans!==b});for(var z=0,J=Object.values(T.queries.query);z<J.length;z++)for(var Z,W,Q,ee=0,X=(Z=J[z]).slice();ee<X.length;ee++)(W=X[ee]).res!=null&&b.mutatedParts&&(S&&!W.dirty?(Q=Object.isFrozen(W.res),Q=Xi(W.res,W.req,x,A,W,Q),W.dirty?(ve(Z,W),W.subscribers.forEach(function(ae){return E.add(ae)})):Q!==W.res&&(W.res=Q,W.promise=Y.resolve({result:Q}))):(W.dirty&&ve(Z,W),W.subscribers.forEach(function(ae){return E.add(ae)})))}}}E.forEach(function(ae){return ae()})}}},b.addEventListener("abort",h(!1),{signal:g}),b.addEventListener("error",h(!1),{signal:g}),b.addEventListener("complete",h(!0),{signal:g})),b},table:function(c){var u=a.table(c),h=u.schema.primaryKey;return r(r({},u),{mutate:function(p){var g=H.trans;if(h.outbound||g.db._options.cache==="disabled"||g.explicit||g.idbtrans.mode!=="readwrite")return u.mutate(p);var b=Nn["idb://".concat(s,"/").concat(c)];return b?(g=u.mutate(p),p.type!=="add"&&p.type!=="put"||!(50<=p.values.length||qa(h,p).some(function(S){return S==null}))?(b.optimisticOps.push(p),p.mutatedParts&&Fr(p.mutatedParts),g.then(function(S){0<S.numFailures&&(ve(b.optimisticOps,p),(S=Qi(0,p,S))&&b.optimisticOps.push(S),p.mutatedParts&&Fr(p.mutatedParts))}),g.catch(function(){ve(b.optimisticOps,p),p.mutatedParts&&Fr(p.mutatedParts)})):g.then(function(S){var E=Qi(0,r(r({},p),{values:p.values.map(function($,k){var P;return S.failures[k]?$:($=(P=h.keyPath)!==null&&P!==void 0&&P.includes(".")?ge($):r({},$),L($,h.keyPath,S.results[k]),$)})}),S);b.optimisticOps.push(E),queueMicrotask(function(){return p.mutatedParts&&Fr(p.mutatedParts)})}),g):u.mutate(p)},query:function(p){if(!Ji(H,u)||!Yi("query",p))return u.query(p);var g=((E=H.trans)===null||E===void 0?void 0:E.db._options.cache)==="immutable",k=H,b=k.requery,S=k.signal,E=function(A,x,R,j){var q=Nn["idb://".concat(A,"/").concat(x)];if(!q)return[];if(!(x=q.queries[R]))return[null,!1,q,null];var F=x[(j.query?j.query.index.name:null)||""];if(!F)return[null,!1,q,null];switch(R){case"query":var z=F.find(function(J){return J.req.limit===j.limit&&J.req.values===j.values&&Zi(J.req.query.range,j.query.range)});return z?[z,!0,q,F]:[F.find(function(J){return("limit"in J.req?J.req.limit:1/0)>=j.limit&&(!j.values||J.req.values)&&Wo(J.req.query.range,j.query.range)}),!1,q,F];case"count":return z=F.find(function(J){return Zi(J.req.query.range,j.query.range)}),[z,!!z,q,F]}}(s,c,"query",p),$=E[0],k=E[1],P=E[2],T=E[3];return $&&k?$.obsSet=p.obsSet:(k=u.query(p).then(function(A){var x=A.result;if($&&($.res=x),g){for(var R=0,j=x.length;R<j;++R)Object.freeze(x[R]);Object.freeze(x)}else A.result=ge(x);return A}).catch(function(A){return T&&$&&ve(T,$),Promise.reject(A)}),$={obsSet:p.obsSet,promise:k,subscribers:new Set,type:"query",req:p,dirty:!1},T?T.push($):(T=[$],(P=P||(Nn["idb://".concat(s,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[p.query.index.name||""]=T)),Vo($,T,b,S),$.promise.then(function(A){return{result:Xi(A.result,p,P==null?void 0:P.optimisticOps,u,$,g)}})}})}})}};function zr(a,s){return new Proxy(a,{get:function(c,u,h){return u==="db"?s:Reflect.get(c,u,h)}})}var pn=(rt.prototype.version=function(a){if(isNaN(a)||a<.1)throw new re.Type("Given version is not a positive number");if(a=Math.round(10*a)/10,this.idbdb||this._state.isBeingOpened)throw new re.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var s=this._versions,c=s.filter(function(u){return u._cfg.version===a})[0];return c||(c=new this.Version(a),s.push(c),s.sort(qo),c.stores({}),this._state.autoSchema=!1,c)},rt.prototype._whenReady=function(a){var s=this;return this.idbdb&&(this._state.openComplete||H.letThrough||this._vip)?a():new Y(function(c,u){if(s._state.openComplete)return u(new re.DatabaseClosed(s._state.dbOpenError));if(!s._state.isBeingOpened){if(!s._state.autoOpen)return void u(new re.DatabaseClosed);s.open().catch(Se)}s._state.dbReadyPromise.then(c,u)}).then(a)},rt.prototype.use=function(a){var s=a.stack,c=a.create,u=a.level,h=a.name;return h&&this.unuse({stack:s,name:h}),a=this._middlewares[s]||(this._middlewares[s]=[]),a.push({stack:s,create:c,level:u??10,name:h}),a.sort(function(p,g){return p.level-g.level}),this},rt.prototype.unuse=function(a){var s=a.stack,c=a.name,u=a.create;return s&&this._middlewares[s]&&(this._middlewares[s]=this._middlewares[s].filter(function(h){return u?h.create!==u:!!c&&h.name!==c})),this},rt.prototype.open=function(){var a=this;return $n(V,function(){return Uo(a)})},rt.prototype._close=function(){this.on.close.fire(new CustomEvent("close"));var a=this._state,s=Fn.indexOf(this);if(0<=s&&Fn.splice(s,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new Y(function(c){a.dbReadyResolve=c}),a.openCanceller=new Y(function(c,u){a.cancelOpen=u}))},rt.prototype.close=function(c){var s=(c===void 0?{disableAutoOpen:!0}:c).disableAutoOpen,c=this._state;s?(c.isBeingOpened&&c.cancelOpen(new re.DatabaseClosed),this._close(),c.autoOpen=!1,c.dbOpenError=new re.DatabaseClosed):(this._close(),c.autoOpen=this._options.autoOpen||c.isBeingOpened,c.openComplete=!1,c.dbOpenError=null)},rt.prototype.delete=function(a){var s=this;a===void 0&&(a={disableAutoOpen:!0});var c=0<arguments.length&&typeof arguments[0]!="object",u=this._state;return new Y(function(h,p){function g(){s.close(a);var b=s._deps.indexedDB.deleteDatabase(s.name);b.onsuccess=je(function(){var S,E,$;S=s._deps,E=s.name,$=S.indexedDB,S=S.IDBKeyRange,xa($)||E===Or||Aa($,S).delete(E).catch(Se),h()}),b.onerror=on(p),b.onblocked=s._fireOnBlocked}if(c)throw new re.InvalidArgument("Invalid closeOptions argument to db.delete()");u.isBeingOpened?u.dbReadyPromise.then(g):g()})},rt.prototype.backendDB=function(){return this.idbdb},rt.prototype.isOpen=function(){return this.idbdb!==null},rt.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"},rt.prototype.hasFailed=function(){return this._state.dbOpenError!==null},rt.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(rt.prototype,"tables",{get:function(){var a=this;return l(this._allTables).map(function(s){return a._allTables[s]})},enumerable:!1,configurable:!0}),rt.prototype.transaction=function(){var a=(function(s,c,u){var h=arguments.length;if(h<2)throw new re.InvalidArgument("Too few arguments");for(var p=new Array(h-1);--h;)p[h-1]=arguments[h];return u=p.pop(),[s,we(p),u]}).apply(this,arguments);return this._transaction.apply(this,a)},rt.prototype._transaction=function(a,s,c){var u=this,h=H.trans;h&&h.db===this&&a.indexOf("!")===-1||(h=null);var p,g,b=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");try{if(g=s.map(function(E){if(E=E instanceof u.Table?E.name:E,typeof E!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return E}),a=="r"||a===ga)p=ga;else{if(a!="rw"&&a!=va)throw new re.InvalidArgument("Invalid transaction mode: "+a);p=va}if(h){if(h.mode===ga&&p===va){if(!b)throw new re.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");h=null}h&&g.forEach(function(E){if(h&&h.storeNames.indexOf(E)===-1){if(!b)throw new re.SubTransaction("Table "+E+" not included in parent transaction.");h=null}}),b&&h&&!h.active&&(h=null)}}catch(E){return h?h._promise(null,function($,k){k(E)}):nt(E)}var S=(function E($,k,P,T,A){return Y.resolve().then(function(){var x=H.transless||H,R=$._createTransaction(k,P,$._dbSchema,T);if(R.explicit=!0,x={trans:R,transless:x},T)R.idbtrans=T.idbtrans;else try{R.create(),R.idbtrans._explicit=!0,$._state.PR1398_maxLoop=3}catch(F){return F.name===Bt.InvalidState&&$.isOpen()&&0<--$._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),$.close({disableAutoOpen:!1}),$.open().then(function(){return E($,k,P,null,A)})):nt(F)}var j,q=We(A);return q&&$e(),x=Y.follow(function(){var F;(j=A.call(R,R))&&(q?(F=Re.bind(null,null),j.then(F,F)):typeof j.next=="function"&&typeof j.throw=="function"&&(j=ja(j)))},x),(j&&typeof j.then=="function"?Y.resolve(j).then(function(F){return R.active?F:nt(new re.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):x.then(function(){return j})).then(function(F){return T&&R._resolve(),R._completion.then(function(){return F})}).catch(function(F){return R._reject(F),nt(F)})})}).bind(null,this,p,g,h,c);return h?h._promise(p,S,"lock"):H.trans?$n(H.transless,function(){return u._whenReady(S)}):this._whenReady(S)},rt.prototype.table=function(a){if(!y(this._allTables,a))throw new re.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]},rt);function rt(a,s){var c=this;this._middlewares={},this.verno=0;var u=rt.dependencies;this._options=s=r({addons:rt.addons,autoOpen:!0,indexedDB:u.indexedDB,IDBKeyRange:u.IDBKeyRange,cache:"cloned"},s),this._deps={indexedDB:s.indexedDB,IDBKeyRange:s.IDBKeyRange},u=s.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var h,p,g,b,S,E={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:Se,dbReadyPromise:null,cancelOpen:Se,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:s.autoOpen};E.dbReadyPromise=new Y(function(k){E.dbReadyResolve=k}),E.openCanceller=new Y(function(k,P){E.cancelOpen=P}),this._state=E,this.name=a,this.on=lr(this,"populate","blocked","versionchange","close",{ready:[St,Se]}),this.once=function(k,P){var T=function(){for(var A=[],x=0;x<arguments.length;x++)A[x]=arguments[x];c.on(k).unsubscribe(T),P.apply(c,A)};return c.on(k,T)},this.on.ready.subscribe=D(this.on.ready.subscribe,function(k){return function(P,T){rt.vip(function(){var A,x=c._state;x.openComplete?(x.dbOpenError||Y.resolve().then(P),T&&k(P)):x.onReadyBeingFired?(x.onReadyBeingFired.push(P),T&&k(P)):(k(P),A=c,T||k(function R(){A.on.ready.unsubscribe(P),A.on.ready.unsubscribe(R)}))})}}),this.Collection=(h=this,cr($o.prototype,function(j,R){this.db=h;var T=xi,A=null;if(R)try{T=R()}catch(q){A=q}var x=j._ctx,R=x.table,j=R.hook.reading.fire;this._ctx={table:R,index:x.index,isPrimKey:!x.index||R.schema.primKey.keyPath&&x.index===R.schema.primKey.name,range:T,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:A,or:x.or,valueMapper:j!==ct?j:null}})),this.Table=(p=this,cr(Ii.prototype,function(k,P,T){this.db=p,this._tx=T,this.name=k,this.schema=P,this.hook=p._allTables[k]?p._allTables[k].hook:lr(null,{creating:[vt,Se],reading:[Ee,ct],updating:[sn,Se],deleting:[Wt,Se]})})),this.Transaction=(g=this,cr(No.prototype,function(k,P,T,A,x){var R=this;k!=="readonly"&&P.forEach(function(j){j=(j=T[j])===null||j===void 0?void 0:j.yProps,j&&(P=P.concat(j.map(function(q){return q.updatesTable})))}),this.db=g,this.mode=k,this.storeNames=P,this.schema=T,this.chromeTransactionDurability=A,this.idbtrans=null,this.on=lr(this,"complete","error","abort"),this.parent=x||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new Y(function(j,q){R._resolve=j,R._reject=q}),this._completion.then(function(){R.active=!1,R.on.complete.fire()},function(j){var q=R.active;return R.active=!1,R.on.error.fire(j),R.parent?R.parent._reject(j):q&&R.idbtrans&&R.idbtrans.abort(),nt(j)})})),this.Version=(b=this,cr(Mo.prototype,function(k){this.db=b,this._cfg={version:k,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(S=this,cr(Bi.prototype,function(k,P,T){if(this.db=S,this._ctx={table:k,index:P===":id"?null:P,or:T},this._cmp=this._ascending=Ae,this._descending=function(A,x){return Ae(x,A)},this._max=function(A,x){return 0<Ae(A,x)?A:x},this._min=function(A,x){return Ae(A,x)<0?A:x},this._IDBKeyRange=S._deps.IDBKeyRange,!this._IDBKeyRange)throw new re.MissingAPI})),this.on("versionchange",function(k){0<k.newVersion?console.warn("Another connection wants to upgrade database '".concat(c.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(c.name,"'. Closing db now to resume the delete request.")),c.close({disableAutoOpen:!1})}),this.on("blocked",function(k){!k.newVersion||k.newVersion<k.oldVersion?console.warn("Dexie.delete('".concat(c.name,"') was blocked")):console.warn("Upgrade '".concat(c.name,"' blocked by other connection holding version ").concat(k.oldVersion/10))}),this._maxKey=hr(s.IDBKeyRange),this._createTransaction=function(k,P,T,A){return new c.Transaction(k,P,T,c._options.chromeTransactionDurability,A)},this._fireOnBlocked=function(k){c.on("blocked").fire(k),Fn.filter(function(P){return P.name===c.name&&P!==c&&!P._state.vcFired}).map(function(P){return P.on("versionchange").fire(k)})},this.use(zo),this.use(Go),this.use(Ho),this.use(Fo),this.use(Ko);var $=new Proxy(this,{get:function(k,P,T){if(P==="_vip")return!0;if(P==="table")return function(x){return zr(c.table(x),$)};var A=Reflect.get(k,P,T);return A instanceof Ii?zr(A,$):P==="tables"?A.map(function(x){return zr(x,$)}):P==="_createTransaction"?function(){return zr(A.apply(this,arguments),$)}:A}});this.vip=$,u.forEach(function(k){return k(c)})}var Hr,Ft=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Jo=(Ba.prototype.subscribe=function(a,s,c){return this._subscribe(a&&typeof a!="function"?a:{next:a,error:s,complete:c})},Ba.prototype[Ft]=function(){return this},Ba);function Ba(a){this._subscribe=a}try{Hr={indexedDB:o.indexedDB||o.mozIndexedDB||o.webkitIndexedDB||o.msIndexedDB,IDBKeyRange:o.IDBKeyRange||o.webkitIDBKeyRange}}catch{Hr={indexedDB:null,IDBKeyRange:null}}function es(a){var s,c=!1,u=new Jo(function(h){var p=We(a),g,b=!1,S={},E={},$={get closed(){return b},unsubscribe:function(){b||(b=!0,g&&g.abort(),k&&kn.storagemutated.unsubscribe(T))}};h.start&&h.start($);var k=!1,P=function(){return ma(A)},T=function(x){Ur(S,x),Ra(E,S)&&P()},A=function(){var x,R,j;!b&&Hr.indexedDB&&(S={},x={},g&&g.abort(),g=new AbortController,j=function(q){var F=Qt();try{p&&$e();var z=ue(a,q);return z=p?z.finally(Re):z}finally{F&&Xt()}}(R={subscr:x,signal:g.signal,requery:P,querier:a,trans:null}),Promise.resolve(j).then(function(q){c=!0,s=q,b||R.signal.aborted||(S={},function(F){for(var z in F)if(y(F,z))return;return 1}(E=x)||k||(kn(dr,T),k=!0),ma(function(){return!b&&h.next&&h.next(q)}))},function(q){c=!1,["DatabaseClosedError","AbortError"].includes(q==null?void 0:q.name)||b||ma(function(){b||h.error&&h.error(q)})}))};return setTimeout(P,0),$});return u.hasValue=function(){return c},u.getValue=function(){return s},u}var In=pn;function Ma(a){var s=Sn;try{Sn=!0,kn.storagemutated.fire(a),Ia(a,!0)}finally{Sn=s}}_(In,r(r({},Ot),{delete:function(a){return new In(a,{addons:[]}).delete()},exists:function(a){return new In(a,{addons:[]}).open().then(function(s){return s.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return s=In.dependencies,c=s.indexedDB,s=s.IDBKeyRange,(xa(c)?Promise.resolve(c.databases()).then(function(u){return u.map(function(h){return h.name}).filter(function(h){return h!==Or})}):Aa(c,s).toCollection().primaryKeys()).then(a)}catch{return nt(new re.MissingAPI)}var s,c},defineClass:function(){return function(a){f(this,a)}},ignoreTransaction:function(a){return H.trans?$n(H.transless,a):a()},vip:Oa,async:function(a){return function(){try{var s=ja(a.apply(this,arguments));return s&&typeof s.then=="function"?s:Y.resolve(s)}catch(c){return nt(c)}}},spawn:function(a,s,c){try{var u=ja(a.apply(c,s||[]));return u&&typeof u.then=="function"?u:Y.resolve(u)}catch(h){return nt(h)}},currentTransaction:{get:function(){return H.trans||null}},waitFor:function(a,s){return s=Y.resolve(typeof a=="function"?In.ignoreTransaction(a):a).timeout(s||6e4),H.trans?H.trans.waitFor(s):s},Promise:Y,debug:{get:function(){return Je},set:function(a){Ut(a)}},derive:N,extend:f,props:_,override:D,Events:lr,on:kn,liveQuery:es,extendObservabilitySet:Ur,getByKeyPath:M,setByKeyPath:L,delByKeyPath:function(a,s){typeof s=="string"?L(a,s,void 0):"length"in s&&[].map.call(s,function(c){L(a,c,void 0)})},shallowClone:te,deepClone:ge,getObjectDiff:La,cmp:Ae,asap:K,minKey:-1/0,addons:[],connections:Fn,errnames:Bt,dependencies:Hr,cache:Nn,semVer:"4.2.1",version:"4.2.1".split(".").map(function(a){return parseInt(a)}).reduce(function(a,s,c){return a+s/Math.pow(10,2*c)})})),In.maxKey=hr(In.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(kn(dr,function(a){Sn||(a=new CustomEvent(_a,{detail:a}),Sn=!0,dispatchEvent(a),Sn=!1)}),addEventListener(_a,function(a){a=a.detail,Sn||Ma(a)}));var Wn,Sn=!1,ts=function(){};return typeof BroadcastChannel<"u"&&((ts=function(){(Wn=new BroadcastChannel(_a)).onmessage=function(a){return a.data&&Ma(a.data)}})(),typeof Wn.unref=="function"&&Wn.unref(),kn(dr,function(a){Sn||Wn.postMessage(a)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(a){if(!pn.disableBfCache&&a.persisted){Je&&console.debug("Dexie: handling persisted pagehide"),Wn!=null&&Wn.close();for(var s=0,c=Fn;s<c.length;s++)c[s].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(a){!pn.disableBfCache&&a.persisted&&(Je&&console.debug("Dexie: handling persisted pageshow"),ts(),Ma({all:new bt(-1/0,[[]])}))})),Y.rejectionMapper=function(a,s){return!a||a instanceof Ve||a instanceof TypeError||a instanceof SyntaxError||!a.name||!Mt[a.name]?a:(s=new Mt[a.name](s||a.message,a),"stack"in a&&w(s,"stack",{get:function(){return this.inner.stack}}),s)},Ut(Je),r(pn,Object.freeze({__proto__:null,Dexie:pn,liveQuery:es,Entity:Oi,cmp:Ae,PropModification:or,replacePrefix:function(a,s){return new or({replacePrefix:[a,s]})},add:function(a){return new or({add:a})},remove:function(a){return new or({remove:a})},default:pn,RangeSet:bt,mergeRanges:mr,rangesOverlap:zi}),{default:pn}),pn})})(go);var Yu=go.exports;const di=Ju(Yu),Os=Symbol.for("Dexie"),ia=globalThis[Os]||(globalThis[Os]=di);if(di.semVer!==ia.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${di.semVer} and ${ia.semVer}`);const{liveQuery:jh,mergeRanges:Lh,rangesOverlap:qh,RangeSet:Dh,cmp:Bh,Entity:Mh,PropModification:Uh,replacePrefix:Fh,add:Kh,remove:zh,DexieYProvider:Hh}=ia,xt=new ia("dungeonDragon");xt.version(1).stores({characters:"id,user_id",items:"id,character_id,user_id",resources:"id,character_id,user_id",wallet:"character_id,user_id",journal:"id,character_id,user_id",tags:"id,user_id",entryTags:"[entry_id+tag_id],entry_id,tag_id"});async function Qu(){var i;const{user:n}=kt();if(!n)return;const e=await xt.characters.where("user_id").equals(n.id).toArray();e.length&&zt({characters:e});const t=Yo(n.id),r=t&&e.some(o=>o.id===t)?t:((i=e[0])==null?void 0:i.id)??null;if(r){ua(r);const[o,l,d,f,m]=await Promise.all([xt.items.where("character_id").equals(r).toArray(),xt.resources.where("character_id").equals(r).toArray(),xt.journal.where("character_id").equals(r).toArray(),xt.wallet.where("character_id").equals(r).first(),xt.tags.where("user_id").equals(n.id).toArray()]);jt("items",o),jt("resources",l),jt("journal",d),jt("wallet",f??null),jt("tags",m)}}async function Kt({characters:n,items:e,resources:t,wallet:r,journal:i,tags:o,entryTags:l}){n&&await xt.characters.bulkPut(n),e&&await xt.items.bulkPut(e),t&&await xt.resources.bulkPut(t),r&&await xt.wallet.put(r),i&&await xt.journal.bulkPut(i),o&&await xt.tags.bulkPut(o),l&&await xt.entryTags.bulkPut(l)}let de=null;function Xu(){return`
    <div id="diceRoller"></div>
    <main id="diceRollerUI">
      <div class="top_field" hidden>
        <input type="text" id="textInput" spellcheck="false" inputmode="none" virtualkeyboardpolicy="manual"
               value="1d20"/>
      </div>
      <div id="diceLimit" style="display:none">Wow that's a lot of dice! <br>[Limit: 20]</div>    
      <div id="numPad" class="center_field" style="display:none">
        <table class="numPad">
          <tr><td onclick="main.input('del')" colspan="2">del</td><td onclick="main.input('bksp')" colspan="2">bksp</td></tr>
          <tr><td onclick="main.input('7')">7</td><td onclick="main.input('8')">8</td><td onclick="main.input('9')">9</td><td onclick="main.input('+')" rowspan="2">+</td></tr>
          <tr><td onclick="main.input('4')">4</td><td onclick="main.input('5')">5</td><td onclick="main.input('6')">6</td></tr>
          <tr><td onclick="main.input('1')">1</td><td onclick="main.input('2')">2</td><td onclick="main.input('3')">3</td><td onclick="main.input('-')" rowspan="2">-</td></tr>
          <tr><td onclick="main.input('0')" colspan="2">0</td><td onclick="main.input('d')">d</td></tr>
        </table>
        <button onclick="main.clearInput()">CLEAR</button>
        <button onclick="main.setInput()">OK</button>
      </div>
      <div class="bottom_field" hidden><span id="result"></span></div>
    </main>
  `}function Zu(){return`
  <div class="diceov-backdrop" data-close></div>
  <div class="diceov-stage" role="dialog" aria-modal="true" aria-label="Lancio dadi">
    <button class="diceov-close" data-close aria-label="Chiudi" hidden></button>
    <section class="diceov-panel">
      <header class="diceov-header">
        <div>      
          <p class="diceov-eyebrow" data-dice-title>Lancia dadi</h3>
        </div>
      </header>
      <div class="diceov-controls">   
        <div class="diceov-control diceov-control--row" data-modifier-home>
         <div class="diceov-control" data-dice-control="d20">
          <label class="diceov-label" for="dice-roll-mode">Modalit</label>
          <select id="dice-roll-mode" name="dice-roll-mode">
            <option value="normal" selected>Normale</option>
            <option value="advantage">Vantaggio</option>
            <option value="disadvantage">Svantaggio</option>
          </select>
        </div>
          <div class="diceov-control" data-dice-select hidden>
            <label class="diceov-label" for="dice-roll-select" data-dice-select-label>Seleziona</label>
            <select id="dice-roll-select" name="dice-roll-select"></select>
          </div>
          <div class="diceov-field diceov-field--modifier">
            <label class="diceov-label" for="dice-modifier">Mod</label>
            <input id="dice-modifier" type="number" name="dice-modifier" value="0" step="1" />
          </div>
          <div class="diceov-control" data-dice-buff hidden>
            <label class="diceov-label" for="dice-buff">Buff/Debuff</label>
            <select id="dice-buff" name="dice-buff">
              <option value="none" selected>Nessuno</option>
              <option value="plus-d4">+d4</option>
              <option value="plus-d6">+d6</option>
              <option value="minus-d4">-d4</option>
              <option value="minus-d6">-d6</option>
            </select>
          </div>
           <div class="diceov-control" data-dice-control="d20">
          <div class="diceov-inspiration" data-dice-inspiration>
            <span class="diceov-label">Ispirazione</span>
            <label class="diceov-toggle">
              <input id="dice-inspiration" type="checkbox" name="dice-inspiration" />
              <span class="diceov-toggle-track" aria-hidden="true"></span>
            </label>
          </div>
        </div>
         <p class="diceov-warning" data-inspiration-warning hidden>
              Attenzione: userai il punto ispirazione su questo tiro.
            </p>
         <p class="diceov-warning" data-weakness-warning hidden></p>
        </div>
       
        <div class="diceov-control" data-dice-control="generic">       
          <div class="diceov-generic-row">
            <div class="diceov-field">
              <label class="diceov-label" for="dice-count">Dadi</label>
              <input id="dice-count" type="number" name="dice-count" min="1" value="1" />
            </div>
            <div class="diceov-field">
              <label class="diceov-label" for="dice-type">Tipo dado</label>
              <select id="dice-type" name="dice-type">
                <option value="d4">d4</option>
                <option value="d6">d6</option>
                <option value="d8">d8</option>
                <option value="d10">d10</option>
                <option value="d12">d12</option>
                <option value="d20" selected>d20</option>
                <option value="d100">d100</option>
              </select>
            </div>
            <div class="diceov-field">
              <label class="diceov-label" for="dice-notation">Notazione</label>
              <input id="dice-notation" class="diceov-generic-notation" type="text" name="dice-notation" value="1d20" spellcheck="false" />
            </div>
            <div class="diceov-field diceov-field--modifier">
              <label class="diceov-label" for="dice-modifier-generic">Mod</label>
              <input id="dice-modifier-generic" type="number" name="dice-modifier-generic" value="0" step="1" />
            </div>
          </div>
          <p class="diceov-hint">Puoi combinare dadi diversi (es. 2d6+1d4).</p>
        </div>
      </div>
      <div class="diceov-results">
        <div class="diceov-result diceov-result--full">
          <p class="diceov-result-label">Risultato</p>
          <p class="diceov-result-value" data-dice-result></p>
          <p class="diceov-result-detail" data-dice-detail>Lancia i dadi per vedere il totale.</p>
        </div>
      </div>
    </section>
    ${Xu()}
    <section class="diceov-history-accordion" data-history-accordion>
      <button class="diceov-history-toggle" type="button" data-history-toggle aria-expanded="false">
        <span>Storico tiri</span>
        <span class="diceov-history-toggle-icon" aria-hidden="true"></span>
      </button>
      <div class="diceov-history-panel" data-dice-history-panel hidden>
        <div class="diceov-history-list" data-dice-history></div>
      </div>
    </section>
  </div>`}function ed(n){const e=String(n).match(/\d+/g);return e?parseInt(e[e.length-1],10):null}const vo="diceRollHistory",td=12;function nd(){if(typeof window>"u")return[];try{const n=window.localStorage.getItem(vo),e=n?JSON.parse(n):[];return Array.isArray(e)?e:[]}catch{return[]}}function rd(n){if(!(typeof window>"u"))try{window.localStorage.setItem(vo,JSON.stringify(n))}catch{}}function ad(n){try{return new Date(n).toLocaleString("it-IT",{dateStyle:"short",timeStyle:"short"})}catch{return n}}function Qr(n){return n?n>0?`+${n}`:`${n}`:"+0"}function Qa(n){const e=n.querySelector('select[name="dice-roll-mode"]');return(e==null?void 0:e.value)??"normal"}function $s(n,e){const t=n.querySelector("#textInput");t&&(t.value=e,window.main&&typeof window.main.setInput=="function"&&window.main.setInput())}function Xr(n){var r,i;const e=Math.max(Number((r=n.querySelector('[name="dice-count"]'))==null?void 0:r.value)||1,1),t=((i=n.querySelector('[name="dice-type"]'))==null?void 0:i.value)||"d20";return`${e}${t}`}function id(n,e){const t=String(e||"").trim().match(/^(\d+)\s*d\s*(\d+)$/i);if(!t)return;const r=n.querySelector('[name="dice-count"]'),i=n.querySelector('[name="dice-type"]');r&&(r.value=t[1]),i&&(i.value=`d${t[2]}`)}function sd(n,e){n.dataset.diceMode=e,n.querySelectorAll("[data-dice-control]").forEach(t=>{const r=t.dataset.diceControl===e||t.dataset.diceControl==="d20"&&e==="d20";t.toggleAttribute("hidden",!r)})}function hi({sides:n=20,keepOpen:e=!1,title:t="Lancia dadi",mode:r="generic",notation:i=null,modifier:o=null,selection:l=null,allowInspiration:d=!1,onConsumeInspiration:f=null,rollType:m=null,weakPoints:v=0}={}){var dn;de||(de=document.createElement("div"),de.id="dice-overlay",de.innerHTML=Zu(),document.body.appendChild(de),window.main&&typeof window.main.init=="function"&&window.main.init(),window.main&&typeof window.main.setInput=="function"&&window.main.setInput(),de.addEventListener("click",V=>{V.target.closest("[data-close]")&&nr()}),document.addEventListener("keydown",yo,!0));try{const V=de.querySelector("#result");V&&(V.textContent="");const H=de.querySelector("#diceLimit");H&&(H.style.display="none")}catch{}window.main&&typeof window.main.clearDice=="function"&&window.main.clearDice(),(dn=de.querySelector("[data-dice-title]"))==null||dn.replaceChildren(document.createTextNode(t)),sd(de,r==="generic"?"generic":"d20");const _=de.querySelector('input[name="dice-inspiration"]'),C=de.querySelector("[data-dice-inspiration]"),w=de.querySelector("[data-inspiration-warning]"),N=de.querySelector("[data-weakness-warning]"),I=de.querySelector('select[name="dice-roll-mode"]'),O=de.querySelector('input[name="dice-modifier"]'),U=O==null?void 0:O.closest(".diceov-field--modifier"),D=de.querySelector('input[name="dice-modifier-generic"]'),B=de.querySelector('input[name="dice-notation"]'),K=de.querySelector("[data-dice-select]"),M=de.querySelector("[data-dice-select-label]"),L=de.querySelector('select[name="dice-roll-select"]'),te=de.querySelector("[data-dice-result]"),ne=de.querySelector("[data-dice-detail]"),we=de.querySelector("[data-dice-buff]"),me=de.querySelector('select[name="dice-buff"]'),he=de.querySelector(".diceov-stage"),ge=de.querySelector("[data-history-accordion]"),qe=de.querySelector("[data-history-toggle]"),Be=de.querySelector("[data-dice-history-panel]"),Me=de.querySelector("[data-dice-history]"),se={lastRoll:null,lastBuff:null,inspirationAvailable:!!d,inspirationConsumed:!1,selectionOptions:Array.isArray(l==null?void 0:l.options)?l.options:[],history:nd()},ve=Math.max(0,Number(v)||0),be=m==="TA"&&ve>=1?"Svantaggio: punti indebolimento (prove di caratteristica).":(m==="TS"||m==="TC")&&ve>=3?"Svantaggio: punti indebolimento (tiri salvezza/colpire).":null;function Te(){return r==="generic"&&D||O}function We(){if(!U)return;const V=r==="generic";U.toggleAttribute("hidden",V)}function At(V="",H="Lancia i dadi per vedere il totale."){te&&(te.textContent=V),ne&&(ne.textContent=H),se.lastRoll=null}function Ve(){if(Me){if(!se.history.length){Me.innerHTML='<p class="diceov-history-empty">Nessun tiro ancora.</p>';return}Me.innerHTML=se.history.map(V=>`
        <div class="diceov-history-row">
          <div class="diceov-history-type diceov-history-type--${String(V.type||"gen").toLowerCase()}">
            <span class="diceov-history-type-code">${V.type||""}</span>
            ${V.subtype?`<span class="diceov-history-subtype">${V.subtype}</span>`:""}
            ${V.inspired?'<span class="diceov-history-flag">Isp.</span>':""}
          </div>
          <span class="diceov-history-total">${V.total??""}</span>
          <span class="diceov-history-date">${ad(V.timestamp)}</span>
        </div>
      `).join("")}}function gt(V){se.history=[V,...se.history].slice(0,td),rd(se.history),Ve()}function Qe(){if(!I)return;const V=!!(_!=null&&_.checked);V?I.value=be?"normal":"advantage":re(),I.disabled=V,w&&w.toggleAttribute("hidden",!V),Ht()}function Ge(V){se.inspirationAvailable=!!V,C&&C.toggleAttribute("hidden",!se.inspirationAvailable),_&&(_.disabled=!se.inspirationAvailable,se.inspirationAvailable||(_.checked=!1)),!se.inspirationAvailable&&I&&(I.disabled=!1),!se.inspirationAvailable&&w&&w.setAttribute("hidden","")}function Bt(){var xe;if(!K||!L)return;if(!se.selectionOptions.length){K.setAttribute("hidden",""),L.innerHTML="";return}K.removeAttribute("hidden"),M&&(M.textContent=(l==null?void 0:l.label)||"Seleziona"),L.innerHTML=se.selectionOptions.map(Ue=>`<option value="${Ue.value}">${Ue.label}</option>`).join("");const V=(l==null?void 0:l.value)??((xe=se.selectionOptions[0])==null?void 0:xe.value);V!==void 0&&(L.value=V);const H=se.selectionOptions.find(Ue=>Ue.value===L.value);H&&O&&(O.value=Number(H.modifier)||0)}function Ht(){if(!N)return;const V=!!be&&Qa(de)==="disadvantage";N.textContent=be??"",N.toggleAttribute("hidden",!V)}function re(){I&&(I.value=be?"disadvantage":"normal",Ht())}function Mt(){if(!we||!me)return;const V=["TS","TA","TC"].includes(m);we.toggleAttribute("hidden",!V),V||(me.value="none",se.lastBuff=null)}function Ot(){if(!me||we!=null&&we.hasAttribute("hidden"))return null;const V=me.value;if(V==="none")return null;const H=V.endsWith("d6")?6:4,xe=V.startsWith("plus"),Ue=`${xe?"+":"-"}d${H}`;return{choice:V,sides:H,label:Ue,sign:xe?1:-1}}function Se(V){const H=V.result||[],xe=Qa(de),Ue=xe==="normal"?1:2,it=H.slice(0,Ue),Y=Ot();let Rt=null;if(Y&&H.length>Ue){const yt=H[Ue];typeof yt=="number"&&(Rt={...Y,roll:yt,delta:Y.sign*yt})}const Jt=it.length?xe==="advantage"?Math.max(...it):xe==="disadvantage"?Math.min(...it):it[0]:null;return{rollMode:xe,baseRolls:it,picked:Jt,buff:Rt}}function ct(V){if(!(!ge||!qe||!Be)&&(ge.classList.toggle("is-open",V),qe.setAttribute("aria-expanded",String(V)),Be.toggleAttribute("hidden",!V),he==null||he.classList.toggle("diceov-stage--history-open",V),V)){const H=de.querySelector(".diceov-header");if(H&&he){const xe=Math.max(H.getBoundingClientRect().bottom-he.getBoundingClientRect().top,0);ge.style.setProperty("--diceov-history-offset",`${xe}px`)}}}function Ee(){if(!L)return null;const V=se.selectionOptions.find(xe=>xe.value===L.value);return V&&(V.shortLabel||V.label||"").replace(/\s*\([^)]*\)\s*$/,"").trim()||null}function dt(){if(r!=="generic"){const H=Qa(de)==="normal"?1:2,xe=Ot(),Ue=xe?`+1d${xe.sides}`:"";$s(de,`${H}d${n}${Ue}`),At()}}function vt(){var xe;const H=((xe=B==null?void 0:B.value)==null?void 0:xe.trim())||Xr(de);$s(de,H),At()}function Wt(){se.lastRoll&&Vt(se.lastRoll)}async function sn(){!se.inspirationAvailable||se.inspirationConsumed||_!=null&&_.checked&&(se.inspirationConsumed=!0,Ge(!1),typeof f=="function"&&await f())}function Vt(V){var yt,Yt,ft;const H=Number((yt=Te())==null?void 0:yt.value)||0;if(r!=="generic"){const Le=Se(V);if(se.lastBuff=Le.buff,!Le.baseRolls.length){At();return}const bn=((Yt=Le.buff)==null?void 0:Yt.delta)||0,Qt=(Le.picked??0)+H+bn,Xt=Le.rollMode==="advantage"?"Vantaggio":Le.rollMode==="disadvantage"?"Svantaggio":"Normale",_n=Le.baseRolls.join(", ");if(te&&(te.textContent=`${Qt}`),ne){const hn=Le.baseRolls.length>1?` (selezionato ${Le.picked})`:"",je=[`${Xt}: ${_n}${hn}`,`Mod ${Qr(H)}`];Le.buff&&je.push(`${Le.buff.label} (d${Le.buff.sides}: ${Le.buff.roll})`),ne.textContent=je.join("  ")}return}const xe=V.result||[],Ue=xe.reduce((Le,bn)=>Le+bn,0),it=Number(V.constant)||0,Y=((ft=se.lastBuff)==null?void 0:ft.delta)||0,Rt=Ue+it+H+Y,Jt=xe.length?`Dadi: ${xe.join(", ")}`:"Dadi: ";if(te&&(te.textContent=`${Rt}`),ne){const Le=[Jt];it&&Le.push(`Costante ${Qr(it)}`),H&&Le.push(`Mod ${Qr(H)}`),se.lastBuff&&Le.push(`${se.lastBuff.label} ${Qr(se.lastBuff.delta)} (d${se.lastBuff.sides}: ${se.lastBuff.roll})`),ne.textContent=Le.join("  ")}}function St(V){var Jt,yt,Yt;const H=Number((Jt=Te())==null?void 0:Jt.value)||0;if(r!=="generic"){const ft=Se(V);if(se.lastBuff=ft.buff,!ft.baseRolls.length)return null;const Le=((yt=ft.buff)==null?void 0:yt.delta)||0;return{value:ft.picked,total:(ft.picked??0)+H+Le}}const Ue=(V.result||[]).reduce((ft,Le)=>ft+Le,0),it=Number(V.constant)||0,Y=((Yt=se.lastBuff)==null?void 0:Yt.delta)||0,Rt=Ue+it;return{value:Rt,total:Rt+H+Y}}_&&(_.onchange=()=>{Qe(),dt()}),I&&(I.onchange=()=>{Ht(),dt()}),O&&(O.oninput=Wt),D&&(D.oninput=Wt),B&&(B.oninput=vt),L&&(L.onchange=()=>{const V=se.selectionOptions.find(H=>H.value===L.value);V&&O&&(O.value=Number(V.modifier)||0),Wt()});const Je=de.querySelector('[name="dice-count"]');Je&&(Je.oninput=()=>{const V=Xr(de);B&&(B.value=V),vt()});const Ut=de.querySelector('[name="dice-type"]');Ut&&(Ut.onchange=()=>{const V=Xr(de);B&&(B.value=V),vt()}),me&&(me.onchange=()=>{se.lastBuff=null,dt()}),qe&&(qe.onclick=()=>{const V=!(ge!=null&&ge.classList.contains("is-open"));ct(V)}),Bt(),Mt(),Ge(se.inspirationAvailable),re(),Qe(),We(),Ve(),ct(!1),de.removeAttribute("hidden");const Oe=o!=null&&o!=="",Fe=Te();Fe&&Oe&&Number.isFinite(Number(o))&&(Fe.value=Number(o)),r==="generic"?(B&&i&&(B.value=String(i).trim(),id(de,B.value)),B&&!B.value&&(B.value=Xr(de)),vt()):dt();const He=de.querySelector("#result");let Ze=null,De;const un=new Promise(V=>{De=V}),Gt=()=>{const V=ed((He==null?void 0:He.textContent)||"");V!=null&&(Ze=V,sn(),e||nr(),ce(),De(V))},ht=He?new MutationObserver(Gt):null;ht==null||ht.observe(He,{childList:!0,characterData:!0,subtree:!0});function ce(){try{ht==null||ht.disconnect()}catch{}}const $t=V=>{if(!(!de||de.hasAttribute("hidden"))&&(se.lastRoll=V.detail||null,se.lastBuff=null,se.lastRoll&&(sn(),Vt(se.lastRoll)),se.lastRoll)){const H=St(se.lastRoll);H&&gt({type:m||"GEN",subtype:Ee(),inspired:se.inspirationConsumed,value:H.value,total:H.total,timestamp:new Date().toISOString()})}};window.addEventListener("diceRoll",$t);const Pe=nr;return nr=function(){ce(),window.removeEventListener("diceRoll",$t),de&&de.setAttribute("hidden",""),Ze==null&&(De==null||De(null)),nr=Pe},{waitForRoll:un,close:()=>{ce(),Pe()}}}function yo(n){n.key==="Escape"&&nr()}function nr(){de&&(document.removeEventListener("keydown",yo,!0),de.setAttribute("hidden",""))}const an={str:"FOR",dex:"DES",con:"COS",int:"INT",wis:"SAG",cha:"CAR"},sa=[{key:"acrobatics",label:"Acrobazia",ability:"dex"},{key:"animal_handling",label:"Addestrare animali",ability:"wis"},{key:"arcana",label:"Arcano",ability:"int"},{key:"athletics",label:"Atletica",ability:"str"},{key:"deception",label:"Inganno",ability:"cha"},{key:"history",label:"Storia",ability:"int"},{key:"insight",label:"Intuizione",ability:"wis"},{key:"intimidation",label:"Intimidire",ability:"cha"},{key:"investigation",label:"Indagare",ability:"int"},{key:"medicine",label:"Medicina",ability:"wis"},{key:"nature",label:"Natura",ability:"int"},{key:"perception",label:"Percezione",ability:"wis"},{key:"performance",label:"Intrattenere",ability:"cha"},{key:"persuasion",label:"Persuasione",ability:"cha"},{key:"religion",label:"Religione",ability:"int"},{key:"sleight_of_hand",label:"Rapidit di mano",ability:"dex"},{key:"stealth",label:"Furtivit",ability:"dex"},{key:"survival",label:"Sopravvivenza",ability:"wis"}],oa=[{key:"str",label:"Forza"},{key:"dex",label:"Destrezza"},{key:"con",label:"Costituzione"},{key:"int",label:"Intelligenza"},{key:"wis",label:"Saggezza"},{key:"cha",label:"Carisma"}],fi=[{key:"weapon_simple",label:"Armi semplici"},{key:"weapon_martial",label:"Armi da guerra"},{key:"armor_light",label:"Armature leggere"},{key:"armor_medium",label:"Armature medie"},{key:"armor_heavy",label:"Armature pesanti"},{key:"shield",label:"Scudi"}],ea=[{label:"Azione Gratuita",className:"resource-chip--free"},{label:"Azione Bonus",className:"resource-chip--bonus"},{label:"Reazione",className:"resource-chip--reaction"},{label:"Azione",className:"resource-chip--action"}];function wi(n){return n?n.split(/[,;\n]/).map(e=>e.trim()).filter(Boolean):[]}function od(n){if(!n)return{tools:[],languages:[]};const e=n.replace(/\r/g,""),t=/(lingue|lingua|strumenti|strumento)\s*:/gi,r={tools:[],languages:[]};let i=0,o=null,l;const d=(f,m)=>{if(!f||!m)return;const v=m.split(/[,;\n]/).map(y=>y.trim()).filter(Boolean);r[f].push(...v)};for(;(l=t.exec(e))!==null;)o&&d(o,e.slice(i,l.index)),o=l[1].toLowerCase().startsWith("ling")?"languages":"tools",i=t.lastIndex;return o?(d(o,e.slice(i)),r):{tools:wi(n),languages:[]}}function lt(n){if(n==null||n==="")return null;const e=Number(n);return Number.isNaN(e)?null:e}function Dt(n){const e=lt(n);return e===null?null:Math.floor((e-10)/2)}function Ar(n,e,t){const r=Dt(n);if(r===null)return null;const i=t>0&&e!==null?e*t:0;return r+i}function ld(n,e,t,r){const i=!!t.perception,o=!!r.perception,l=Ar(n.wis,e,i?o?2:1:0);return l===null?null:10+l}function bo(n){if(!n||typeof n!="string")return null;const e=n.trim().match(/d(\d+)/i);if(!e)return null;const t=Number(e[1]);return Number.isNaN(t)?null:t}function cd(n){return Math.floor(Math.random()*n)+1}function _o(n){if(!n||typeof n!="string")return null;const e=n.trim().match(/(\d+)d(\d+)/i);if(!e)return null;const t=Number(e[1]),r=Number(e[2]);return!Number.isFinite(t)||!Number.isFinite(r)||!t||!r?null:{count:t,sides:r}}function ot(n){return n==null||Number.isNaN(n)?"-":n>=0?`+${n}`:`${n}`}function ud(n){const e=Dt(n);return ot(e)}function dd(n){if(!n)return"-";const e=n.used??"-",t=n.max??"-",r=n.die?` ${n.die}`:"";return e==="-"&&t==="-"&&!r?"-":e==="-"||t==="-"?`${e} / ${t}${r}`:`${Math.max(Number(t)-Number(e),0)} / ${t}${r}`}function hd(n,e,t){const r=(t||[]).filter(w=>w.equipable&&ki(w).length),i=Dt(e.dex)??0,o=n.ac_ability_modifiers||{},l=Object.keys(o).filter(w=>o[w]).reduce((w,N)=>w+(Dt(e[N])??0),0),d=lt(n.ac_bonus)??0,f=r.filter(w=>w.category==="armor"&&!w.is_shield),m=r.filter(w=>w.is_shield).reduce((w,N)=>w+(Number(N.shield_bonus)||0),0),v=f.map(w=>{const N=Number(w.armor_class);if(!N)return null;const I=Number(w.armor_bonus)||0;return w.armor_type==="heavy"?N+I:w.armor_type==="medium"?N+I+Math.min(i,2):N+I+i}).filter(w=>w!==null),y=v.length?Math.max(...v):null,_=lt(n.ac);return(y??_??10+i+l)+m+d}function ki(n){if(!n)return[];if(Array.isArray(n.equip_slots))return n.equip_slots.filter(Boolean);if(typeof n.equip_slots=="string"&&n.equip_slots.trim())try{const e=JSON.parse(n.equip_slots);if(Array.isArray(e))return e.filter(Boolean)}catch{return[n.equip_slots]}return n.equip_slot?[n.equip_slot]:[]}function fd(n){if((Number(n.max_uses)||0)===0)return"Passiva";const t=Number(n.recovery_short),r=Number(n.recovery_long),i=!Number.isNaN(t)&&t>0,o=!Number.isNaN(r)&&r>0;if((n.reset_on==="none"||n.reset_on===null)&&!i&&!o)return"Nessuna ricarica";if(!i&&!o)return n.reset_on==="short_rest"?"Recupera tutte le cariche (riposo breve)":"Recupera tutte le cariche (riposo lungo)";const l=[];return i&&l.push(`Riposo breve +${t}`),o&&l.push(`Riposo lungo +${r}`),l.join("  ")}function wo(n){return[...n].sort((e,t)=>{const r=Number(e.level)-Number(t.level);return r!==0?r:(e.name??"").localeCompare(t.name??"","it",{sensitivity:"base"})})}function ko(n){return n.kind==="cantrip"||Number(n.level)===0?"Trucchetto":"Incantesimo"}function pd(n,e){var y;if(!n||!e)return null;const t=n.data||{},r=e.weapon_range||(e.range_normal?"ranged":"melee"),i=e.attack_ability||(r==="ranged"?"dex":"str"),o=Dt((y=t.abilities)==null?void 0:y[i])??0,l=Number(t.damage_bonus_melee??t.damage_bonus)||0,d=Number(t.damage_bonus_ranged??t.damage_bonus)||0,f=r==="ranged"?d:l,m=o+(Number(e.damage_modifier)||0)+f,v=_o(e.damage_die);return v?{title:`Danni ${e.name}`,notation:`${v.count}d${v.sides}`,modifier:m}:null}function md(n){if(!n)return null;const e=_o(n.damage_die);if(!e)return null;const t=Number(n.damage_modifier)||0;return{title:`Danni ${n.name}`,notation:`${e.count}d${e.sides}`,modifier:t}}function gd(n){if(!n)return null;const e=n.hit_dice||{},t=Number(e.max)||0,r=Number(e.used)||0;if(!t||!r)return null;const i=Math.floor(t/2);if(!i)return null;const o=Math.max(r-Math.min(i,r),0);return o===r?null:{...e,used:o}}function vd(n){if(!n)return null;let e=!1;const t=n.hp||{},r=lt(t.max),i={...n};r!=null&&(Number(t.current)||0)!==r&&(i.hp={...t,current:r},e=!0);const o=gd(n);return o&&(i.hit_dice=o,e=!0),e?i:null}function yd(n,e){if(!n)return null;let t=n;e==="long_rest"&&(t=vd(n)||n);const r=bd(t,e);return r&&(t=r),t===n?null:t}function bd(n,e){if(!n)return null;const t=n.spellcasting||{};if(!t||!t.slots)return null;const r=t.recharge||"long_rest";if(!(e==="long_rest"||r==="short_rest"))return null;const o=Array.from({length:9},(m,v)=>v+1),l={...t.slots||{}},d={...t.slots_max||{}};let f=!1;return o.forEach(m=>{const v=Math.max(0,Number(l[m])||0),y=Number(d[m]),_=Number.isFinite(y)&&y>0?y:v;_!==y&&(d[m]=_,f=!0),_>0&&v!==_&&(l[m]=_,f=!0)}),f?{...n,spellcasting:{...t,slots:l,slots_max:d}}:null}async function pi(n,e,t=null){var Yt,ft,Le,bn,Qt,Xt,_n,hn,je,et,xr,An,xn,On;if(!n)return;const r=(t==null?void 0:t.data)||{},i=r.hp||{},o=r.hit_dice||{},l=r.abilities||{},d=r.skills||{},f=r.skill_mastery||{},m=r.saving_throws||{},v=r.proficiencies||{},y=r.ac_ability_modifiers||{},_=r.spellcasting||{},C=_.slots||{},w=Array.isArray(r.spells)?wo(r.spells):[],N=document.createElement("div");N.className="character-edit-form";const I=(G,ue)=>{const $e=document.createElement("section");$e.className="character-edit-group",$e.innerHTML=`<h3>${G}</h3>`;const Re=document.createElement("div");return Re.className="character-edit-group__content",ue.forEach(tt=>{tt.classList.add("character-edit-subsection"),Re.appendChild(tt)}),$e.appendChild(Re),$e},O=document.createElement("div");O.className="character-edit-section",O.innerHTML="<h4>Dati principali</h4>";const U=ie({label:"Nome",name:"name",placeholder:"Es. Aria",value:(t==null?void 0:t.name)??""});U.querySelector("input").required=!0,O.appendChild(U),O.appendChild(ie({label:"Sistema",name:"system",placeholder:"Es. D&D 5e",value:(t==null?void 0:t.system)??""}));const D=document.createElement("div");D.className="character-edit-grid",D.appendChild(ie({label:"Livello",name:"level",type:"number",value:r.level??""})),D.appendChild(ie({label:"Razza",name:"race",value:r.race??""})),D.appendChild(ie({label:"Allineamento",name:"alignment",value:r.alignment??""})),D.appendChild(ie({label:"Background",name:"background",value:r.background??""})),D.appendChild(ie({label:"Classe",name:"class_name",value:r.class_name??r.class_archetype??""})),D.appendChild(ie({label:"Archetipo",name:"archetype",value:r.archetype??""})),O.appendChild(D),O.appendChild(ie({label:"Foto (URL)",name:"avatar_url",placeholder:"https://.../ritratto.png",value:r.avatar_url??""})),O.appendChild(vn({label:"Descrizione background",name:"description",placeholder:"Dettagli sul background, origini e tratti distintivi...",value:r.description??""}));const B=document.createElement("div");B.className="character-edit-section",B.innerHTML="<h4>Statistiche base</h4>";const K=document.createElement("div");K.className="character-edit-grid",K.appendChild(ie({label:"Bonus competenza",name:"proficiency_bonus",type:"number",value:r.proficiency_bonus??""})),K.appendChild(ie({label:"Iniziativa",name:"initiative",type:"number",value:r.initiative??""})),K.appendChild(ie({label:"Classe Armatura",name:"ac",type:"number",value:r.ac??""})),K.appendChild(ie({label:"Velocit",name:"speed",type:"number",value:r.speed??""})),K.appendChild(ie({label:"HP attuali",name:"hp_current",type:"number",value:i.current??""})),K.appendChild(ie({label:"HP temporanei",name:"hp_temp",type:"number",value:i.temp??""})),K.appendChild(ie({label:"HP massimi",name:"hp_max",type:"number",value:i.max??""})),K.appendChild(ie({label:"Dado vita (es. d8)",name:"hit_dice_die",value:o.die??""})),K.appendChild(ie({label:"Dadi vita totali",name:"hit_dice_max",type:"number",value:o.max??""})),K.appendChild(ie({label:"Dadi vita usati",name:"hit_dice_used",type:"number",value:o.used??""})),B.appendChild(K);const M=document.createElement("div");M.className="character-edit-section",M.innerHTML=`
    <h4>Opzioni CA base</h4>
    <p class="muted">Base = 10 + Destrezza. Seleziona eventuali modificatori extra.</p>
    <div class="character-saving-grid">
      ${[{key:"str",label:"Forza"},{key:"con",label:"Costituzione"},{key:"int",label:"Intelligenza"},{key:"wis",label:"Saggezza"},{key:"cha",label:"Carisma"}].map(G=>`
        <label class="toggle-pill">
          <input type="checkbox" name="ac_mod_${G.key}" ${y[G.key]?"checked":""} />
          <span>${G.label}</span>
        </label>
      `).join("")}
    </div>
  `,M.appendChild(ie({label:"Modificatore CA totale",name:"ac_bonus",type:"number",value:r.ac_bonus??0}));const L=document.createElement("div");L.className="character-edit-section",L.innerHTML="<h4>Caratteristiche</h4>";const te=document.createElement("div");te.className="character-edit-grid",te.appendChild(ie({label:"Forza",name:"ability_str",type:"number",value:l.str??""})),te.appendChild(ie({label:"Destrezza",name:"ability_dex",type:"number",value:l.dex??""})),te.appendChild(ie({label:"Costituzione",name:"ability_con",type:"number",value:l.con??""})),te.appendChild(ie({label:"Intelligenza",name:"ability_int",type:"number",value:l.int??""})),te.appendChild(ie({label:"Saggezza",name:"ability_wis",type:"number",value:l.wis??""})),te.appendChild(ie({label:"Carisma",name:"ability_cha",type:"number",value:l.cha??""})),L.appendChild(te);const ne=document.createElement("div");ne.className="character-edit-section",ne.innerHTML=`
    <h4>Competenze e maestria</h4>
    <div class="character-skill-grid">
      ${sa.map(G=>{const ue=!!d[G.key],$e=!!f[G.key];return`
        <div class="character-skill-row">
          <div>
            <strong>${G.label}</strong>
            <span class="muted">${an[G.ability]}</span>
          </div>
          <div class="character-toggle-group">
            <label class="toggle-pill">
              <input type="checkbox" name="skill_${G.key}" ${ue?"checked":""} />
              <span>Competenza</span>
            </label>
            <label class="toggle-pill">
              <input type="checkbox" name="mastery_${G.key}" ${$e?"checked":""} />
              <span>Maestria</span>
            </label>
          </div>
        </div>
      `}).join("")}
    </div>
  `;const we=document.createElement("div");we.className="character-edit-section",we.innerHTML=`
    <h4>Tiri salvezza</h4>
    <div class="character-saving-grid">
      ${oa.map(G=>{const ue=!!m[G.key];return`
        <label class="toggle-pill">
          <input type="checkbox" name="save_${G.key}" ${ue?"checked":""} />
          <span>${G.label}</span>
        </label>
      `}).join("")}
    </div>
  `;const me=document.createElement("div");me.className="character-edit-section",me.innerHTML=`
    <h4>Competenze equipaggiamento</h4>
    <div class="character-saving-grid">
      ${fi.map(G=>{const ue=!!v[G.key];return`
        <label class="toggle-pill">
          <input type="checkbox" name="prof_${G.key}" ${ue?"checked":""} />
          <span>${G.label}</span>
        </label>
      `}).join("")}
    </div>
  `;const he=document.createElement("div");he.className="character-edit-section",he.innerHTML="<h4>Combattimento e magia</h4>";const ge=document.createElement("div");ge.className="character-edit-grid",ge.appendChild(ie({label:"Bonus attacco extra (mischia)",name:"attack_bonus_melee",type:"number",value:r.attack_bonus_melee??r.attack_bonus??0})),ge.appendChild(ie({label:"Bonus attacco extra (distanza)",name:"attack_bonus_ranged",type:"number",value:r.attack_bonus_ranged??r.attack_bonus??0})),ge.appendChild(ie({label:"Attacchi extra",name:"extra_attacks",type:"number",value:r.extra_attacks??0})),ge.appendChild(ie({label:"Bonus danni extra (mischia)",name:"damage_bonus_melee",type:"number",value:r.damage_bonus_melee??r.damage_bonus??0})),ge.appendChild(ie({label:"Bonus danni extra (distanza)",name:"damage_bonus_ranged",type:"number",value:r.damage_bonus_ranged??r.damage_bonus??0})),he.appendChild(ge);const qe=document.createElement("label");qe.className="checkbox",qe.innerHTML='<input type="checkbox" name="is_spellcaster" /> <span>Incantatore</span>';const Be=qe.querySelector("input");Be&&(Be.checked=!!r.is_spellcaster),he.appendChild(qe);const Me=document.createElement("div");Me.className="character-edit-section spellcasting-section",Me.innerHTML="<h4>Incantesimi</h4>";const se=document.createElement("div");se.className="character-edit-grid";const ve=document.createElement("label");ve.className="field",ve.innerHTML="<span>Caratteristica da incantatore</span>";const be=rn([{value:"",label:"Seleziona..."},{value:"int",label:"Intelligenza"},{value:"wis",label:"Saggezza"},{value:"cha",label:"Carisma"},{value:"str",label:"Forza"},{value:"dex",label:"Destrezza"},{value:"con",label:"Costituzione"}],_.ability??"");be.name="spellcasting_ability",ve.appendChild(be),se.appendChild(ve);const Te=ie({label:"CD incantesimi",name:"spell_save_dc",type:"number",value:""}),We=Te.querySelector("input");We&&(We.readOnly=!0,We.disabled=!0),se.appendChild(Te);const At=ie({label:"Tiro per colpire incantesimi",name:"spell_attack_bonus",type:"number",value:""}),Ve=At.querySelector("input");Ve&&(Ve.readOnly=!0,Ve.disabled=!0),se.appendChild(At),Me.appendChild(se);const gt=document.createElement("div");gt.className="character-edit-grid",Array.from({length:9},(G,ue)=>ue+1).forEach(G=>{gt.appendChild(ie({label:`Slot ${G}`,name:`spell_slot_${G}`,type:"number",value:C[G]??0}))}),Me.appendChild(gt);const Qe=document.createElement("label");Qe.className="field",Qe.innerHTML="<span>Ricarica slot</span>";const Ge=rn([{value:"short_rest",label:"Riposo breve"},{value:"long_rest",label:"Riposo lungo"}],_.recharge??"long_rest");Ge.name="spell_slot_recharge",Qe.appendChild(Ge),Me.appendChild(Qe),Me.appendChild(vn({label:"Incantesimi (note)",name:"spell_notes",placeholder:"Descrivi gli incantesimi noti/preparati e gli slot principali.",value:r.spell_notes??""}));const Bt=document.createElement("div");Bt.className="character-edit-section",Bt.innerHTML=`
    <h4>Gestione incantesimi</h4>
    ${w.length?`
      <p class="muted">Seleziona gli incantesimi da rimuovere.</p>
      <div class="character-edit-spell-list">
        ${w.map(G=>`
          <label class="character-edit-spell-row">
            <input type="checkbox" name="remove_spell_${G.id}" />
            <span>
              <strong>${G.name}</strong>
              <small>${ko(G)}  Livello ${Number(G.level)||0}</small>
            </span>
          </label>
        `).join("")}
      </div>
    `:'<p class="muted">Nessun incantesimo configurato.</p>'}
  `,he.appendChild(Me),he.appendChild(Bt);const Ht={str:L.querySelector('input[name="ability_str"]'),dex:L.querySelector('input[name="ability_dex"]'),con:L.querySelector('input[name="ability_con"]'),int:L.querySelector('input[name="ability_int"]'),wis:L.querySelector('input[name="ability_wis"]'),cha:L.querySelector('input[name="ability_cha"]')},re=B.querySelector('input[name="proficiency_bonus"]'),Mt=()=>{var Zt;const G=be.value,ue=G?(Zt=Ht[G])==null?void 0:Zt.value:null,$e=Dt(ue),Re=lt(re==null?void 0:re.value),tt=$e===null||Re===null?"":String(8+$e+Re),pa=$e===null||Re===null?"":String($e+Re);We&&(We.value=tt),Ve&&(Ve.value=pa)},Ot=()=>{Be&&(Me.style.display=Be.checked?"":"none")};Be==null||Be.addEventListener("change",Ot),be.addEventListener("change",Mt),Object.values(Ht).forEach(G=>G==null?void 0:G.addEventListener("input",Mt)),re==null||re.addEventListener("input",Mt),Ot(),Mt();const Se=document.createElement("div");Se.className="character-edit-section",Se.appendChild(vn({label:"Competenze (strumenti, lingue, ecc.)",name:"proficiency_notes",placeholder:"Es. Strumenti: kit da ladro, strumenti musicali; Lingue: comune, elfico",value:r.proficiency_notes??""}));const ct=document.createElement("div");ct.className="character-edit-section",ct.appendChild(vn({label:"Lingue conosciute",name:"language_proficiencies",placeholder:"Es. comune, elfico, draconico",value:r.language_proficiencies??""}));const Ee=document.createElement("div");Ee.className="character-edit-section",Ee.appendChild(vn({label:"Talenti",name:"talents",placeholder:"Es. Maestro d'armi, Tiratore scelto",value:r.talents??""}));const dt=[{title:"Identit e background",content:I("Identit e background",[O])},{title:"Statistiche e difese",content:I("Statistiche e difese",[B,M])},{title:"Caratteristiche e competenze",content:I("Caratteristiche e competenze",[L,ne,we,me])},{title:"Combattimento e magia",content:I("Combattimento e magia",[he])},{title:"Note e dettagli",content:I("Note e dettagli",[Se,ct,Ee])}],vt=document.createElement("div");vt.className="character-edit-stepper";const Wt=document.createElement("ol");Wt.className="character-edit-stepper-nav";const sn=document.createElement("div");sn.className="character-edit-stepper-content";const Vt=document.createElement("div");Vt.className="character-edit-stepper-actions";const St=document.createElement("button");St.type="button",St.className="secondary",St.textContent="Indietro";const Je=document.createElement("button");Je.type="button",Je.className="primary",Je.textContent="Avanti",Vt.append(St,Je);const Ut=[],Oe=[];dt.forEach((G,ue)=>{const $e=document.createElement("li"),Re=document.createElement("button");Re.type="button",Re.className="character-edit-stepper-button",Re.innerHTML=`<span class="step-index">${ue+1}</span><span>${G.title}</span>`,$e.appendChild(Re),Wt.appendChild($e),Ut.push(Re);const tt=document.createElement("div");tt.className="character-edit-step",tt.dataset.step=String(ue),tt.appendChild(G.content),sn.appendChild(tt),Oe.push(tt)});const Fe=G=>Array.from(G.querySelectorAll("input, select, textarea")),He=G=>{const ue=Fe(G);return ue.length?ue.filter($e=>$e.required).every($e=>$e.checkValidity()):!0};let Ze=0;const De=()=>{const G=Oe.map(Re=>He(Re)),ue=G.findIndex(Re=>!Re),$e=ue===-1?Oe.length-1:ue;Oe.forEach((Re,tt)=>{Re.classList.toggle("is-active",tt===Ze)}),Ut.forEach((Re,tt)=>{Re.classList.toggle("is-active",tt===Ze),Re.classList.toggle("is-complete",G[tt]),Re.disabled=tt>$e}),St.disabled=Ze===0,Je.disabled=!G[Ze]||Ze>=Oe.length-1},un=G=>{var ue;Ze=Math.min(Math.max(G,0),Oe.length-1),De(),(ue=Oe[Ze])==null||ue.scrollIntoView({behavior:"smooth",block:"start"})};Ut.forEach((G,ue)=>{G.addEventListener("click",()=>un(ue))}),St.addEventListener("click",()=>un(Ze-1)),Je.addEventListener("click",()=>un(Ze+1)),N.addEventListener("input",De),N.addEventListener("change",De),vt.append(Wt,sn,Vt),N.appendChild(vt),De();const Gt=document.querySelector("[data-form-modal]"),ht=Gt==null?void 0:Gt.querySelector(".modal-card");ht==null||ht.classList.add("modal-card--wide");const ce=await cn({title:t?"Modifica personaggio":"Nuovo personaggio",submitLabel:t?"Salva":"Crea",content:N});if(ht==null||ht.classList.remove("modal-card--wide"),!ce)return;const $t=(Yt=ce.get("name"))==null?void 0:Yt.trim();if(!$t){le("Inserisci un nome per il personaggio","error");return}const Pe=G=>G===""?null:Number(G),dn={...r.skills},V={...r.skill_mastery};sa.forEach(G=>{const ue=ce.has(`mastery_${G.key}`),$e=ce.has(`skill_${G.key}`)||ue;dn[G.key]=$e,V[G.key]=ue&&$e});const H={...r.saving_throws};oa.forEach(G=>{H[G.key]=ce.has(`save_${G.key}`)});const xe={...r.proficiencies};fi.forEach(G=>{xe[G.key]=ce.has(`prof_${G.key}`)});const Ue={...r.ac_ability_modifiers};["str","con","int","wis","cha"].forEach(G=>{Ue[G]=ce.has(`ac_mod_${G}`)});const it=ce.get("is_spellcaster")==="on",Y=Array.from({length:9},(G,ue)=>ue+1),Rt=it?{ability:ce.get("spellcasting_ability")||null,recharge:ce.get("spell_slot_recharge")||"long_rest",slots:Y.reduce((G,ue)=>(G[ue]=Pe(ce.get(`spell_slot_${ue}`))??0,G),{}),slots_max:Y.reduce((G,ue)=>(G[ue]=Pe(ce.get(`spell_slot_${ue}`))??0,G),{})}:r.spellcasting??null,Jt={...r,avatar_url:((ft=ce.get("avatar_url"))==null?void 0:ft.trim())||null,description:((Le=ce.get("description"))==null?void 0:Le.trim())||null,hp:{current:Pe(ce.get("hp_current")),temp:Pe(ce.get("hp_temp")),max:Pe(ce.get("hp_max"))},hit_dice:{die:((bn=ce.get("hit_dice_die"))==null?void 0:bn.trim())||null,max:Pe(ce.get("hit_dice_max")),used:Pe(ce.get("hit_dice_used"))},ac:Pe(ce.get("ac")),level:Pe(ce.get("level")),race:((Qt=ce.get("race"))==null?void 0:Qt.trim())||null,alignment:((Xt=ce.get("alignment"))==null?void 0:Xt.trim())||null,background:((_n=ce.get("background"))==null?void 0:_n.trim())||null,class_name:((hn=ce.get("class_name"))==null?void 0:hn.trim())||null,archetype:((je=ce.get("archetype"))==null?void 0:je.trim())||null,speed:Pe(ce.get("speed")),proficiency_bonus:Pe(ce.get("proficiency_bonus")),initiative:Pe(ce.get("initiative")),attack_bonus_melee:Pe(ce.get("attack_bonus_melee"))??0,attack_bonus_ranged:Pe(ce.get("attack_bonus_ranged"))??0,extra_attacks:Pe(ce.get("extra_attacks"))??0,damage_bonus_melee:Pe(ce.get("damage_bonus_melee"))??0,damage_bonus_ranged:Pe(ce.get("damage_bonus_ranged"))??0,ac_bonus:Pe(ce.get("ac_bonus"))??0,is_spellcaster:it,spell_notes:((et=ce.get("spell_notes"))==null?void 0:et.trim())||null,spellcasting:Rt,ac_ability_modifiers:Ue,proficiency_notes:((xr=ce.get("proficiency_notes"))==null?void 0:xr.trim())||null,language_proficiencies:((An=ce.get("language_proficiencies"))==null?void 0:An.trim())||null,talents:((xn=ce.get("talents"))==null?void 0:xn.trim())||null,spells:w.filter(G=>!ce.has(`remove_spell_${G.id}`)),abilities:{str:Pe(ce.get("ability_str")),dex:Pe(ce.get("ability_dex")),con:Pe(ce.get("ability_con")),int:Pe(ce.get("ability_int")),wis:Pe(ce.get("ability_wis")),cha:Pe(ce.get("ability_cha"))},skills:dn,skill_mastery:V,saving_throws:H,proficiencies:xe},yt={name:$t,system:((On=ce.get("system"))==null?void 0:On.trim())||null,data:Jt};try{if(t){const G=await uo(t.id,yt),ue=kt().characters.map($e=>$e.id===G.id?G:$e);zt({characters:ue}),await Kt({characters:ue}),le("Personaggio aggiornato")}else{const G=await zu({...yt,user_id:n.id}),ue=[...kt().characters,G];zt({characters:ue}),ua(G.id),await Kt({characters:ue}),le("Personaggio creato")}e()}catch{le(t?"Errore aggiornamento personaggio":"Errore creazione personaggio","error")}}function _d(n,e){return n?`
    <div>
      <p>Non hai ancora un personaggio.</p>
      <div class="button-row">
        <button class="primary" data-create-character>Nuovo personaggio</button>
      </div>
    </div>
  `:`<p class="muted">${e?"Modalit offline attiva: crea un personaggio quando torni online.":"Accedi per creare un personaggio."}</p>`}function wd(n,e,t=[]){var se;const r=n.data||{},i=r.hp||{},o=r.hit_dice||{},l=r.abilities||{},d=lt(r.proficiency_bonus),f=!!r.inspiration,m=r.initiative??Dt(l.dex),v=r.skills||{},y=r.skill_mastery||{},_=ld(l,d,v,y),C=lt(i.current),w=lt(i.max),N=lt(i.temp),I=r.death_saves||{},O=Math.max(0,Math.min(3,Number(I.successes)||0)),U=Math.max(0,Math.min(3,Number(I.failures)||0)),D=w?Math.min(Math.max(Number(C)/w*100,0),100):0,B=Math.max(0,Number(N)||0),K=Math.max(0,Number(w??C??0)),M=B>0,L=M?100:0,te=M?K:1,ne=M?B:0,we=w?`${C??"-"}/${w}`:`${C??"-"}`,me=N??"-",he=Math.max(0,Math.min(6,Number(i.weak_points)||0)),ge=[{value:1,description:"Svantaggio sulle prove di caratteristica."},{value:2,description:"Velocit dimezzata."},{value:3,description:"Svantaggio sui tiri per colpire e tiri salvezza."},{value:4,description:"Punti ferita massimi dimezzati."},{value:5,description:"Velocit ridotta a 0."},{value:6,description:"Morte."}],qe=((se=ge.find(ve=>ve.value===he))==null?void 0:se.description)||"Nessun indebolimento.",Be=hd(r,l,t),Me=[{key:"str",label:an.str,value:l.str},{key:"dex",label:an.dex,value:l.dex},{key:"con",label:an.con,value:l.con},{key:"int",label:an.int,value:l.int},{key:"wis",label:an.wis,value:l.wis},{key:"cha",label:an.cha,value:l.cha}];return`
    <div class="character-overview">
      <div class="character-summary">
        <div class="character-hero">
          ${r.avatar_url?`<img class="character-avatar" src="${r.avatar_url}" alt="Ritratto di ${n.name}" />`:""}
          <div>
            <h3 class="character-name">${n.name}</h3>
            <div class="character-meta">
              <span class="meta-tag">Livello ${r.level??"-"}</span>
              <span class="meta-tag">Razza ${r.race??"-"}</span>
              <span class="meta-tag">Classe ${r.class_name??r.class_archetype??"-"}</span>
              <span class="meta-tag">Archetipo ${r.archetype??"-"}</span>
              <span class="meta-tag">Allineamento ${r.alignment??"-"}</span>
              <span class="meta-tag">Background ${r.background??"-"}</span>
            </div>
          </div>
        </div>
        <div class="character-summary-actions">
          <div class="proficiency-chip">
            <span>Bonus competenza</span>
            <strong>${ot(d)}</strong>
          </div>
          <div class="inspiration-chip">
            <span>Ispirazione</span>
            <button
              class="inspiration-toggle"
              type="button"
              data-toggle-inspiration
              aria-pressed="${f}"
              aria-label="Imposta ispirazione"
              ${e?"":"disabled"}
            >
              <span class="inspiration-toggle__icon" aria-hidden="true"></span>
            </button>
          </div>
          <button class="ghost-button background-button" type="button" data-show-background>
            Background
          </button>
        </div>
      </div>
      <div class="stat-panel">     
        <div class="stat-grid stat-grid--compact stat-grid--abilities">
          ${Me.map(ve=>{const be=lt(ve.value),Te=be===null?"-":ud(be);return`
            <div class="stat-card stat-card--${ve.key}">
              <span>${ve.label}</span>
              <strong>${be??"-"}</strong>
              <span class="stat-card__modifier" aria-label="Modificatore ${ve.label}">${Te}</span>
            </div>
          `}).join("")}
        </div>
      </div>
      <div class="hp-panel">
        <div class="hp-bar-row">
          <div class="armor-class-card">
            <span>CA</span>
            <strong>${Be??"-"}</strong>
            <span class="armor-class-card__sigil" aria-hidden="true"></span>
          </div>
          <div class="armor-class-card armor-class-card--initiative">
            <span>Iniz</span>
            <strong>${ot(lt(m))}</strong>
            <span class="armor-class-card__sigil" aria-hidden="true"></span>
          </div>
          <div class="hp-bar-stack">
            <div class="hp-bar-label">
              <span>HP</span>
              <strong>${we}</strong>
              <span class="hp-bar-label__divider" aria-hidden="true"></span>
              <span class="hp-bar-label__temp-group ${M?"is-active":""}">
                <span class="hp-bar-label__temp">HP temporanei</span>
                <strong>${me}</strong>
              </span>
            </div>
            <div class="hp-bar-track">
              <div class="hp-bar" style="flex: ${te};">
                <div class="hp-bar__fill" style="width: ${D}%;"></div>
              </div>
              ${M?`
              <div class="hp-bar hp-bar--temp is-active" style="flex: ${ne};">
                <div class="hp-bar__fill hp-bar__fill--temp" style="width: ${L}%;"></div>
              </div>
              `:""}
            </div>
            <div class="hp-panel-hit-dice">
              <span>Dadi vita</span>
              <strong>${dd(o)}</strong>
            </div>
          </div>
        </div>
        <div class="hp-panel-subgrid">
          <div class="stat-chip stat-chip--highlight">
            <span>Velocit</span>
            <strong>${r.speed??"-"}</strong>
          </div>
          <div class="stat-chip stat-chip--highlight">
            <span>Percezione passiva</span>
            <strong>${_??"-"}</strong>
          </div>
          <div class="hp-panel-status-row">
            <div class="weakness-track">
              <span class="weakness-track__label">Punti indebolimento</span>
              <div class="weakness-track__group" role="radiogroup" aria-label="Livelli indebolimento">
                ${ge.map(ve=>{const be=ve.value===he;return`
                  <button
                    class="death-save-dot ${be?"is-filled":""}"
                    type="button"
                    role="radio"
                    aria-checked="${be}"
                    data-weakness-level="${ve.value}"
                    aria-label="Livello ${ve.value}: ${ve.description}"
                  >
                    <span aria-hidden="true"></span>
                  </button>
                `}).join("")}
              </div>
              <span class="weakness-track__description">${qe}</span>
            </div>
            <div class="death-saves">
              <span class="death-saves__label">TS morte</span>
              <div class="death-saves__group" aria-label="Successi">
                <span class="death-saves__tag"></span>
                ${Array.from({length:3},(ve,be)=>{const Te=be+1;return`
                  <button class="death-save-dot ${Te<=O?"is-filled":""}" type="button" data-death-save="successes" data-death-save-index="${Te}" aria-label="Successi ${Te}">
                    <span aria-hidden="true"></span>
                  </button>
                `}).join("")}
              </div>
              <div class="death-saves__group" aria-label="Fallimenti">
                <span class="death-saves__tag"></span>
                ${Array.from({length:3},(ve,be)=>{const Te=be+1;return`
                  <button class="death-save-dot ${Te<=U?"is-filled":""}" type="button" data-death-save="failures" data-death-save-index="${Te}" aria-label="Fallimenti ${Te}">
                    <span aria-hidden="true"></span>
                  </button>
                `}).join("")}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="home-section">
        <header class="card-header">
          <div>
            <p class="eyebrow">Competenze extra</p>
          </div>
        </header>
        ${Ed(n)}
      </div>
      <div class="home-section">
        <header class="card-header">
          <div>
            <p class="eyebrow">Talenti</p>
          </div>
        </header>
        ${Cd(n)}
      </div>
    </div>
  `}function kd(n){const e=n.data||{},t=e.abilities||{},r=lt(e.proficiency_bonus),i=e.skills||{},o=e.skill_mastery||{};return`
    <div class="detail-section">
      <div class="detail-grid detail-grid--compact">
        ${sa.map(l=>{const d=!!i[l.key],f=!!o[l.key],m=Ar(t[l.ability],r,d?f?2:1:0);return`
          <div class="modifier-card ${f?"modifier-card--mastery":d?"modifier-card--proficiency":""}">
            <div>
              <div class="modifier-title">
                <strong>${l.label}</strong>
                <span class="modifier-ability modifier-ability--${l.ability}">${an[l.ability]}</span>
              </div>
            </div>
            <div class="modifier-value">${ot(m)}</div>
          </div>
        `}).join("")}
      </div>
    </div>
  `}function Sd(n){const e=n.data||{},t=e.abilities||{},r=lt(e.proficiency_bonus),i=e.saving_throws||{};return`
    <div class="detail-section">
      <div class="detail-grid detail-grid--compact">
        ${oa.map(o=>{const l=!!i[o.key],d=Ar(t[o.key],r,l?1:0);return`
          <div class="modifier-card ${l?"modifier-card--proficiency":""}">
            <div>
              <div class="modifier-title">
                <strong>${o.label}</strong>
              </div>
            </div>
            <div class="modifier-value">${ot(d)}</div>
          </div>
        `}).join("")}
      </div>
    </div>
  `}function Ed(n){const e=n.data||{},t=e.proficiencies||{},r=e.proficiency_notes||"",{tools:i,languages:o}=od(r),l=e.language_proficiencies||"",m=[...wi(l),...o].reduce((y,_)=>{const C=_.trim();if(!C)return y;const w=C.toLowerCase();return y.seen.has(w)||(y.seen.add(w),y.values.push(C)),y},{values:[],seen:new Set}).values,v=fi.filter(y=>t[y.key]).map(y=>y.label);return`
    <div class="detail-section">
      <div class="accordion-stack">
        <details class="accordion">
          <summary>Equipaggiamento</summary>
          <div class="detail-card detail-card--text">
            ${v.length?`<div class="tag-row">${v.map(y=>`<span class="chip">${y}</span>`).join("")}</div>`:'<p class="muted">Nessuna competenza equipaggiamento.</p>'}
          </div>
        </details>
        <details class="accordion">
          <summary>Strumenti</summary>
          <div class="detail-card detail-card--text">
            ${i.length?`<div class="tag-row">${i.map(y=>`<span class="chip">${y}</span>`).join("")}</div>`:'<p class="muted">Aggiungi strumenti nel profilo.</p>'}
          </div>
        </details>
        <details class="accordion">
          <summary>Lingue</summary>
          <div class="detail-card detail-card--text">
            ${m.length?`<div class="tag-row">${m.map(y=>`<span class="chip">${y}</span>`).join("")}</div>`:'<p class="muted">Aggiungi lingue conosciute nel profilo.</p>'}
          </div>
        </details>
      </div>
    </div>
  `}function Cd(n){const t=(n.data||{}).talents||"",r=wi(t);return`
    <div class="detail-section">
      <div class="detail-card detail-card--text">
        ${r.length?`<div class="tag-row">${r.map(i=>`<span class="chip">${i}</span>`).join("")}</div>`:'<p class="muted">Aggiungi talenti nel profilo.</p>'}
      </div>
    </div>
  `}function Td(n,e=[]){var B;const t=n.data||{},r=Number(t.attack_bonus_melee??t.attack_bonus)||0,i=Number(t.attack_bonus_ranged??t.attack_bonus)||0,o=Number(t.damage_bonus_melee??t.damage_bonus)||0,l=Number(t.damage_bonus_ranged??t.damage_bonus)||0,d=Number(t.extra_attacks)||0,f=e.filter(K=>K.category==="weapon"&&K.equipable&&ki(K).length),v=(t.spellcasting||{}).ability,y=v?(B=t.abilities)==null?void 0:B[v]:null,_=Dt(y),C=lt(t.proficiency_bonus),w=_===null||C===null?null:_+C,I=(Array.isArray(t.spells)?t.spells:[]).filter(K=>(K.kind==="cantrip"||Number(K.level)===0)&&K.attack_roll&&K.damage_die),O=I.length&&w!==null&&v;if(!f.length&&!O)return'<p class="muted">Nessuna arma equipaggiata.</p>';const U=[];return d>0&&U.push(`Attacco Extra (${d})`),r&&U.push(`Mischia attacco ${ot(r)}`),o&&U.push(`Mischia danni ${ot(o)}`),i&&U.push(`Distanza attacco ${ot(i)}`),l&&U.push(`Distanza danni ${ot(l)}`),`
    ${U.length?`<div class="tag-row">${U.map(K=>`<span class="chip">${K}</span>`).join("")}</div>`:""}
    <div class="detail-section">
      <div class="detail-grid detail-grid--compact">
        ${f.map(K=>{var Qe;const M=K.weapon_range||(K.range_normal?"ranged":"melee"),L=K.attack_ability||(M==="ranged"?"dex":"str"),te=Dt((Qe=t.abilities)==null?void 0:Qe[L])??0,ne=t.proficiencies||{},me=(K.weapon_type==="simple"?!!ne.weapon_simple:K.weapon_type==="martial"?!!ne.weapon_martial:!1)?lt(t.proficiency_bonus)??0:0,he=M==="ranged"?i:r,ge=M==="ranged"?l:o,qe=te+me+(Number(K.attack_modifier)||0)+he,Be=te+(Number(K.damage_modifier)||0)+ge,Me=K.damage_die?K.damage_die:"-",se=Me==="-"?"-":`${Me}${Be?` ${ot(Be)}`:""}`,ve=Number(K.range_normal)||null,be=Number(K.range_disadvantage)||null,Te=Number(K.melee_range)||1.5,We=[];M==="melee"&&Te>1.5&&We.push(`Portata ${Te} m`),M==="melee"&&K.is_thrown&&ve&&We.push(`Lancio ${ve}${be?`/${be}`:""}`),M!=="melee"&&ve&&We.push(`Gittata ${ve}${be?`/${be}`:""}`);const At=We.join("  "),Ve=L==="dex"?"DES":L==="str"?"FOR":L.toUpperCase(),gt=K.id??K.name;return`
          <div class="modifier-card attack-card">
            <div class="attack-card__body">
              <div class="attack-card__title">
                <strong class="attack-card__name">${K.name}</strong>
                <span class="modifier-ability modifier-ability--${L}">${Ve}</span>
                <span class="attack-card__hit">${ot(qe)}</span>
              </div>
              <div class="attack-card__meta">
                <span class="attack-card__damage">${se}</span>
                ${At?`<span class="muted">${At}</span>`:""}
              </div>
            </div>
            <button class="icon-button icon-button--fire" data-roll-damage="${gt}" aria-label="Calcola danni ${K.name}">
              <span aria-hidden="true"></span>
            </button>
          </div>
        `}).join("")}
        ${O?I.map(K=>{const M=Number(K.damage_modifier)||0,L=`${K.damage_die}${M?` ${ot(M)}`:""}`,te=an[v]??(v==null?void 0:v.toUpperCase()),ne=K.range?`Range ${K.range}`:"";return`
            <div class="modifier-card attack-card">
              <div class="attack-card__body">
                <div class="attack-card__title">
                  <strong class="attack-card__name">${K.name}</strong>
                  <span class="modifier-ability modifier-ability--${v}">${te}</span>
                  <span class="attack-card__hit">${ot(w)}</span>
                </div>
                <div class="attack-card__meta">
                  <span class="attack-card__damage">${L}</span>
                  <span class="chip chip--small">Trucchetto</span>
                  ${ne?`<span class="muted">${ne}</span>`:""}
                </div>
              </div>
              <button class="icon-button icon-button--fire" data-roll-damage="spell:${K.id}" aria-label="Calcola danni ${K.name}">
                <span aria-hidden="true"></span>
              </button>
            </div>
          `}).join(""):""}
      </div>
    </div>
  `}function Ad(n){var U;const e=n.data||{},t=e.spell_notes||"",r=e.spellcasting||{},i=lt(e.proficiency_bonus),o=r.ability,l=o?(U=e.abilities)==null?void 0:U[o]:null,d=Dt(l),f=d===null||i===null?null:8+d+i,m=d===null||i===null?null:d+i,v=o?an[o]:null,y=r.slots||{},_=r.slots_max||{},C=r.recharge||"long_rest",N=Array.from({length:9},(D,B)=>B+1).map(D=>{const B=Math.max(0,Number(y[D])||0),K=Math.max(B,Number(_[D])||0);return{level:D,count:B,max:K}}).filter(D=>D.max>0),I=[`${v??"-"}`,`CD ${f===null?"-":f}`,`TC ${m===null?"-":ot(m)}`];return`
    ${I.length?`<div class="tag-row">${I.map(D=>`<span class="chip">${D}</span>`).join("")}</div>`:""}
    <div class="detail-section">
      <div class="detail-card detail-card--text spell-summary-card">
        <div class="spell-slots">
          <span class="spell-slots__title">Slot rimanenti</span>
          <div class="spell-slots__list">
            ${N.map(D=>{const B=C==="short_rest"?"charge-indicator":"charge-indicator charge-indicator--long",K=Array.from({length:D.max},(M,L)=>{const te=L>=D.count?"charge-indicator--used":"";return`<span class="${[B,te].filter(Boolean).join(" ")}"></span>`}).join("");return`
              <div class="spell-slot-row">
                <span class="spell-slot-label">Slot ${D.level}</span>
                <span class="spell-slot-count">${D.count}</span>
                <div class="spell-slot-charges" aria-hidden="true">${K||'<span class="spell-slot-empty">-</span>'}</div>
              </div>
            `}).join("")}
          </div>
        </div>
        ${t?`<p class="spell-notes">${t}</p>`:""}
      </div>
      <div class="spell-list-actions">
        <button class="primary spell-list-button" type="button" data-spell-list>Lista Incantesimi</button>
      </div>
    </div>
  `}function Rs(n){if(!n)return ea.length;const e=ea.findIndex(t=>t.label===n);return e===-1?ea.length:e}function xd(n){var e;return n?((e=ea.find(t=>t.label===n))==null?void 0:e.className)??"":""}function Od(n){return[...n].sort((e,t)=>{const r=Rs(e.cast_time)-Rs(t.cast_time);return r!==0?r:(e.name??"").localeCompare(t.name??"","it",{sensitivity:"base"})})}function Ps(n,e,{showCharges:t=!0,showUseButton:r=!0,showDescription:i=!1,showCastTime:o=!0}={}){return`
    <ul class="resource-list resource-list--compact">
      ${n.map(l=>`
        <li class="modifier-card attack-card resource-card" data-resource-card="${l.id}">
          ${o&&l.cast_time?`<span class="resource-chip resource-chip--floating ${xd(l.cast_time)}">${l.cast_time}</span>`:""}
          <div class="attack-card__body resource-card__body">
            <div class="attack-card__title resource-card__title">
              <strong class="attack-card__name">${l.name}</strong>
            </div>
            ${i?`<p class="resource-card__description">${l.description??""}</p>`:""}
            ${t&&Number(l.max_uses)?`
              <div class="resource-card__charges">
                ${Rd(l)}
              </div>
            `:""}
          </div>
          <div class="resource-card-actions">
            ${r?`
              <button
                class="resource-cta-button resource-cta-button--label"
                data-use-resource="${l.id}"
                ${!Number(l.max_uses)||l.used>=Number(l.max_uses)?"disabled":""}
              >
                Usa
              </button>
            `:""}
            ${e?`
              <button class="resource-action-button resource-icon-button" data-edit-resource="${l.id}" aria-label="Modifica risorsa"></button>
            `:""}
          </div>
        </li>
      `).join("")}
    </ul>
  `}function $d(n,e){if(!n.length)return"<p>Nessuna risorsa.</p>";const t=Od(n),r=t.filter(d=>d.reset_on===null||d.reset_on==="none"),i=t.filter(d=>d.reset_on!==null&&d.reset_on!=="none"),o=i.length?`
      <div class="resource-section resource-section--active">
        <div class="resource-section__body">
          ${Ps(i,e)}
        </div>
      </div>
    `:'<p class="muted">Nessuna risorsa attiva.</p>',l=r.length?`
      <div class="resource-section">
        <header class="card-header"><div><p class="eyebrow">Risorse Passive</p></div></header>
        <div class="resource-section__body">
          ${Ps(r,e,{showCharges:!1,showUseButton:!1,showDescription:!0,showCastTime:!1})}
        </div>
      </div>
    `:"";return`${o}${l}`}function Rd(n){const e=Number(n.max_uses)||0,t=Number(n.used)||0;if(!e)return"";const r=n.reset_on==="long_rest"?"long":"short",i=Math.max(e-t,0),o=Array.from({length:e},(l,d)=>{const f=d<t;return`<span class="${["charge-indicator",r==="long"?"charge-indicator--long":"charge-indicator--short",f?"charge-indicator--used":""].filter(Boolean).join(" ")}" aria-hidden="true"></span>`}).join("");return`
    <div class="resource-charge-row" aria-label="Cariche risorsa">
      <span class="resource-charge-label">Cariche</span>
      <span class="resource-charge-count">${i}/${e}</span>
      <div class="resource-charges" aria-hidden="true">${o}</div>
    </div>
  `}async function Tn(n,e,t,r){if(!n)return;const i={name:n.name,system:n.system??null,data:e};try{const o=await uo(n.id,i),l=kt().characters.map(d=>d.id===o.id?o:d);zt({characters:l}),await Kt({characters:l}),t&&le(t),r&&r()}catch{le("Errore aggiornamento personaggio","error")}}async function Pd(n,e,t){if(!n)return!1;const r=n.data||{},i=r.spellcasting||{},o={...i.slots||{}},l={...i.slots_max||{}},d=Math.max(0,Number(o[e])||0);if(!d)return le("Slot incantesimo esauriti","error"),!1;const f=Number(l[e]);return(!Number.isFinite(f)||f<d)&&(l[e]=d),o[e]=Math.max(0,d-1),await Tn(n,{...r,spellcasting:{...i,slots:o,slots_max:l}},"Slot incantesimo consumato",t),!0}function Nd(n){if(!n)return;const e=n.data||{},t=e.background||"Background non impostato.",r=e.description||"Aggiungi una descrizione del background.",i=document.createElement("div");i.className="background-modal";const o=document.createElement("div");o.className="detail-card detail-card--text";const l=document.createElement("div");l.className="background-modal-block";const d=document.createElement("strong");d.textContent="Background";const f=document.createElement("p");f.textContent=t,l.appendChild(d),l.appendChild(f),o.appendChild(l);const m=document.createElement("div");m.className="detail-card detail-card--text";const v=document.createElement("div");v.className="background-modal-block";const y=document.createElement("strong");y.textContent="Descrizione";const _=document.createElement("p");_.textContent=r,v.appendChild(y),v.appendChild(_),m.appendChild(v),i.appendChild(o),i.appendChild(m),cn({title:"Background",submitLabel:"Chiudi",cancelLabel:null,content:i,cardClass:"modal-card--scrollable"})}function Id(n){const e=document.createElement("div");e.className="resource-detail";const r=Number(n.max_uses)||0?`${n.used}/${n.max_uses}`:"Passiva";e.innerHTML=`
    <div class="detail-card detail-card--text">
      ${n.image_url?`<img class="resource-detail-image" src="${n.image_url}" alt="Foto di ${n.name}" />`:""}
      <h4>${n.name}</h4>
      ${n.cast_time?`<p class="resource-chip">${n.cast_time}</p>`:""}
      <p class="muted">${fd(n)}</p>
      <p>Cariche: ${r}</p>
      ${n.description?`<p>${n.description}</p>`:""}
    </div>
  `,cn({title:"Dettaglio risorsa",submitLabel:"Chiudi",content:e})}function jd(n,e){if(!n)return;const t=n.data||{},r=Array.isArray(t.spells)?wo(t.spells):[],i=document.createElement("div");if(i.className="spell-list-modal",!r.length)i.innerHTML='<p class="muted">Nessun incantesimo configurato.</p>';else{const d=r.reduce((m,v)=>{const y=Number(v.level)||0;return m[y]=m[y]||[],m[y].push(v),m},{}),f=Object.keys(d).map(Number).sort((m,v)=>m-v);i.innerHTML=f.map(m=>`
        <section class="spell-list-modal__section">
          <h4>${m===0?"Trucchetti":`Incantesimi di livello ${m}`}</h4>
          <div class="spell-list-modal__items">
            ${d[m].map(y=>{const _=ko(y),C=Number(y.damage_modifier)||0,w=y.damage_die?`${y.damage_die}${C?` ${ot(C)}`:""}`:null,N=y.attack_roll?"Tiro per colpire":null;return`
              <div class="spell-list-modal__item">
                <div class="spell-list-modal__item-info">
                  <div class="spell-list-modal__item-title">
                    <strong>${y.name}</strong>
                    <span class="chip chip--small">${_}</span>
                  </div>
                  <div class="spell-list-modal__item-meta">
                    ${N?`<span>${N}</span>`:""}
                    ${w?`<span>Danni ${w}</span>`:""}
                  </div>
                </div>
                ${m>0?`<button class="resource-cta-button resource-cta-button--label" type="button" data-spell-cast="${y.id}">Lancia</button>`:""}
              </div>
            `}).join("")}
          </div>
        </section>
      `).join("")}cn({title:"Lista incantesimi",submitLabel:"Chiudi",cancelLabel:null,content:i,cardClass:"spell-list-modal-card"});const o=document.querySelector("[data-form-modal]"),l=()=>{var d;(d=o==null?void 0:o.querySelector("[data-form-submit]"))==null||d.click()};i.querySelectorAll("[data-spell-cast]").forEach(d=>d.addEventListener("click",async()=>{const f=r.find(y=>y.id===d.dataset.spellCast);if(!f)return;const m=Number(f.level)||0;if(m<1)return;await Pd(n,m,e)&&l()}))}function Ld(n,e){if(!n)return;const t=document.createElement("div");t.className="drawer-form";const r=document.createElement("label");r.className="field",r.innerHTML="<span>Tipo incantesimo</span>";const i=rn([{value:"cantrip",label:"Trucchetto"},{value:"spell",label:"Incantesimo"}],"spell");i.name="spell_kind",r.appendChild(i),t.appendChild(r);const o=ie({label:"Nome incantesimo",name:"spell_name",placeholder:"Es. Palla di fuoco"}),l=o.querySelector("input");l&&(l.required=!0),t.appendChild(o);const d=ie({label:"Livello incantesimo",name:"spell_level",type:"number",value:1}),f=d.querySelector("input");f&&(f.min="1",f.max="9"),t.appendChild(d),t.appendChild(ie({label:"Tempo di lancio",name:"spell_cast_time",placeholder:"Es. 1 azione"})),t.appendChild(ie({label:"Durata",name:"spell_duration",placeholder:"Es. 1 minuto"})),t.appendChild(ie({label:"Range",name:"spell_range",placeholder:"Es. 18 m"}));const m=document.createElement("label");m.className="checkbox",m.innerHTML='<input type="checkbox" name="spell_concentration" /> <span>Concentrazione</span>',t.appendChild(m);const v=document.createElement("label");v.className="checkbox",v.innerHTML='<input type="checkbox" name="spell_attack_roll" /> <span>Tiro per colpire (targhet)</span>',t.appendChild(v),t.appendChild(ie({label:"Dado danno",name:"spell_damage_die",placeholder:"Es. 1d10"})),t.appendChild(ie({label:"Modificatore danni",name:"spell_damage_modifier",type:"number",value:""})),t.appendChild(vn({label:"Descrizione",name:"spell_description",placeholder:"Descrizione dell'incantesimo..."}));const y=()=>{f&&(i.value==="cantrip"?(f.value="0",f.min="0",f.max="0",f.readOnly=!0,f.disabled=!0):(Number(f.value)===0&&(f.value="1"),f.min="1",f.max="9",f.readOnly=!1,f.disabled=!1))};i.addEventListener("change",y),y(),cn({title:"Nuovo incantesimo",submitLabel:"Aggiungi",content:t}).then(async _=>{var M,L,te,ne,we,me,he;if(!_)return;const C=(M=_.get("spell_name"))==null?void 0:M.trim();if(!C){le("Inserisci un nome per l'incantesimo","error");return}const w=ge=>ge===""||ge===null?null:Number(ge),N=_.get("spell_kind")||null,I=w(_.get("spell_level"))??0,O=N==="cantrip"?0:Math.min(9,Math.max(1,I||1)),U=w(_.get("spell_damage_modifier")),D={id:`spell-${Date.now()}-${Math.random().toString(16).slice(2)}`,name:C,level:O,kind:N||(O===0?"cantrip":"spell"),cast_time:((L=_.get("spell_cast_time"))==null?void 0:L.trim())||null,duration:((te=_.get("spell_duration"))==null?void 0:te.trim())||null,range:((ne=_.get("spell_range"))==null?void 0:ne.trim())||null,concentration:_.has("spell_concentration"),attack_roll:_.has("spell_attack_roll"),damage_die:((we=_.get("spell_damage_die"))==null?void 0:we.trim())||null,damage_modifier:U,description:((me=_.get("spell_description"))==null?void 0:me.trim())||null},B=Array.isArray((he=n.data)==null?void 0:he.spells)?[...n.data.spells,D]:[D],K={...n.data,spells:B};await Tn(n,K,"Incantesimo aggiunto",e)})}function Ns(n,e,t=null){if(!n)return;const r=document.createElement("div");r.className="drawer-form",r.appendChild(ie({label:"Nome abilit",name:"name",placeholder:"Es. Ispirazione",value:(t==null?void 0:t.name)??""})),r.appendChild(ie({label:"Foto (URL)",name:"image_url",placeholder:"https://.../risorsa.png",value:(t==null?void 0:t.image_url)??""})),r.appendChild(vn({label:"Descrizione",name:"description",placeholder:"Inserisci una descrizione...",value:(t==null?void 0:t.description)??""}));const i=document.createElement("label");i.className="checkbox",i.innerHTML='<input type="checkbox" name="is_passive" /> <span>Passiva (senza cariche)</span>',r.appendChild(i);const o=document.createElement("label");o.className="field",o.innerHTML="<span>Tipo di lancio</span>";const l=rn([{value:"Azione",label:"Azione"},{value:"Reazione",label:"Reazione"},{value:"Azione Bonus",label:"Azione Bonus"},{value:"Azione Gratuita",label:"Azione Gratuita"}],(t==null?void 0:t.cast_time)??"Azione");l.name="cast_time",o.appendChild(l),r.appendChild(o),r.appendChild(ie({label:"Cariche massime",name:"max_uses",type:"number",value:(t==null?void 0:t.max_uses)??1})),r.appendChild(ie({label:"Cariche consumate",name:"used",type:"number",value:(t==null?void 0:t.used)??0}));const d=document.createElement("div");d.className="compact-field-grid",d.appendChild(ie({label:"Recupero riposo breve",name:"recovery_short",type:"number",value:(t==null?void 0:t.recovery_short)??""})),d.appendChild(ie({label:"Recupero riposo lungo",name:"recovery_long",type:"number",value:(t==null?void 0:t.recovery_long)??""})),r.appendChild(d);const f=document.createElement("label");f.className="field",f.innerHTML="<span>Tipo ricarica</span>";const m=rn([{value:"short_rest",label:"Riposo breve"},{value:"long_rest",label:"Riposo lungo"}],(t==null?void 0:t.reset_on)??"long_rest");m.name="reset_on",f.appendChild(m),r.appendChild(f);const v=r.querySelector('input[name="max_uses"]'),y=r.querySelector('input[name="used"]'),_=r.querySelector('input[name="recovery_short"]'),C=r.querySelector('input[name="recovery_long"]'),w=r.querySelector('input[name="is_passive"]');w&&(w.checked=Number(t==null?void 0:t.max_uses)===0||(t==null?void 0:t.reset_on)===null||(t==null?void 0:t.reset_on)==="none");const N=()=>{const I=w==null?void 0:w.checked;I&&(v&&(v.value="0"),y&&(y.value="0"),_&&(_.value="0"),C&&(C.value="0")),v&&(v.disabled=I),y&&(y.disabled=I),_&&(_.disabled=I),C&&(C.disabled=I),m.disabled=I};if(w==null||w.addEventListener("change",N),N(),t){const I=document.createElement("button");I.type="button",I.className="resource-action-button resource-delete-button",I.textContent="Elimina",I.addEventListener("click",async()=>{if(await ca({message:"Eliminare risorsa?"}))try{await Vu(t.id),le("Risorsa eliminata"),e();const D=document.querySelector("[data-form-modal]"),B=D==null?void 0:D.querySelector("[data-form-cancel]");B==null||B.click()}catch{le("Errore eliminazione risorsa","error")}});const O=document.createElement("div");O.className="resource-form-actions",O.appendChild(I),r.appendChild(O)}cn({title:t?"Modifica abilit":"Nuova abilit",submitLabel:t?"Salva":"Crea",content:r}).then(async I=>{var te,ne,we;if(!I)return;const O=(te=I.get("name"))==null?void 0:te.trim();if(!O){le("Inserisci un nome per la risorsa","error");return}const U=kt().user,D=me=>me===""||me===null?null:Number(me),B=Number(I.get("max_uses"))||0,K=Math.min(Number(I.get("used"))||0,B||0),M=I.get("is_passive")==="on",L={user_id:(U==null?void 0:U.id)??n.user_id,character_id:n.id,name:O,image_url:((ne=I.get("image_url"))==null?void 0:ne.trim())||null,description:((we=I.get("description"))==null?void 0:we.trim())||null,cast_time:I.get("cast_time")||null,max_uses:B,used:K,reset_on:M?null:I.get("reset_on"),recovery_short:D(I.get("recovery_short")),recovery_long:D(I.get("recovery_long"))};try{t?(await fo(t.id,L),le("Risorsa aggiornata")):(await Wu(L),le("Risorsa creata")),e()}catch{le("Errore salvataggio risorsa","error")}})}let Is=!1,la=null;async function Ct(n){var K;la=n,n.innerHTML='<div class="card"><p>Caricamento...</p></div>';const e=kt(),{user:t,offline:r}=e;let i=e.characters;if(!r&&t)try{i=await co(t.id),zt({characters:i}),await Kt({characters:i})}catch{le("Errore caricamento personaggi","error")}!i.some(M=>M.id===e.activeCharacterId)&&i.length&&ua(i[0].id);const l=i.find(M=>M.id===kt().activeCharacterId),d=!!t&&!r,f=!!t&&!r,m=!!t&&!r;let v=e.cache.resources,y=e.cache.items;if(!r&&l){try{v=await ho(l.id),jt("resources",v),await Kt({resources:v})}catch{le("Errore caricamento risorse","error")}try{y=await po(l.id),jt("items",y),await Kt({items:y})}catch{le("Errore caricamento equip","error")}}n.innerHTML=`
    <div class="home-layout">
      <div class="home-column home-column--left">
        <section class="card home-card home-section">
          <header class="card-header">
            <div>
              <p class="eyebrow">Tiri salvezza</p>
              <h3></h3>
            </div>
            <div class="actions">
              <button class="icon-button" data-open-dice="saving-throws" aria-label="Lancia dadi tiri salvezza">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          ${l?Sd(l):"<p>Nessun personaggio selezionato.</p>"}
        </section>
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Abilit</p>            
            </div>
            <div class="actions">
              <button class="icon-button" data-open-dice="skills" aria-label="Lancia dadi abilit">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          <div class="home-scroll-body">
            ${l?kd(l):"<p>Nessun personaggio selezionato.</p>"}
          </div>
        </section>
      </div>
      <div class="home-column home-column--center">
        <section class="card home-card home-section">
          <header class="card-header">
            <div>
              <p class="eyebrow">Scheda Personaggio</p>           
            </div>
            <div class="actions">
              ${l&&m?`
                <button class="icon-button" data-edit-character aria-label="Modifica personaggio">
                  <span aria-hidden="true"></span>
                </button>
              `:""}
            </div>
          </header>
          ${l?wd(l,m,y):_d(d,r)}
        </section>
      </div>
      <div class="home-column home-column--right">
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Attacchi</p>
            </div>
            <div class="actions">
              <button class="icon-button icon-button--dice" data-open-dice="attack-roll" aria-label="Lancia dadi attacchi">
                <span aria-hidden="true"></span>
              </button>
            </div>
          </header>
          <div class="home-scroll-body">
            ${l?Td(l,y||[]):"<p>Nessun personaggio selezionato.</p>"}
          </div>
        </section>
        ${(K=l==null?void 0:l.data)!=null&&K.is_spellcaster?`
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Incantesimi</p>
            </div>
            ${l&&m?`
              <button class="icon-button icon-button--add" data-add-spell aria-label="Aggiungi incantesimo">
                <span aria-hidden="true">+</span>
              </button>
            `:""}
          </header>
          <div class="home-scroll-body">
            ${Ad(l)}
          </div>
        </section>
        `:""}
        <section class="card home-card home-section home-scroll-panel">
          <header class="card-header">
            <div>
              <p class="eyebrow">Risorse</p>           
            </div>
            ${l&&f?`
              <button class="icon-button icon-button--add" data-add-resource aria-label="Nuova risorsa">
                <span aria-hidden="true">+</span>
              </button>
            `:""}
          </header>
          <div class="home-scroll-body home-scroll-body--resources">
            ${l?$d(v,f):"<p>Nessun personaggio selezionato.</p>"}
            ${l&&!f?'<p class="muted">Connettiti per aggiungere nuove risorse.</p>':""}
          </div>
        </section>
      </div>
    </div>
  `,qd();const _=n.querySelector("[data-create-character]");_&&_.addEventListener("click",()=>{pi(t,()=>Ct(n))});const C=n.querySelector("[data-edit-character]");C&&C.addEventListener("click",()=>{pi(t,()=>Ct(n),l)});const w=n.querySelector("[data-add-resource]");w&&w.addEventListener("click",()=>{Ns(l,()=>Ct(n))});const N=n.querySelector("[data-add-spell]");N&&N.addEventListener("click",()=>{Ld(l,()=>Ct(n))});const I=n.querySelector("[data-spell-list]");I&&I.addEventListener("click",()=>{jd(l,()=>Ct(n))});const O=n.querySelector("[data-show-background]");O&&O.addEventListener("click",()=>{Nd(l)});const U=n.querySelector("[data-toggle-inspiration]");U&&l&&m&&U.addEventListener("click",async()=>{const M=l.data||{},L={...M,inspiration:!M.inspiration};await Tn(l,L,"Ispirazione aggiornata",()=>Ct(n))}),n.querySelectorAll("[data-open-dice]").forEach(M=>M.addEventListener("click",()=>{So(M.dataset.openDice)})),n.querySelectorAll("[data-edit-resource]").forEach(M=>M.addEventListener("click",()=>{const L=v.find(te=>te.id===M.dataset.editResource);L&&Ns(l,()=>Ct(n),L)})),n.querySelectorAll("[data-roll-damage]").forEach(M=>M.addEventListener("click",()=>{var we;if(!l)return;const L=M.dataset.rollDamage;if(!L)return;if(L.startsWith("spell:")){const me=L.replace("spell:",""),ge=(Array.isArray((we=l.data)==null?void 0:we.spells)?l.data.spells:[]).find(Be=>Be.id===me);if(!ge)return;const qe=md(ge);if(!qe){le("Danno non calcolabile per questo trucchetto.","error");return}hi({keepOpen:!0,title:qe.title,mode:"generic",notation:qe.notation,modifier:qe.modifier,rollType:"DMG"});return}const te=y==null?void 0:y.find(me=>String(me.id)===L||me.name===L);if(!te)return;const ne=pd(l,te);if(!ne){le("Danno non calcolabile per questa arma.","error");return}hi({keepOpen:!0,title:ne.title,mode:"generic",notation:ne.notation,modifier:ne.modifier,rollType:"DMG"})}));const D=500;n.querySelectorAll("[data-resource-card]").forEach(M=>{let L=null;const te=me=>{me.target.closest("button")||(L=setTimeout(async()=>{const he=v.find(ge=>ge.id===M.dataset.resourceCard);he&&Id(he)},D))},ne=()=>{L&&(clearTimeout(L),L=null)},we=me=>{me.target.closest("button")||(n.querySelectorAll(".resource-card.is-selected").forEach(he=>he.classList.remove("is-selected")),M.classList.add("is-selected"),window.setTimeout(()=>{M.classList.remove("is-selected")},800))};M.addEventListener("pointerdown",te),M.addEventListener("pointerup",ne),M.addEventListener("pointerleave",ne),M.addEventListener("pointercancel",ne),M.addEventListener("pointermove",ne),M.addEventListener("click",we)}),n.querySelectorAll("[data-use-resource]").forEach(M=>M.addEventListener("click",async()=>{const L=v.find(ne=>ne.id===M.dataset.useResource);if(!L)return;const te=Number(L.max_uses)||0;if(!(!te||L.used>=te))try{await fo(L.id,{used:Math.min(L.used+1,te)}),le("Risorsa usata"),Ct(n)}catch{le("Errore utilizzo risorsa","error")}})),n.querySelectorAll("[data-death-save]").forEach(M=>M.addEventListener("click",async()=>{if(!l||!m)return;const{deathSave:L,deathSaveIndex:te}=M.dataset,ne=Number(te);if(!L||!ne)return;const we=l.data||{},me=we.death_saves||{},he=Math.max(0,Math.min(3,Number(me[L])||0)),ge=ne===he?he-1:ne,qe={successes:Math.max(0,Math.min(3,L==="successes"?ge:Number(me.successes)||0)),failures:Math.max(0,Math.min(3,L==="failures"?ge:Number(me.failures)||0))};await Tn(l,{...we,death_saves:qe},"Tiri salvezza contro morte aggiornati",()=>Ct(n))})),n.querySelectorAll("[data-weakness-level]").forEach(M=>M.addEventListener("click",async()=>{if(!l||!m)return;const L=Number(M.dataset.weaknessLevel);if(!L)return;const te=l.data||{},ne=te.hp||{},we=Math.max(0,Math.min(6,Number(ne.weak_points)||0));await Tn(l,{...te,hp:{...ne,weak_points:L===we?0:L}},"Punti indebolimento aggiornati",()=>Ct(n))}));const B=n.querySelector(".character-avatar");B&&B.addEventListener("pointerdown",M=>{if(M.button&&M.button!==0)return;M.preventDefault();const L=B.getAttribute("src");if(!L)return;const te=zd(L,B.getAttribute("alt")||"Ritratto personaggio"),ne=()=>{te(),window.removeEventListener("pointerup",ne),window.removeEventListener("pointercancel",ne),window.removeEventListener("blur",ne)};window.addEventListener("pointerup",ne),window.addEventListener("pointercancel",ne),window.addEventListener("blur",ne)})}function qd(){Is||(document.addEventListener("click",async n=>{if(!n.target.closest("[data-actions-fab]"))return;const t=n.target.closest("[data-hp-action]"),r=n.target.closest("[data-rest]"),i=n.target.closest("[data-open-dice]");if(!t&&!r&&!i)return;n.preventDefault();const o=la??document.querySelector("[data-route-outlet]");if(t){await Fd(t.dataset.hpAction,o),Xa();return}if(r){await Ud(r.dataset.rest,o),Xa();return}i&&(So(i.dataset.openDice),Xa())}),Is=!0)}function Xa(){const n=document.querySelector("[data-actions-fab]"),e=document.querySelector("[data-actions-toggle]");!n||!n.classList.contains("is-open")||(n.classList.remove("is-open"),e==null||e.setAttribute("aria-expanded","false"))}function Si(){const n=kt(),{user:e,offline:t,characters:r,activeCharacterId:i}=n;return{activeCharacter:r.find(l=>l.id===i),canEditCharacter:!!e&&!t}}function Dd(n){const e=n.data||{},t=e.abilities||{},r=lt(e.proficiency_bonus),i=e.skills||{},o=e.skill_mastery||{};return sa.map(l=>{const d=!!i[l.key],f=!!o[l.key],m=Ar(t[l.ability],r,d?f?2:1:0),v=m??0;return{value:l.key,label:`${l.label} (${ot(m)})`,shortLabel:l.label,modifier:v}})}function Bd(n){const e=n.data||{},t=e.abilities||{},r=lt(e.proficiency_bonus),i=e.saving_throws||{};return oa.map(o=>{const l=!!i[o.key],d=Ar(t[o.key],r,l?1:0),f=d??0;return{value:o.key,label:`${o.label} (${ot(d)})`,shortLabel:an[o.key]||o.label,modifier:f}})}function Md(n,e=[]){var I;const t=n.data||{},r=Number(t.attack_bonus_melee??t.attack_bonus)||0,i=Number(t.attack_bonus_ranged??t.attack_bonus)||0,o=(e||[]).filter(O=>O.category==="weapon"&&O.equipable&&ki(O).length),l=lt(t.proficiency_bonus)??0,d=t.proficiencies||{},f=o.map(O=>{var ne;const U=O.weapon_range||(O.range_normal?"ranged":"melee"),D=O.attack_ability||(U==="ranged"?"dex":"str"),B=Dt((ne=t.abilities)==null?void 0:ne[D])??0,M=(O.weapon_type==="simple"?!!d.weapon_simple:O.weapon_type==="martial"?!!d.weapon_martial:!1)?l:0,L=U==="ranged"?i:r,te=B+M+(Number(O.attack_modifier)||0)+L;return{value:`weapon:${O.id??O.name}`,label:`${O.name} (${ot(te)})`,shortLabel:O.name,modifier:te}}),v=(t.spellcasting||{}).ability,y=v?(I=t.abilities)==null?void 0:I[v]:null,_=Dt(y),C=_===null||l===null?null:_+l,N=(Array.isArray(t.spells)?t.spells:[]).filter(O=>(O.kind==="cantrip"||Number(O.level)===0)&&O.attack_roll&&O.damage_die);return v&&C!==null&&N.forEach(O=>{f.push({value:`spell:${O.id}`,label:`${O.name} (${ot(C)})`,shortLabel:O.name,modifier:C})}),f}function So(n){var m,v,y;const{activeCharacter:e,canEditCharacter:t}=Si(),r=kt().cache.items||[],i=!!((m=e==null?void 0:e.data)!=null&&m.inspiration)&&t,o=Number((y=(v=e==null?void 0:e.data)==null?void 0:v.hp)==null?void 0:y.weak_points)||0,l=i&&e?async()=>{const _=e.data||{};_.inspiration&&await Tn(e,{..._,inspiration:!1},"Ispirazione consumata",la?()=>Ct(la):null)}:null,f={"saving-throws":{title:"Tiro Salvezza",mode:"d20",rollType:"TS",selection:e?{label:"Tiro salvezza",options:Bd(e)}:null},skills:{title:"Tiro Abilit",mode:"d20",rollType:"TA",selection:e?{label:"Abilit",options:Dd(e)}:null},"attack-roll":{title:"Tiro per Colpire",mode:"d20",rollType:"TC",selection:e?{label:"Attacco",options:Md(e,r)}:null},roller:{title:"Lancia Dadi generico",mode:"generic",rollType:"GEN"}}[n]??{title:"Lancia dadi",mode:"generic"};Kd({...f,allowInspiration:i,onConsumeInspiration:l,weakPoints:o})}async function Ud(n,e){const{activeCharacter:t}=Si();if(!(!t||!await ca({message:"Confermi il riposo?"})))try{await Hu(t.id,n),le(n==="long_rest"?"Riposo lungo completato":"Riposo breve completato");const o=await ho(t.id);jt("resources",o),await Kt({resources:o});const l=yd(t.data,n);if(l){await Tn(t,l,null,e?()=>Ct(e):null);return}e&&Ct(e)}catch{le("Errore aggiornamento risorse","error")}}async function Fd(n,e){var me,he,ge,qe,Be,Me,se,ve,be;const{activeCharacter:t,canEditCharacter:r}=Si();if(!t||!r)return;const l=await cn({title:n==="heal"?"Cura PF":"Infliggi danno",submitLabel:n==="heal"?"Cura":"Danno",content:Hd(t,{allowHitDice:n==="heal",allowTempHp:n==="heal",allowMaxOverride:n==="damage"})});if(!l)return;const d=l.has("use_hit_dice"),f=l.has("temp_hp"),m=((me=t.data)==null?void 0:me.hit_dice)||{},v=((he=t.data)==null?void 0:he.abilities)||{},y=Number(m.used)||0,_=Number(m.max)||0,C=bo(m.die),w=Math.max(Number(l.get("hit_dice_count"))||1,1);let N=Number(l.get("amount"));if(n==="heal"&&d){if(!C){le("Configura un dado vita valido","error");return}if(y>=_){le("Nessun dado vita disponibile","error");return}const Te=Math.max(_-y,0);if(w>Te){le(`Hai solo ${Te} dadi vita disponibili`,"error");return}const We=Dt(v.con)??0,Ve=Array.from({length:w},()=>cd(C)).reduce((gt,Qe)=>gt+Qe,0);N=Math.max(Ve+We*w,1)}if(!N||N<=0){le("Inserisci un valore valido","error");return}const I=Number((qe=(ge=t.data)==null?void 0:ge.hp)==null?void 0:qe.current)||0,O=Number((Me=(Be=t.data)==null?void 0:Be.hp)==null?void 0:Me.temp)||0,U=(ve=(se=t.data)==null?void 0:se.hp)==null?void 0:ve.max,D=l.get("hp_max_override"),B=D===null||D===""?null:Number(D);if(n==="damage"&&B!==null&&(!Number.isFinite(B)||B<=0)){le("Inserisci un massimo PF valido","error");return}let K=I,M=O;if(n==="heal"&&f)M=O+N;else if(n==="heal")K=I+N;else{const Te=Math.min(O,N);M=O-Te;const We=N-Te;K=Math.max(I-We,0)}const L=B??U,te=L!=null?Math.min(K,Number(L)):K,ne=n==="heal"&&d?{...m,used:Math.min(y+w,_)}:m,we=n==="heal"?`${f?"HP temporanei +":"PF curati +"}${N}${d?` (${w}d${C})`:""}`:`Danno ${N}`;await Tn(t,{...t.data,hp:{...(be=t.data)==null?void 0:be.hp,current:te,temp:M,max:B??U},hit_dice:ne},we,e?()=>Ct(e):null)}function Kd({title:n,mode:e,selection:t=null,allowInspiration:r=!1,onConsumeInspiration:i=null,rollType:o=null,weakPoints:l=0}){hi({keepOpen:!0,title:n,mode:e,selection:t,allowInspiration:r,onConsumeInspiration:i,rollType:o,weakPoints:l})}function zd(n,e){const t=document.querySelector(".avatar-preview");t&&t.remove();const r=document.createElement("div");r.className="avatar-preview";const i=document.createElement("img");return i.className="avatar-preview__image",i.src=n,i.alt=e,r.appendChild(i),document.body.appendChild(r),()=>{r.remove()}}function Hd(n,{allowHitDice:e=!0,allowTempHp:t=!1,allowMaxOverride:r=!1}={}){var D;const i=document.createElement("div"),o=ie({label:"Valore",name:"amount",type:"number",value:"1"}),l=o.querySelector("input");if(l&&(l.min="1",l.required=!0),i.appendChild(o),t){const B=document.createElement("label");B.className="checkbox",B.innerHTML=`
      <input type="checkbox" name="temp_hp" />
      <span>HP temporanei</span>
    `,i.appendChild(B)}if(!e){if(r){const B=ie({label:"Nuovo massimo PF",name:"hp_max_override",type:"number",value:""}),K=B.querySelector("input");K&&(K.min="1"),i.appendChild(B)}return i}const d=((D=n==null?void 0:n.data)==null?void 0:D.hit_dice)||{},f=Number(d.used)||0,m=Number(d.max)||0,v=Math.max(m-f,0),y=bo(d.die),_=v>0&&y,C=document.createElement("label");C.className="checkbox";const w=d.die?`${d.die}`:"dado vita";C.innerHTML=`
    <input type="checkbox" name="use_hit_dice" ${_?"":"disabled"} />
    <span>Usa dado vita (${w})  rimasti ${v}/${m||"-"}</span>
  `,i.appendChild(C);const N=document.createElement("label");if(N.className="field hit-dice-count",N.innerHTML=`
    <span>Numero dadi vita</span>
    <input type="number" name="hit_dice_count" min="1" max="${v}" value="1" />
  `,i.appendChild(N),!_){const B=document.createElement("p");B.className="muted",B.textContent="Nessun dado vita disponibile o configurato.",i.appendChild(B)}const I=C.querySelector("input"),O=N.querySelector("input");O&&(O.required=!1);const U=()=>{const B=I==null?void 0:I.checked;l&&(l.disabled=!!B,l.required=!B,B?l.value="":l.value||(l.value="1"),O&&(O.disabled=!B,O.required=!!B,B||(O.value="1")),N.style.display=B?"grid":"none")};return I==null||I.addEventListener("change",U),U(),i}async function Eo(n){n.innerHTML='<section class="card"><p>Caricamento...</p></section>';const e=kt(),{user:t,offline:r}=e;let i=e.characters;if(!r&&t)try{i=await co(t.id),zt({characters:i}),await Kt({characters:i})}catch{le("Errore caricamento personaggi","error")}const o=i.find(f=>f.id===e.activeCharacterId),l=!!t&&!r;n.innerHTML=`
    <section class="card">
      <header class="character-select-header">
        <div>
          <h2>Seleziona personaggio</h2>
          <p class="muted">Scegli una scheda per aprire la home del personaggio.</p>
        </div>
        ${l?'<button class="primary" type="button" data-create-character>Nuovo personaggio</button>':""}
      </header>
      <div class="character-card-grid">
        ${i.length?i.map(f=>Wd(f,f.id===(o==null?void 0:o.id))).join(""):"<p>Non hai ancora creato un personaggio.</p>"}
      </div>
    </section>
  `,n.querySelectorAll("[data-character-card]").forEach(f=>{f.addEventListener("click",()=>{ua(f.dataset.characterCard),il("home")})});const d=n.querySelector("[data-create-character]");d&&d.addEventListener("click",()=>{pi(t,()=>Eo(n))})}function Wd(n,e){const t=n.data||{},r=t.avatar_url?`<img src="${t.avatar_url}" alt="Ritratto di ${n.name}" />`:`<span>${Vd(n.name)}</span>`,i=t.level?`Livello ${t.level}`:"Livello n.d.",o=t.class_name||t.class_archetype||t.archetype,l=[i,o].filter(Boolean).join("  "),f=[t.race,t.background,t.alignment].filter(Boolean).join("  ")||"Razza, background o allineamento non specificati";return`
    <button class="character-card ${e?"is-active":""}" type="button" data-character-card="${n.id}">
      <div class="character-card-avatar">
        ${r}
      </div>
      <div class="character-card-info">
        <h3>${n.name}</h3>
        <p class="muted">${n.system||"Sistema non specificato"}</p>
        <p class="character-card-meta">${l||"Dettagli base non specificati"}</p>
        <p class="character-card-meta muted">${f}</p>
      </div>
    </button>
  `}function Vd(n=""){const e=n.split(" ").filter(Boolean);return e.length?e.length===1?e[0].slice(0,2).toUpperCase():`${e[0][0]}${e[1][0]}`.toUpperCase():"??"}function Gd(n=[]){return n.reduce((e,t)=>{const r=Number(t.qty??0),i=Number(t.weight??0);return e+r*i},0)}function Jd(n,e){const t={...n};return Object.keys(e).forEach(r=>{t[r]=Number(t[r]??0)+Number(e[r]??0)}),t}function Yd(n,e="lb"){return n==null||Number.isNaN(n)?"-":`${Number(n).toFixed(2).replace(/\.00$/,"")} ${e}`}function Qd(n,e){return`${Number(n??0)} ${e}`}async function Xd(n){const{data:e,error:t}=await Ie.from("wallets").select("*").eq("character_id",n).single();if(t&&t.code!=="PGRST116")throw t;return e??null}async function Zd(n){const{data:e,error:t}=await Ie.from("wallets").upsert(n).select("*").single();if(t)throw t;return e}async function eh(n){const{data:e,error:t}=await Ie.from("money_transactions").insert(n).select("*").single();if(t)throw t;return e}async function th(n){const{data:e,error:t}=await Ie.from("money_transactions").select("*").eq("character_id",n).order("created_at",{ascending:!1});if(t)throw t;return e??[]}function nh(n){return`
    <div class="wallet-summary">     
      <div class="wallet-grid">
        ${[{key:"pp",label:"Platino"},{key:"gp",label:"Oro"},{key:"sp",label:"Argento"},{key:"cp",label:"Rame"}].map(t=>`
          <div class="stat-card">
            <span class="coin-avatar coin-avatar--${t.key}" aria-hidden="true"></span>
            <span>${t.label}</span>
            <strong>${(n==null?void 0:n[t.key])??0}</strong>
          </div>
        `).join("")}
      </div>
    </div>
  `}const Co=[{value:"head",label:"Testa"},{value:"eyes-left",label:"Occhio sinistro"},{value:"eyes-right",label:"Occhio destro"},{value:"ears-left",label:"Orecchio sinistro"},{value:"ears-right",label:"Orecchio destro"},{value:"neck",label:"Collo"},{value:"shoulder-left",label:"Spalla sinistra"},{value:"shoulder-right",label:"Spalla destra"},{value:"back",label:"Schiena"},{value:"chest",label:"Torso"},{value:"arm-left",label:"Braccio sinistro"},{value:"arm-right",label:"Braccio destro"},{value:"hand-left",label:"Mano sinistra"},{value:"hand-right",label:"Mano destra"},{value:"wrist-left",label:"Polso sinistro"},{value:"wrist-right",label:"Polso destro"},{value:"waist",label:"Vita"},{value:"leg-left",label:"Gamba sinistra"},{value:"leg-right",label:"Gamba destra"},{value:"foot-left",label:"Piede sinistro"},{value:"foot-right",label:"Piede destro"},{value:"ring-left",label:"Dita/Anello sinistro"},{value:"ring-right",label:"Dita/Anello destro"},{value:"main-hand",label:"Mano principale"},{value:"off-hand",label:"Mano secondaria"},{value:"eyes",label:"Occhi (generico)"},{value:"ears",label:"Orecchie (generico)"},{value:"shoulders",label:"Spalle (generico)"},{value:"arms",label:"Braccia (generico)"},{value:"hands",label:"Mani (generico)"},{value:"wrists",label:"Polsi (generico)"},{value:"legs",label:"Gambe (generico)"},{value:"feet",label:"Piedi (generico)"},{value:"ring",label:"Dita/Anelli (generico)"}],Ei=[{value:"gear",label:"Equipaggiamento",equipable:!0},{value:"loot",label:"Loot"},{value:"consumable",label:"Consumabili"},{value:"weapon",label:"Armi",equipable:!0},{value:"armor",label:"Armature",equipable:!0},{value:"magic",label:"Magici",equipable:!0},{value:"jewelry",label:"Gioielli e ornamenti",equipable:!0},{value:"tool",label:"Strumenti"},{value:"container",label:"Contenitore"},{value:"misc",label:"Altro"}],rh=[{value:"",label:"Tutte"},...Ei],ah=new Map(Ei.map(n=>[n.value,n.label])),ih=new Map(Co.map(n=>[n.value,n.label])),sh=[{value:"",label:"Seleziona"},{value:"simple",label:"Semplice"},{value:"martial",label:"Da guerra"}],oh=[{value:"",label:"Seleziona"},{value:"melee",label:"Mischia"},{value:"ranged",label:"Distanza"}],lh=[{value:"",label:"Seleziona"},{value:"str",label:"FOR"},{value:"dex",label:"DES"}],ch=[{value:"",label:"Seleziona"},{value:"light",label:"Leggera"},{value:"medium",label:"Media"},{value:"heavy",label:"Pesante"}];function uh(n){const e=dh(n),t=["pp","gp","sp","cp"].map(r=>({coin:r,value:Number((e==null?void 0:e[r])??0)})).filter(r=>r.value!==0);return t.length?t.map(r=>Qd(r.value,r.coin)).join("  "):"0 gp"}function dh(n){if(!n)return{};if(typeof n=="string")try{return JSON.parse(n)}catch{return{}}return n}function hh(n){if(!n)return"Data non disponibile";const e=new Date(n);return Number.isNaN(e.getTime())?"Data non disponibile":e.toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"})}function To(n){return ah.get(n)??(n||"Altro")}function fh(n){return ih.get(n)??n}function Ao(n){return n.map(e=>fh(e)).join(", ")}function sr(n){if(!n)return[];if(Array.isArray(n.equip_slots))return n.equip_slots.filter(Boolean);if(typeof n.equip_slots=="string"&&n.equip_slots.trim())try{const e=JSON.parse(n.equip_slots);if(Array.isArray(e))return e.filter(Boolean)}catch{return[n.equip_slots]}return n.equip_slot?[n.equip_slot]:[]}function xo(n){var e,t;return((t=(e=n.data)==null?void 0:e.settings)==null?void 0:t.weight_unit)??"lb"}function ph(n,e){var i;const t=((i=n.data)==null?void 0:i.proficiencies)||{},r=e.get("category");if(r==="weapon"){const o=e.get("weapon_type");return o?o==="simple"?!!t.weapon_simple:!!t.weapon_martial:!1}if(r==="armor"){if(e.get("is_shield")==="on")return!!t.shield;const l=e.get("armor_type");return l?l==="light"?!!t.armor_light:l==="medium"?!!t.armor_medium:!!t.armor_heavy:!1}return!0}async function js(n,e,t,r){var Je,Ut;const i=document.createElement("div");i.className="drawer-form",i.appendChild(ie({label:"Nome",name:"name",value:(e==null?void 0:e.name)??""})),i.appendChild(ie({label:"Foto (URL)",name:"image_url",placeholder:"https://.../oggetto.png",value:(e==null?void 0:e.image_url)??""})),i.appendChild(ie({label:"Quantit",name:"qty",type:"number",value:(e==null?void 0:e.qty)??1}));const o=ie({label:"Peso",name:"weight",type:"number",value:(e==null?void 0:e.weight)??0}),l=o.querySelector("input");if(l){const Oe=xo(n);l.min="0",l.step=Oe==="kg"?"0.1":"1"}i.appendChild(o),i.appendChild(ie({label:"Valore (cp)",name:"value_cp",type:"number",value:(e==null?void 0:e.value_cp)??0}));const d=rn([{value:"",label:"Seleziona"},...Ei],(e==null?void 0:e.category)??"");d.name="category";const f=document.createElement("label");f.className="field",f.innerHTML="<span>Categoria</span>",f.appendChild(d),i.appendChild(f);const m=[{value:"",label:"Nessuno"}].concat(t.filter(Oe=>Oe.category==="container").map(Oe=>({value:Oe.id,label:Oe.name}))),v=rn(m,(e==null?void 0:e.container_item_id)??"");v.name="container_item_id";const y=document.createElement("label");y.className="field",y.innerHTML="<span>Contenitore</span>",y.appendChild(v),i.appendChild(y);const _=document.createElement("div");_.className="compact-field-grid";const C=document.createElement("label");C.className="checkbox",C.innerHTML='<input type="checkbox" name="equipable" /> <span>Equipaggiabile</span>';const w=C.querySelector("input"),N=document.createElement("label");N.className="checkbox",N.innerHTML='<input type="checkbox" name="sovrapponibile" /> <span>Sovrapponibile</span>';const I=N.querySelector("input"),O=document.createElement("fieldset");O.className="equip-slot-field",O.innerHTML="<legend>Punti del corpo</legend>";const U=document.createElement("div");U.className="equip-slot-list";const D=sr(e),B=Co.map(Oe=>{const Fe=document.createElement("label");Fe.className="checkbox",Fe.innerHTML=`<input type="checkbox" name="equip_slots" value="${Oe.value}" /> <span>${Oe.label}</span>`;const He=Fe.querySelector("input");return He&&D.includes(Oe.value)&&(He.checked=!0),U.appendChild(Fe),He});O.appendChild(U),_.appendChild(C),_.appendChild(N),i.appendChild(_),i.appendChild(O);const K=document.createElement("label");K.className="checkbox",K.innerHTML='<input type="checkbox" name="attunement_active" /> <span>Sintonia attiva</span>';const M=K.querySelector("input");i.appendChild(K),i.appendChild(vn({label:"Note",name:"notes",value:(e==null?void 0:e.notes)??""}));const L=document.createElement("div");L.className="drawer-form";const te=document.createElement("label");te.className="field",te.innerHTML="<span>Tipo arma</span>";const ne=rn(sh,(e==null?void 0:e.weapon_type)??"");ne.name="weapon_type",te.appendChild(ne);const we=document.createElement("label");we.className="field",we.innerHTML="<span>Propriet arma</span>";const me=rn(oh,(e==null?void 0:e.weapon_range)??"");me.name="weapon_range",we.appendChild(me);const he=document.createElement("label");he.className="field",he.innerHTML="<span>Caratteristica tiro per colpire</span>";const ge=rn(lh,(e==null?void 0:e.attack_ability)??"");ge.name="attack_ability",he.appendChild(ge);const qe=ie({label:"Dado danno",name:"damage_die",placeholder:"Es. 1d8",value:(e==null?void 0:e.damage_die)??""}),Be=ie({label:"Modificatore per colpire",name:"attack_modifier",type:"number",value:(e==null?void 0:e.attack_modifier)??0}),Me=ie({label:"Modificatore danno",name:"damage_modifier",type:"number",value:(e==null?void 0:e.damage_modifier)??0}),se=document.createElement("label");se.className="checkbox",se.innerHTML='<input type="checkbox" name="is_thrown" /> <span>Propriet lancio</span>';const ve=se.querySelector("input"),be=document.createElement("div");be.className="compact-field-grid";const Te=ie({label:"Portata arma (m)",name:"melee_range",type:"number",value:(e==null?void 0:e.melee_range)??1.5}),We=ie({label:"Gittata normale",name:"range_normal",type:"number",value:(e==null?void 0:e.range_normal)??""}),At=ie({label:"Gittata svantaggio",name:"range_disadvantage",type:"number",value:(e==null?void 0:e.range_disadvantage)??""});be.appendChild(Te),be.appendChild(We),be.appendChild(At);const Ve=document.createElement("label");Ve.className="field",Ve.innerHTML="<span>Tipo armatura</span>";const gt=rn(ch,(e==null?void 0:e.armor_type)??"");gt.name="armor_type",Ve.appendChild(gt);const Qe=document.createElement("label");Qe.className="checkbox",Qe.innerHTML='<input type="checkbox" name="is_shield" /> <span>Scudo</span>';const Ge=Qe.querySelector("input"),Bt=ie({label:"Classe armatura base",name:"armor_class",type:"number",value:(e==null?void 0:e.armor_class)??""}),Ht=Bt.querySelector("input"),re=ie({label:"Bonus armatura",name:"armor_bonus",type:"number",value:(e==null?void 0:e.armor_bonus)??0}),Mt=re.querySelector("input"),Ot=ie({label:"Bonus scudo",name:"shield_bonus",type:"number",value:(e==null?void 0:e.shield_bonus)??2}),Se=Ot.querySelector("input");L.appendChild(te),L.appendChild(we),L.appendChild(he),L.appendChild(qe),L.appendChild(Be),L.appendChild(Me),L.appendChild(se),L.appendChild(be),L.appendChild(Ve),L.appendChild(Qe),L.appendChild(Bt),L.appendChild(re),L.appendChild(Ot),i.appendChild(L),M&&(M.checked=(e==null?void 0:e.attunement_active)??!1),w&&(w.checked=(e==null?void 0:e.equipable)??!1),I&&(I.checked=(e==null?void 0:e.sovrapponibile)??!1),Ge&&(Ge.checked=(e==null?void 0:e.is_shield)??!1),ve&&(ve.checked=(e==null?void 0:e.is_thrown)??!1);const ct=()=>{const Oe=(w==null?void 0:w.checked)??!1;B.forEach(De=>{De&&(De.disabled=!Oe,Oe||(De.checked=!1))}),I&&(I.disabled=!Oe,Oe||(I.checked=!1));const Fe=d.value==="weapon",He=d.value==="armor";ne.disabled=!Fe,me.disabled=!Fe,ge.disabled=!Fe,qe.querySelector("input").disabled=!Fe,Be.querySelector("input").disabled=!Fe,Me.querySelector("input").disabled=!Fe,ve&&(ve.disabled=!Fe),be.querySelectorAll("input").forEach(De=>{De.disabled=!Fe,Fe?De.name==="melee_range"&&!De.value&&(De.value="1.5"):De.value=""}),gt.disabled=!He,Ge&&(Ge.disabled=!He),Ht&&(Ht.disabled=!He),Mt&&(Mt.disabled=!He),Se&&(Se.disabled=!He||!((Ge==null?void 0:Ge.checked)??!1))};w==null||w.addEventListener("change",ct),d.addEventListener("change",ct),Ge==null||Ge.addEventListener("change",ct),ve==null||ve.addEventListener("change",ct),ct();const Ee=await cn({title:e?"Modifica oggetto":"Nuovo oggetto",submitLabel:e?"Salva":"Crea",content:i,cardClass:["modal-card--wide","modal-card--scrollable"]});if(!Ee)return;const dt=Ee.get("equipable")==="on",vt=dt?Ee.getAll("equip_slots"):[],Wt=vt[0]||null,sn=Ee.get("category");if(vt.length&&!ph(n,Ee)){le("Non hai la competenza per equipaggiare questo oggetto","error");return}const Vt=Ee.get("sovrapponibile")==="on";if(vt.length&&!Vt&&t.filter(Fe=>Fe.id!==(e==null?void 0:e.id)).filter(Fe=>sr(Fe).some(He=>vt.includes(He))).length){le("Uno o pi slot selezionati sono gi occupati","error");return}const St={user_id:n.user_id,character_id:n.id,name:Ee.get("name"),image_url:((Je=Ee.get("image_url"))==null?void 0:Je.trim())||null,qty:Number(Ee.get("qty")),weight:Number(Ee.get("weight")),value_cp:Number(Ee.get("value_cp")),category:sn,container_item_id:Ee.get("container_item_id")||null,equipable:dt,equip_slot:Wt,equip_slots:vt,sovrapponibile:Vt,attunement_active:Ee.get("attunement_active")==="on",notes:Ee.get("notes"),weapon_type:Ee.get("weapon_type")||null,weapon_range:Ee.get("weapon_range")||null,attack_ability:Ee.get("attack_ability")||null,damage_die:((Ut=Ee.get("damage_die"))==null?void 0:Ut.trim())||null,attack_modifier:Number(Ee.get("attack_modifier"))||0,damage_modifier:Number(Ee.get("damage_modifier"))||0,is_thrown:Ee.get("is_thrown")==="on",melee_range:Ee.get("melee_range")===""?null:Number(Ee.get("melee_range")),range_normal:Number(Ee.get("range_normal"))||null,range_disadvantage:Number(Ee.get("range_disadvantage"))||null,armor_type:Ee.get("armor_type")||null,is_shield:Ee.get("is_shield")==="on",armor_class:Number(Ee.get("armor_class"))||null,armor_bonus:Number(Ee.get("armor_bonus"))||0,shield_bonus:Number(Ee.get("shield_bonus"))||0};try{e?(await Zr(e.id,St),le("Oggetto aggiornato")):(await mo(St),le("Oggetto creato")),r()}catch{le("Errore salvataggio oggetto","error")}}function mh(n){const e=document.createElement("div");if(e.className="transaction-list",!n.length)return e.innerHTML='<p class="muted">Nessuna transazione registrata.</p>',e;const t=document.createElement("ul");return t.className="transaction-items",n.forEach(r=>{const i=document.createElement("li"),o=r.direction==="pay"?"Pagamento":"Entrata",l=uh(r.amount),d=hh(r.occurred_on||r.created_at);i.innerHTML=`
      <div>
        <strong>${o}</strong>
        <p class="muted">${r.reason||"Nessuna nota"}  ${d}</p>
      </div>
      <span>${l}</span>
    `,t.appendChild(i)}),e.appendChild(t),e}function gh(n){const e=n.filter(i=>i.category==="container"),t=n.filter(i=>!i.container_item_id&&i.category!=="container");return`
    ${e.map(i=>{const o=n.filter(l=>l.container_item_id===i.id);return`
      <div class="inventory-group">
        <p class="eyebrow">${i.name}</p>
        ${Ls(o)}
      </div>
    `}).join("")}
    <div class="inventory-group">
      <p class="eyebrow">Oggetti</p>
      ${Ls(t)}
    </div>
  `}function Ls(n){return n.length?`
    <ul class="inventory-list resource-list resource-list--compact">
      ${n.map(e=>`
        <li class="modifier-card attack-card resource-card inventory-item-card">
          <div class="attack-card__body resource-card__body">
            <div class="resource-card__title item-info">
              ${e.image_url?`<img class="item-avatar" src="${e.image_url}" alt="Foto di ${e.name}" />`:""}
              <div>
                <strong class="attack-card__name">${e.name}</strong>
                <p class="muted resource-card__description">
                  ${To(e.category)}  ${e.qty}x  ${e.weight??0} lb
                </p>
                <div class="tag-row resource-card__meta">
                  ${e.equipable?`<span class="chip">equipaggiabile${sr(e).length?`  ${Ao(sr(e))}`:""}</span>`:""}
                  ${e.sovrapponibile?'<span class="chip">sovrapponibile</span>':""}
                  ${e.attunement_active?'<span class="chip">attuned</span>':""}
                </div>
              </div>
            </div>
          </div>
          <div class="resource-card-actions">
            ${e.category==="consumable"?`<button class="resource-action-button" data-use="${e.id}">Usa</button>`:""}
            <button class="resource-action-button" data-edit="${e.id}">Modifica</button>
            <button class="resource-action-button" data-delete="${e.id}">Elimina</button>
          </div>
        </li>
      `).join("")}
    </ul>
  `:'<p class="muted eyebrow">Nessun oggetto.</p>'}function vh(n){return n.length?`
    <ul class="inventory-list resource-list resource-list--compact">
      ${n.map(e=>`
        <li class="modifier-card attack-card resource-card inventory-item-card">
          <div class="attack-card__body resource-card__body">
            <div class="resource-card__title item-info">
              ${e.image_url?`<img class="item-avatar" src="${e.image_url}" alt="Foto di ${e.name}" />`:""}
              <div>
                <strong class="attack-card__name">${e.name}</strong>
                <p class="muted resource-card__description">
                  ${To(e.category)}  ${Ao(sr(e))}
                </p>
                <div class="tag-row resource-card__meta">
                  ${e.attunement_active?'<span class="chip">attuned</span>':""}
                </div>
              </div>
            </div>
          </div>
          <div class="resource-card-actions">
            <button class="resource-action-button" data-unequip="${e.id}">Rimuovi</button>
            <button class="resource-action-button" data-attune="${e.id}">
              ${e.attunement_active?"Disattiva attune":"Attiva attune"}
            </button>
          </div>
        </li>
      `).join("")}
    </ul>
  `:""}function yh(){return`
    <div class="money-grid compact-grid-fields">
      <label class="field">
        <span>Quantit</span>
        <input name="amount" type="number" value="0" min="0" />
      </label>
      <label class="field">
        <span>Tipo moneta</span>
        <select name="coin">
          <option value="pp">Platino (PP)</option>
          <option value="gp">Oro (GP)</option>
          <option value="sp">Argento (SP)</option>
          <option value="cp">Rame (CP)</option>
        </select>
      </label>
    </div>
    <label class="field">
      <span>Motivo</span>
      <input name="reason" placeholder="Motivo" />
    </label>
    <label class="field">
      <span>Data</span>
      <input name="occurred_on" type="date" value="${new Date().toISOString().split("T")[0]}" />
    </label>
  `}function bh(n){return`
    <div class="compact-field-grid">
      <label class="field">
        <span>Nome</span>
        <input name="name" required />
      </label>
      <label class="field">
        <span>Quantit</span>
        <input name="qty" type="number" value="1" />
      </label>
      <label class="field">
        <span>Peso</span>
        <input name="weight" type="number" value="0" min="0" step="${n}" />
      </label>
      <label class="field">
        <span>Valore (cp)</span>
        <input name="value_cp" type="number" value="0" />
      </label>
    </div>
  `}async function mn(n){const e=kt(),t=e.characters.find(O=>O.id===e.activeCharacterId);if(!t){n.innerHTML='<section class="card"><p>Nessun personaggio selezionato.</p></section>';return}let r=e.cache.items,i=e.cache.wallet,o=[];if(!e.offline){try{r=await po(t.id),jt("items",r),await Kt({items:r})}catch{le("Errore caricamento inventario","error")}try{i=await Xd(t.id),jt("wallet",i),i&&await Kt({wallet:i})}catch{le("Errore caricamento wallet","error")}try{o=await th(t.id)}catch{le("Errore caricamento transazioni","error")}}const l=Gd(r),d=xo(t),f=d==="kg"?"0.1":"1",m=r.filter(O=>sr(O).length),v=r.filter(O=>O.attunement_active).length;n.innerHTML=`
    <div class="inventory-layout">
      <section class="card inventory-wallet-wide">
        <header class="card-header">
          <h2 class="eyebrow">Monete</h2>
        </header>
        ${nh(i)}
      </section>
      <section class="card inventory-main">
        <header class="card-header">
          <h2 class="eyebrow">Inventario</h2>
          <div class="button-row">
            <button class="primary" type="button" data-add-loot>Loot rapido</button>
            <button class="primary" data-add-item>Nuovo oggetto</button>
          </div>
        </header>
        <div class="filters">
          <input type="search" placeholder="Cerca" data-search />
          <select data-category></select>
          <select data-equipable></select>
        </div>
        <div class="carry-widget">
          <span>Carico totale</span>
          <strong>${Yd(l,d)}</strong>
        </div>
        <div data-inventory-list></div>
      </section>
      <div class="inventory-side">
        <section class="card">
          <header class="card-header">
            <h2 class="eyebrow">Equipaggiamento</h2>
            <span class="pill">Slot Sintonia Attivi: ${v}</span>
          </header>
          ${vh(m)}
          ${m.length?"":'<p class="muted">Nessun oggetto equipaggiato.</p>'}
        </section>
        <section class="card">
          <header class="card-header">
            <h2 class="eyebrow">Transazioni</h2>
          </header>
          <div class="button-row">
            <button class="primary" type="button" data-money-action="pay">Paga</button>
            <button class="primary" type="button" data-money-action="receive">Ricevi</button>
          </div>
          <div class="inventory-transactions">
            ${e.offline?'<p class="muted">Transazioni disponibili solo online.</p>':mh(o).outerHTML}
          </div>
        </section>
      </div>
    </div>
  `;const y=n.querySelector("[data-inventory-list]"),_=n.querySelector("[data-search]"),C=n.querySelector("[data-category]"),w=n.querySelector("[data-equipable]");rh.forEach(O=>{const U=document.createElement("option");U.value=O.value,U.textContent=O.equipable?`${O.label}  equipaggiabile`:O.label,C.appendChild(U)}),[{value:"",label:"Tutti"},{value:"equipable",label:"Equipaggiabili"},{value:"non-equipable",label:"Non equipaggiabili"}].forEach(O=>{const U=document.createElement("option");U.value=O.value,U.textContent=O.label,w.appendChild(U)});function N(){const O=_.value.toLowerCase(),U=C.value,D=w.value,B=r.filter(K=>{const M=K.name.toLowerCase().includes(O),L=!U||K.category===U,te=!D||D==="equipable"&&K.equipable||D==="non-equipable"&&!K.equipable;return M&&L&&te});y.innerHTML=gh(B),y.querySelectorAll("[data-edit]").forEach(K=>K.addEventListener("click",()=>{const M=r.find(L=>L.id===K.dataset.edit);M&&js(t,M,r,mn.bind(null,n))})),y.querySelectorAll("[data-delete]").forEach(K=>K.addEventListener("click",async()=>{const M=r.find(te=>te.id===K.dataset.delete);if(!(!M||!await ca({message:"Eliminare oggetto?"})))try{await Gu(M.id),le("Oggetto eliminato"),mn(n)}catch{le("Errore eliminazione","error")}})),y.querySelectorAll("[data-use]").forEach(K=>K.addEventListener("click",async()=>{const M=r.find(L=>L.id===K.dataset.use);if(M){if(M.qty<=0){le("Quantit esaurita","error");return}try{const L=Math.max(M.qty-1,0);await Zr(M.id,{qty:L}),le("Consumabile usato"),mn(n)}catch{le("Errore utilizzo consumabile","error")}}}))}N(),_.addEventListener("input",N),C.addEventListener("change",N),w.addEventListener("change",N),n.querySelectorAll("[data-unequip]").forEach(O=>O.addEventListener("click",async()=>{const U=r.find(D=>D.id===O.dataset.unequip);if(U)try{await Zr(U.id,{equip_slot:null,equip_slots:[]}),le("Equip rimosso"),mn(n)}catch{le("Errore aggiornamento","error")}})),n.querySelectorAll("[data-attune]").forEach(O=>O.addEventListener("click",async()=>{const U=r.find(D=>D.id===O.dataset.attune);if(U)try{await Zr(U.id,{attunement_active:!U.attunement_active}),le("Sintonia aggiornata"),mn(n)}catch{le("Errore attunement","error")}})),n.querySelectorAll("[data-money-action]").forEach(O=>O.addEventListener("click",async()=>{const U=O.dataset.moneyAction,K=await cn({title:U==="pay"?"Paga monete":"Ricevi monete",submitLabel:U==="pay"?"Paga":"Ricevi",content:yh()});if(!K)return;i||(i={user_id:t.user_id,character_id:t.id,cp:0,sp:0,gp:0,pp:0});const M=K.get("coin"),L=Number(K.get("amount")||0),te={cp:M==="cp"?L:0,sp:M==="sp"?L:0,gp:M==="gp"?L:0,pp:M==="pp"?L:0},ne=U==="pay"?-1:1,we=Object.fromEntries(Object.entries(te).map(([he,ge])=>[he,ge*ne])),me=Jd(i,we);try{const he=await Zd({...me,user_id:i.user_id,character_id:i.character_id});await eh({user_id:i.user_id,character_id:i.character_id,direction:U,amount:we,reason:K.get("reason"),occurred_on:K.get("occurred_on")}),jt("wallet",he),await Kt({wallet:he}),le("Wallet aggiornato"),mn(n)}catch{le("Errore aggiornamento denaro","error")}}));const I=n.querySelector("[data-add-loot]");I&&I.addEventListener("click",async()=>{const O=await cn({title:"Aggiungi loot",submitLabel:"Aggiungi",content:bh(f)});if(O)try{await mo({user_id:t.user_id,character_id:t.id,name:O.get("name"),qty:Number(O.get("qty")),weight:Number(O.get("weight")),value_cp:Number(O.get("value_cp")),category:"loot",equipable:!1,equip_slot:null,equip_slots:[],sovrapponibile:!1}),le("Loot aggiunto"),mn(n)}catch{le("Errore loot","error")}}),n.querySelector("[data-add-item]").addEventListener("click",()=>{js(t,null,r,mn.bind(null,n))})}async function _h(n){const{data:e,error:t}=await Ie.from("journal_entries").select("*").eq("character_id",n).order("entry_date",{ascending:!1});if(t)throw t;return e??[]}async function wh(n){const{data:e,error:t}=await Ie.from("journal_tags").select("*").eq("user_id",n).order("name");if(t)throw t;return e??[]}async function kh(n){if(!n.length)return[];const{data:e,error:t}=await Ie.from("journal_entry_tags").select("*").in("entry_id",n);if(t)throw t;return e??[]}async function Sh(n){const{data:e,error:t}=await Ie.from("journal_entries").insert(n).select("*").single();if(t)throw t;return e}async function Eh(n,e){const{data:t,error:r}=await Ie.from("journal_entries").update(e).eq("id",n).select("*").single();if(r)throw r;return t}async function Ch(n){const{error:e}=await Ie.from("journal_entries").delete().eq("id",n);if(e)throw e}async function Th(n){const{data:e,error:t}=await Ie.from("journal_tags").insert(n).select("*").single();if(t)throw t;return e}async function qs(n,e){const{error:t}=await Ie.from("journal_entry_tags").insert({entry_id:n,tag_id:e});if(t)throw t}async function Ah(n,e){const{error:t}=await Ie.from("journal_entry_tags").delete().eq("entry_id",n).eq("tag_id",e);if(t)throw t}async function Oo(n){const e=kt(),t=e.characters.find(w=>w.id===e.activeCharacterId);if(!t){n.innerHTML='<section class="card"><p>Nessun personaggio selezionato.</p></section>';return}let r=e.cache.journal,i=e.cache.tags,o=[];if(!e.offline)try{r=await _h(t.id),i=await wh(t.user_id),o=await kh(r.map(w=>w.id)),jt("journal",r),jt("tags",i),await Kt({journal:r,tags:i,entryTags:o})}catch{le("Errore caricamento diario","error")}const l=new Map(i.map(w=>[w.id,w])),d=o.reduce((w,N)=>(w[N.entry_id]||(w[N.entry_id]=[]),w[N.entry_id].push(N.tag_id),w),{}),f=r.filter(w=>w.is_pinned),m=r.filter(w=>!w.is_pinned);n.innerHTML=`
    <section class="card">
      <header class="card-header">
        <h2>Diario</h2>
        <button class="primary" data-add-entry>Nuova voce</button>
      </header>
      <div class="filters">
        <input type="search" placeholder="Cerca" data-search />
        <button data-add-tag class="ghost-button">Nuovo tag</button>
      </div>
      <div data-journal-list></div>
    </section>
  `;const v=n.querySelector("[data-journal-list]"),y=n.querySelector("[data-search]");function _(){const w=y.value.toLowerCase(),N=Ds(f,w),I=Ds(m,w);v.innerHTML=[N.length?"<h3>In evidenza</h3>"+Bs(N,d,l):"",I.length?"<h3>Voci</h3>"+Bs(I,d,l):'<p class="muted">Nessuna voce.</p>'].join(""),v.querySelectorAll("[data-edit]").forEach(O=>O.addEventListener("click",()=>{const U=r.find(D=>D.id===O.dataset.edit);U&&Ms(t,U,i,d[U.id]??[],C)})),v.querySelectorAll("[data-delete]").forEach(O=>O.addEventListener("click",async()=>{const U=r.find(B=>B.id===O.dataset.delete);if(!(!U||!await ca({message:"Eliminare voce?"})))try{await Ch(U.id),le("Voce eliminata"),C()}catch{le("Errore eliminazione","error")}}))}async function C(){await Oo(n)}_(),y.addEventListener("input",_),n.querySelector("[data-add-entry]").addEventListener("click",()=>{Ms(t,null,i,[],C)}),n.querySelector("[data-add-tag]").addEventListener("click",()=>{xh(t,C)})}function Ds(n,e){return e?n.filter(t=>{var r,i;return((r=t.title)==null?void 0:r.toLowerCase().includes(e))||((i=t.content)==null?void 0:i.toLowerCase().includes(e))}):n}function Bs(n,e,t){return`
    <ul class="journal-list">
      ${n.map(r=>{const i=e[r.id]??[];return`
          <li>
            <div>
              <strong>${r.title||"Senza titolo"}</strong>
              <p class="muted">${r.entry_date||""}  Sessione ${r.session_no??"-"}</p>
              <div class="tag-row">
                ${i.map(o=>{var l;return`<span class="chip">${((l=t.get(o))==null?void 0:l.name)??""}</span>`}).join("")}
              </div>
            </div>
            <div class="actions">
              <button data-edit="${r.id}">Modifica</button>
              <button data-delete="${r.id}">Elimina</button>
            </div>
          </li>
        `}).join("")}
    </ul>
  `}function Ms(n,e,t,r,i){const o=document.createElement("form");o.className="drawer-form",o.appendChild(ie({label:"Titolo",name:"title",value:(e==null?void 0:e.title)??""})),o.appendChild(ie({label:"Data",name:"entry_date",type:"date",value:(e==null?void 0:e.entry_date)??new Date().toISOString().split("T")[0]})),o.appendChild(ie({label:"Sessione",name:"session_no",type:"number",value:(e==null?void 0:e.session_no)??""})),o.appendChild(vn({label:"Contenuto",name:"content",value:(e==null?void 0:e.content)??""}));const l=document.createElement("label");l.className="checkbox",l.innerHTML='<input type="checkbox" name="is_pinned" /> <span>In evidenza</span>',o.appendChild(l);const d=document.createElement("div");d.className="tag-selector",d.innerHTML="<span>Tag</span>",t.forEach(m=>{const v=document.createElement("label");v.className="checkbox";const y=document.createElement("input");y.type="checkbox",y.value=m.id,r.includes(m.id)&&(y.checked=!0),v.appendChild(y),v.append(m.name),d.appendChild(v)}),o.appendChild(d);const f=document.createElement("button");f.className="primary",f.type="submit",f.textContent=e?"Salva":"Crea",o.appendChild(f),o.is_pinned.checked=(e==null?void 0:e.is_pinned)??!1,o.addEventListener("submit",async m=>{m.preventDefault();const v=new FormData(o),y={user_id:n.user_id,character_id:n.id,title:v.get("title"),entry_date:v.get("entry_date"),session_no:Number(v.get("session_no")||0),content:v.get("content"),is_pinned:v.get("is_pinned")==="on"};try{const _=e?await Eh(e.id,y):await Sh(y),C=Array.from(d.querySelectorAll('input[type="checkbox"]')).filter(w=>w.checked).map(w=>w.value);if(e){const w=C.filter(I=>!r.includes(I)),N=r.filter(I=>!C.includes(I));await Promise.all([...w.map(I=>qs(_.id,I)),...N.map(I=>Ah(_.id,I))])}else await Promise.all(C.map(w=>qs(_.id,w)));le("Voce salvata"),ta(),i()}catch{le("Errore salvataggio voce","error")}}),mi(Fs(e?"Modifica voce":"Nuova voce",o))}function xh(n,e){const t=document.createElement("form");t.className="drawer-form",t.appendChild(ie({label:"Nome tag",name:"name"}));const r=document.createElement("button");r.className="primary",r.type="submit",r.textContent="Crea",t.appendChild(r),t.addEventListener("submit",async i=>{i.preventDefault();const o=new FormData(t);try{await Th({user_id:n.user_id,name:o.get("name")}),le("Tag creato"),ta(),e()}catch{le("Errore tag","error")}}),mi(Fs("Nuovo tag",t))}const Oh="modulepreload",$h=function(n){return"/"+n},Us={},Rh=function(e,t,r){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),d=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(t.map(f=>{if(f=$h(f),f in Us)return;Us[f]=!0;const m=f.endsWith(".css"),v=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${v}`))return;const y=document.createElement("link");if(y.rel=m?"stylesheet":Oh,m||(y.as="script"),y.crossOrigin="",y.href=f,d&&y.setAttribute("nonce",d),document.head.appendChild(y),m)return new Promise((_,C)=>{y.addEventListener("load",_),y.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(l){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=l,window.dispatchEvent(d),!d.defaultPrevented)throw l}return i.then(l=>{for(const d of l||[])d.status==="rejected"&&o(d.reason);return e().catch(o)})};function Ph(n={}){const{immediate:e=!1,onNeedRefresh:t,onOfflineReady:r,onRegistered:i,onRegisteredSW:o,onRegisterError:l}=n;let d,f;const m=async(y=!0)=>{await f};async function v(){if("serviceWorker"in navigator){if(d=await Rh(async()=>{const{Workbox:y}=await import("./workbox-window.prod.es5-vqzQaGvo.js");return{Workbox:y}},[]).then(({Workbox:y})=>new y("/sw.js",{scope:"/",type:"classic"})).catch(y=>{l==null||l(y)}),!d)return;d.addEventListener("activated",y=>{(y.isUpdate||y.isExternal)&&window.location.reload()}),d.addEventListener("installed",y=>{y.isUpdate||r==null||r()}),d.register({immediate:e}).then(y=>{o?o("/sw.js",y):i==null||i(y)}).catch(y=>{l==null||l(y)})}}return f=v(),m}const Nh=document.querySelector("#app");el(Nh);document.addEventListener("click",async n=>{n.target.closest("[data-logout]")&&(n.preventDefault(),await Fu())});Cr("login",Ku);Cr("home",Ct);Cr("characters",Eo);Cr("inventory",mn);Cr("journal",Oo);Xo(()=>{nl(),zs()});window.addEventListener("online",()=>zt({offline:!1}));window.addEventListener("offline",()=>zt({offline:!0}));zt({offline:!navigator.onLine});const Ih=async()=>{await Uu();const{user:n}=kt();n&&await lo(n),zs(),await Qu(),sl()};Ph({immediate:!0});Ih();
